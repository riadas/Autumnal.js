<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Causal Discovery App</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.55.0/mode/erlang/erlang.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/selection/active-line.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.32.0/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.55.0/theme/erlang-dark.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.56.0/addon/scroll/simplescrollbars.min.css" />

    <!-- <script src="{{ url_for('static', filename='node_modules/s-expression/index.js')}}" type="module"></script> -->

    <style>

      .CodeMirror {
        height: 100% !important;
      }

      body {
        font-family: 'Helvetica Light', 'Lato', sans-serif;
        margin: 0;
        height: 100%;
      }

      html {
        height: 100%;
        overflow: hidden;
      }
      
      #content-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        justify-content: flex-start;
      }

      #header {
        height: 55px;
        align-items: center;
        border: none;
        display: flex;
        padding-left: 23px;
        color: white;
        background-color: black;
      }

      ::placeholder {
        color: black;
        opacity: 1;
      }

      #title {
        font-size: 30px;
        color: #ff9400;
      }

      #playground {
        font-size: 15px;
        color: deepskyblue;
        margin: 0 25px;
        padding-top: 5px;
      }

      #challenges {
        font-size: 15px;
        padding-top: 5px;
      }

      .active {
        color: deepskyblue
      }

      #dashboard {
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: 100%;
      }

      .dashboard-panel {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        width: 50%;
        height: 100%;
        background-color: white;        
        font-size: 18px;
      }
      
      #container {
        height: 100%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .grid-container {
        display: inline-block;
        width: fit-content;
        height: fit-content;
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-gap: 0;
        border: 0.5px solid black;
        width: fit-content;
      }
      .cell {
        /* center the cell content */
        justify-content: center;
        align-content: stretch;
        align-items: center;
        display: flex;
        font-family: Arial;
        font-weight: bold;
        background-color: transparent;
        border: 0.5px solid black;
        margin: 0;
        color: transparent;
        padding: 0px;
      }

      .cell input {
        height: 25px;
        width: 25px;
        background-color: transparent;
        border: 1px solid black;
        color: #ffffff00;
      }

      form {
        margin-top: 20px;
      }

      .control-button {
        padding: 5px 20px;
        width: fit-content;
        border: none;
        border-radius: 2px;
        background-color: #3fd250;
        cursor: pointer;
        margin-right: 10px;
        font-weight:bold; 
        margin-top: 10px;
      }

      .example-button {
        background-color: #f7e67a !important;
        color: transparent;
      }

      .history-mode {
        background-color: #FB8C00 !important;
      }

      .disabled {
        pointer-events: none;
        opacity: 0.6;
        outline: none;
      }

      button:focus {
        outline: 0;
      }

      input:focus {
        outline: 0;
      }

      datalist {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        writing-mode: vertical-lr;
        width: 90px;
      }

      option {
        padding: 0;
      }

      #header2 {
        height: 55px;
        align-items: center;
        border: none;
        display: flex;
        padding-left: 8px;
        color: white;
        background-color: black;
        width: 100%;
        font-family: 'Helvetica Light', 'Lato', sans-serif;
      }

      #cisc-link {
        color: deepskyblue;
        font-size: 15px;
        margin: 0 25px;
        padding-top: 5px;
      }

      #empa-link {
        font-size: 15px;
        padding-top: 5px;
        padding-right: 25px;
      }

      #atari-link {
        font-size: 15px;
        padding-top: 5px;
      }

      a {
          color: #FFFFFF;
          text-decoration: none;
      }

      .global-header.active {
        color: deepskyblue;
      }

    </style>
  </head>
  <body>
    <div id="content-wrapper">
      <!-- style="display: none;" -->
      <div id="header2">
          <span id="title">üçÇ autumnal</span> <a class="global-header" href="cisc.html" id="cisc-link">cisc</a> <a class="global-header" href="empa.html" id="empa-link">empa</a> <a class="global-header" href="atari.html" id="atari-link">atari</a>
        </div>  
      <div id="dashboard">
        <div id="model-input" class="dashboard-panel" style="border-right: 3px solid black;">
          <form style="width: 100%; margin: 0; font-size: 13px !important; height: 100%;">
          <textarea id="autumn-string" name="autumnstring" rows="30" cols="50"
          style="height: 97%; width: 100%;" spellcheck="false">
          </textarea>
          </form> 
        </div>
         
        <div id="grid-view" class="dashboard-panel" style="border-left: 3px solid black;">
          <div id="button-div" style="display: flex; flex-wrap: wrap; height: fit-content; margin-left: 10px;">
            <button id="compile-button" class="control-button"></button>
            <button id="particles-button" class="control-button example-button">PARTICLES</button>
            <button id="ants-button" class="control-button example-button">ANTS</button>
            <button id="light-button" class="control-button example-button">LIGHTS</button>
            <button id="magnets-button" class="control-button example-button">MAGNETS</button>
            <button id="plug-button" class="control-button example-button">WATER PLUG</button>
            <button id="ice-button" class="control-button example-button">ICE</button>
            <button id="tetris-button" style="display: none" class="control-button">TETRIS</button>
            <button id="hatch-button" style="display: none" class="control-button">HATCH</button>
            <button id="snake-button" class="control-button example-button">SNAKE</button>
            <button id="snake4-button" class="control-button example-button">SNAKE 4</button>
            <button id="magnets-button-2" style="display: none" class="control-button">MAGNETS II</button>
            <button id="magnets-button-3" style="display: none" class="control-button">MAGNETS III</button>
            <button id="lock-button" style="display: none" class="control-button">LOCK</button>
            <button id="bbq-button" style="display: none" class="control-button">BBQ</button>
            <button id="bottle-button" style="display: none" class="control-button">BOTTLE</button>
            <button id="disease-button" class="control-button example-button">DISEASE</button>
            <button id="balls-button-1" style="display: none" class="control-button">BALLS I</button>
            <button id="balls-button-2" style="display: none" class="control-button">BALLS II</button>
            <button id="space-button" class="control-button example-button">SPACE INVADERS</button>
            <button id="gol-button" style="display: none" class="control-button">GoL</button>
            <button id="sokoban-button" class="control-button example-button">SOKOBAN</button>
            <button id="sokoban-button-2" style="display: none" class="control-button">SOKOBAN II</button>
            <button id="grow-button" class="control-button example-button">GROW</button>
            <button id="mario-button" class="control-button example-button">MARIO</button>
            <button id="sand-button" class="control-button example-button">SAND</button>
            <button id="gravity-button" class="control-button example-button">GRAVITY</button>
            <button id="gravity-button-2" class="control-button example-button">GRAVITY II</button>
            <button id="gravity-button-3" class="control-button example-button">GRAVITY III</button>
            <button id="gravity-button-4" class="control-button example-button">GRAVITY IV</button>
            <button id="charge-button" style="display: none" class="control-button">CHARGE</button>
            <button id="egg-button" class="control-button example-button">EGG</button>
            <button id="balloon-button" style="display: none" class="control-button">BALLOON</button>
            <button id="wind-button" class="control-button example-button">WIND</button>
            <button id="paint-button" class="control-button example-button">PAINT</button>
            <button id="chase-button" class="control-button example-button">CHASE</button>
            <button id="coins-button" class="control-button example-button">COINS</button>
            
            <button id="count-button-1" class="control-button example-button">COUNT I</button>
            <button id="count-button-2" class="control-button example-button">COUNT II</button>
            <button id="count-button-3" class="control-button example-button">COUNT III </button>
            <button id="count-button-4" class="control-button example-button">COUNT IV</button>
            <button id="count-button-5" class="control-button example-button">COUNT V</button>
    
            <button id="arc-slack-button" style="display: none" class="control-button">ARC SLACK</button>
            <button id="rink-button" class="control-button example-button">ICE RINK</button>
            <button id="double-count-button" class="control-button example-button">DOUBLE COUNT I</button>
            <button id="double-count-2-button" class="control-button example-button">DOUBLE COUNT II</button>
            <button id="swap-button" style="display: none" class="control-button">SWAP</button>
            <button id="disease-2-button" style="display: none" class="control-button">DISEASE II</button>
            <button id="jump-button" class="control-button example-button">JUMP</button>
            <button id="bullets-button" class="control-button example-button">BULLETS</button>
            <button id="levels-button" class="control-button example-button">LEVELS</button>

            <button id="foraging-button" class="control-button example-button">FORAGE</button>
            <button id="spider-button" class="control-button example-button">SPIDER</button>
            <button id="river-1-button" class="control-button example-button">RIVER I</button>
            <button id="river-2-button" class="control-button example-button">RIVER II</button>
            <button id="pong-button" class="control-button example-button">PONG</button>

            <button id="random-button" style="display: none" style="background-color: orange !important" class="control-button">RANDOM SCENE</button>
            <button id="random-button-2" style="display: none; background-color: orange !important" class="control-button">RANDOM PROGRAM</button>
            <button id="random-button-3" style="display: none; background-color: orange !important" class="control-button">RANDOM GROUPED PROGRAM</button>
            <button id="toggle-labels-button" class="control-button">TOGGLE LABELS</button>
            <button id="synthesize-button" style="display: none" style="background-color: #69e8e8 !important;" class="control-button example-button disabled">SYNTHESIZE</button>
          </div>
          <div id="container">
            <div class="grid-container" >
              <div class="grid" style="grid-template-columns: repeat(16, 25px); grid-template-rows: repeat(16, 25px);">
                {% for i in range(256) %}
                  <button class="cell" id="{{i}}" type="submit"></button>
                {% endfor %}
              </div>
              <div style="display: flex; margin-top: 10px;">
                  <button id="play-button" class="control-button" type="submit" id="run" style="margin-right: 10px;">‚ñ∂</button>
                  <button id="restart-button" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;">‚Üª</button>
                  <button id="slider-button" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;"><input id="slider" style="width: 60px;" id="pi_input" type="range" min="50" max="300" step="50" value="50"/> </button>
                
                  
                  <button id="save-button" style="display: none" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;"><i class="fa fa-floppy-o" aria-hidden="true"></i></button>
                  <button id="history-button" style="display: none" class="control-button" type="submit" style="font-size: 15px; font-weight: bold;"><i class="fa fa-history" aria-hidden="true"></i></button>
                  <button id="toggle2-button" class="control-button">TOGX</button>
                  <button id="toggle-button" class="control-button">TOGY</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- <script src="{{ url_for('static', filename='js/sexpr.js')}}" type="module"></script>
      <script src="{{ url_for('static', filename='js/autumnstdlib.js')}}" type="module"></script>
      <script src="{{ url_for('static', filename='js/interpret.js')}}" type="module"></script>   -->

      <script>
        //const host = "http://www.logic.toys"; 
        const host = "http://localhost:3000";
        // const host = "https://840a-129-236-162-16.ngrok.io"
        // const host = "http://9a3e0fec8d4c.ngrok.io";
        document.addEventListener("DOMContentLoaded", function() {

          // /* BEGIN GAMEPAD ------------------------------------------------------------------------------------------------------------------ */

          // /*
          // * Gamepad API Test
          // * Written in 2013 by Ted Mielczarek <ted@mielczarek.org>
          // *
          // * To the extent possible under law, the author(s) have dedicated all copyright and related and neighboring rights to this software to the public domain worldwide. This software is distributed without any warranty.
          // *
          // * You should have received a copy of the CC0 Public Domain Dedication along with this software. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
          // */
          // var haveEvents = 'GamepadEvent' in window;
          // var haveWebkitEvents = 'WebKitGamepadEvent' in window;
          // var controllers = {};
          // var rAF = window.mozRequestAnimationFrame ||
          //   window.webkitRequestAnimationFrame ||
          //   window.requestAnimationFrame;

          // function connecthandler(e) {
          //   console.log("connecthandler");
          //   addgamepad(e.gamepad);
          // }
          // function addgamepad(gamepad) {
          //   console.log("addgamepad");
          //   controllers[gamepad.index] = gamepad; var d = document.createElement("div");
          //   d.setAttribute("id", "controller" + gamepad.index);
          //   var t = document.createElement("h1");
          //   t.appendChild(document.createTextNode("gamepad: " + gamepad.id));
          //   d.appendChild(t);
          //   var b = document.createElement("div");
          //   b.className = "buttons";
          //   for (var i=0; i<gamepad.buttons.length; i++) {
          //     var e = document.createElement("span");
          //     e.className = "button";
          //     //e.id = "b" + i;
          //     e.innerHTML = i;
          //     b.appendChild(e);
          //   }
          //   d.appendChild(b);
          //   var a = document.createElement("div");
          //   a.className = "axes";
          //   for (i=0; i<gamepad.axes.length; i++) {
          //     e = document.createElement("meter");
          //     e.className = "axis";
          //     //e.id = "a" + i;
          //     e.setAttribute("min", "-1");
          //     e.setAttribute("max", "1");
          //     e.setAttribute("value", "0");
          //     e.innerHTML = i;
          //     a.appendChild(e);
          //   }
          //   d.appendChild(a);
          //   // document.getElementById("start").style.display = "none";
          //   // document.body.appendChild(d);
          //   rAF(updateStatus);

          //   // setInterval(updateStatus, 1000);
          // }

          // function disconnecthandler(e) {
          //   console.log("disconnecthandler");
          //   removegamepad(e.gamepad);
          // }

          // function removegamepad(gamepad) {
          //   console.log("removegamepad");
          //   // var d = document.getElementById("controller" + gamepad.index);
          //   // document.body.removeChild(d);
          //   delete controllers[gamepad.index];
          // }

          // function updateStatus() {
          //   console.log("updateStatus");
          //   // scangamepads();
          //   for (j in controllers) {
          //     // console.log(j);
          //     var controller = controllers[j];
          //     for (var i=0; i<controller.buttons.length; i++) {
          //       var val = controller.buttons[i];
          //       // console.log(val);
          //       var pressed = val.pressed == 1.0;
          //       var touched = false;

          //       // console.log("button");
          //       // console.log(i);
          //       // console.log("pressed");
          //       // console.log(pressed);

          //       if (pressed) {
          //         console.log("button");
          //         console.log(i);
          //         console.log("val");
          //         console.log(val);
          //         console.log("pressed!")
          //       }

          //       if (typeof(val) == "object") {
          //         pressed = val.pressed;
          //         if ('touched' in val) {
          //           touched = val.touched;
          //         }
          //         val = val.value;
          //       }
          //       var pct = Math.round(val * 100) + "%";
          //     }
          //   }
          //   rAF(updateStatus);
          // }

          // function scangamepads() {
          //   console.log("scangamepads");
          //   var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
          //   for (var i = 0; i < gamepads.length; i++) {
          //     if (gamepads[i] && (gamepads[i].index in controllers)) {
          //       controllers[gamepads[i].index] = gamepads[i];
          //     }
          //   }
          // }

          // if (haveEvents) {
          //   window.addEventListener("gamepadconnected", connecthandler);
          //   window.addEventListener("gamepaddisconnected", disconnecthandler);
          // } else if (haveWebkitEvents) {
          //   window.addEventListener("webkitgamepadconnected", connecthandler);
          //   window.addEventListener("webkitgamepaddisconnected", disconnecthandler);
          // } else {
          //   setInterval(scangamepads, 500);
          // }

          // /* END GAMEPAD -------------------------------------------------------------------------------------------------------------------- */

/*
 * Gamepad API Test
 * Written in 2013 by Ted Mielczarek <ted@mielczarek.org>
 *
 * To the extent possible under law, the author(s) have dedicated all copyright and related and neighboring rights to this software to the public domain worldwide. This software is distributed without any warranty.
 *
 * You should have received a copy of the CC0 Public Domain Dedication along with this software. If not, see <http://creativecommons.org/publicdomain/zero/1.0/>.
 */
 var haveEvents = 'GamepadEvent' in window;
var haveWebkitEvents = 'WebKitGamepadEvent' in window;
var controllers = {};
var rAF = window.mozRequestAnimationFrame ||
  window.webkitRequestAnimationFrame ||
  window.requestAnimationFrame;

function connecthandler(e) {
  console.log("connectHandler");
  addgamepad(e.gamepad);
}
function addgamepad(gamepad) {
  console.log("addgamepad");
  controllers[gamepad.index] = gamepad; var d = document.createElement("div");
  d.setAttribute("id", "controller" + gamepad.index);
  var t = document.createElement("h1");
  t.appendChild(document.createTextNode("gamepad: " + gamepad.id));
  d.appendChild(t);
  var b = document.createElement("div");
  b.className = "buttons";
  for (var i=0; i<gamepad.buttons.length; i++) {
    var e = document.createElement("span");
    e.className = "button";
    //e.id = "b" + i;
    e.innerHTML = i;
    b.appendChild(e);
  }
  d.appendChild(b);
  var a = document.createElement("div");
  a.className = "axes";
  for (i=0; i<gamepad.axes.length; i++) {
    e = document.createElement("meter");
    e.className = "axis";
    //e.id = "a" + i;
    e.setAttribute("min", "-1");
    e.setAttribute("max", "1");
    e.setAttribute("value", "0");
    e.innerHTML = i;
    a.appendChild(e);
  }
  d.appendChild(a);
  // document.getElementById("start").style.display = "none";
  document.body.appendChild(d);
  rAF(updateStatus);
  // setInterval(updateStatus, 50);
}

function disconnecthandler(e) {
  console.log("disconnecthandler");
  removegamepad(e.gamepad);
}

function removegamepad(gamepad) {
  console.log("removehandler");

  // var d = document.getElementById("controller" + gamepad.index);
  document.body.removeChild(d);
  delete controllers[gamepad.index];
}

var prev_pressed = {};

function updateStatus() {
  // console.log("updateStatus");

  scangamepads();
  for (j in controllers) {
    // console.log(j);
    var controller = controllers[j];
    // var d = document.getElementById("controller" + j);
    // var buttons = d.getElementsByClassName("button");
    for (var i=0; i<controller.buttons.length; i++) {
      // var b = buttons[i];
      var val = controller.buttons[i];
      // console.log(val);
      var pressed = val == 1.0;
      var touched = false;
      if (typeof(val) == "object") {
        pressed = val.pressed;
        if ('touched' in val) {
          touched = val.touched;
        }
        val = val.value;
      }

      if (!prev_pressed.hasOwnProperty(j)) {
        prev_pressed[j] = {}
        prev_pressed[j][i] = pressed;
      } else {
        if (!pressed && prev_pressed[j][i]) {
          console.log("j: " + j.toString() + ", i: " + i.toString());
          if (j == 0) {
            if (i == 12) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'w'}));
            } else if (i == 13) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'s'}));
            } else if (i == 14) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'a'}));
            } else if (i == 15) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'d'}));
            }
          } else if (j == 1) {
            if (i == 12) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'ArrowUp'}));
            } else if (i == 13) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'ArrowDown'}));
            } else if (i == 14) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'ArrowLeft'}));
            } else if (i == 15) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'ArrowRight'}));
            }
          } else if (j == 2) {
            if (i == 12) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'t'}));
            } else if (i == 13) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'g'}));
            } else if (i == 14) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'f'}));
            } else if (i == 15) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'h'}));
            }
          } else if (j == 3) {
            if (i == 12) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'i'}));
            } else if (i == 13) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'k'}));
            } else if (i == 14) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'j'}));
            } else if (i == 15) {
              document.dispatchEvent(new KeyboardEvent('keyup',{'key':'l'}));
            }
          }
        } 
        // update prev_pressed
        prev_pressed[j][i] = pressed;
      }


      var pct = Math.round(val * 100) + "%";
      // b.style.backgroundSize = pct + " " + pct;
      // b.className = "button";
      // if (pressed) {
      //   b.className += " pressed";
      // }
      // if (touched) {
      //   b.className += " touched";
      // }
    }

    // var axes = d.getElementsByClassName("axis");
    // for (var i=0; i<controller.axes.length; i++) {
    //   var a = axes[i];
    //   a.innerHTML = i + ": " + controller.axes[i].toFixed(4);
    //   a.setAttribute("value", controller.axes[i]);
    // }
  }
  rAF(updateStatus);
}

function scangamepads() {
  var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
  for (var i = 0; i < gamepads.length; i++) {
    if (gamepads[i] && (gamepads[i].index in controllers)) {
      controllers[gamepads[i].index] = gamepads[i];
    }
  }
}

if (haveEvents) {
  window.addEventListener("gamepadconnected", connecthandler);
  window.addEventListener("gamepaddisconnected", disconnecthandler);
} else if (haveWebkitEvents) {
  window.addEventListener("webkitgamepadconnected", connecthandler);
  window.addEventListener("webkitgamepaddisconnected", disconnecthandler);
} else {
  setInterval(scangamepads, 500);
}


          // global frontend variables
          var not_run_yet = true;
          var intervalID = -1;
          var timestep = 50; // 1200000; // 300 // 5000 // 50
          var historytimestep = 300;
          var compiled = false;
          var client_id = getRandomInt(1, 10000);
          console.log("client_id: "+client_id);
          var grid_size = [16, 16];
          var cell_size = 25;
          var model_name = "";
          var saved = false;
          var history_mode = false;
          var historyIntervalID = -1;
          var history_response = '{}';
          var history_index = -1;
          var paused = false;

          var aex = null;
          var env = null;
          var curr_program_str = "";
      
          // attach event listeners to buttons
          document.getElementById("toggle-labels-button").addEventListener("click", toggleLabelsClick);

          Array.from(document.getElementsByClassName("cell")).forEach(function (cell) {
            //console.log(cell.id)
            cell.addEventListener("click", function () { click(parseInt(cell.id)); });
          })

          document.getElementById("slider").addEventListener("input", (event) => {
                                                                                        timestep = event.target.value;
                                                                                      });

          document.getElementById("play-button").addEventListener("click", playOrPauseClick);
          document.getElementById("restart-button").addEventListener("click", restartClick);
          document.getElementById("compile-button").addEventListener("click", compileClick);
          document.getElementById("particles-button").addEventListener("click", particlesClick);
          document.getElementById("ants-button").addEventListener("click", antsClick);
          document.getElementById("light-button").addEventListener("click", lightClick);
          document.getElementById("magnets-button").addEventListener("click", magnetsClick);
          document.getElementById("tetris-button").addEventListener("click", tetrisClick);
          document.getElementById("plug-button").addEventListener("click", plugClick);
          document.getElementById("ice-button").addEventListener("click", iceClick);
          document.getElementById("hatch-button").addEventListener("click", hatchClick);
          document.getElementById("snake-button").addEventListener("click", snakeClick);
          document.getElementById("snake4-button").addEventListener("click", snake4Click);
          document.getElementById("magnets-button-2").addEventListener("click", magnets2Click);
          document.getElementById("magnets-button-3").addEventListener("click", magnets3Click);
          document.getElementById("lock-button").addEventListener("click", lockClick);
          document.getElementById("bbq-button").addEventListener("click", bbqClick);
          document.getElementById("bottle-button").addEventListener("click", bottleClick);
          document.getElementById("disease-button").addEventListener("click", diseaseClick);
          document.getElementById("balls-button-1").addEventListener("click", balls1Click);
          document.getElementById("balls-button-2").addEventListener("click", balls2Click);
          document.getElementById("space-button").addEventListener("click", spaceInvadersClick);
          document.getElementById("gol-button").addEventListener("click", gameOfLifeClick);
          document.getElementById("sokoban-button").addEventListener("click", sokobanClick);
          document.getElementById("sokoban-button-2").addEventListener("click", sokobanClick2);
          document.getElementById("grow-button").addEventListener("click", growClick);
          document.getElementById("mario-button").addEventListener("click", marioClick);
          document.getElementById("sand-button").addEventListener("click", sandClick);
          document.getElementById("gravity-button").addEventListener("click", gravityClick);
          document.getElementById("gravity-button-2").addEventListener("click", gravity2Click);
          document.getElementById("gravity-button-3").addEventListener("click", gravity3Click);
          document.getElementById("gravity-button-4").addEventListener("click", gravity4Click);
          document.getElementById("charge-button").addEventListener("click", chargeClick);
          document.getElementById("egg-button").addEventListener("click", eggClick);
          document.getElementById("balloon-button").addEventListener("click", balloonClick);
          document.getElementById("wind-button").addEventListener("click", windClick);
          document.getElementById("paint-button").addEventListener("click", paintClick);
          document.getElementById("chase-button").addEventListener("click", chaseClick);
          document.getElementById("coins-button").addEventListener("click", coinsClick);
    
          document.getElementById("count-button-1").addEventListener("click", count1Click);
          document.getElementById("count-button-2").addEventListener("click", count2Click);
          document.getElementById("count-button-3").addEventListener("click", count3Click);
          document.getElementById("count-button-4").addEventListener("click", count4Click);
          document.getElementById("count-button-5").addEventListener("click", count5Click);
    
          document.getElementById("arc-slack-button").addEventListener("click", arcSlackClick);
          document.getElementById("rink-button").addEventListener("click", rinkClick);
          document.getElementById("double-count-button").addEventListener("click", doubleCountClick);
          document.getElementById("double-count-2-button").addEventListener("click", doubleCount2Click);
          document.getElementById("swap-button").addEventListener("click", swapClick);
          document.getElementById("disease-2-button").addEventListener("click", disease2Click);
          document.getElementById("jump-button").addEventListener("click", jumpClick);
          document.getElementById("bullets-button").addEventListener("click", bulletsClick);
          document.getElementById("levels-button").addEventListener("click", levelsClick);

          document.getElementById("foraging-button").addEventListener("click", foragingClick);
          document.getElementById("spider-button").addEventListener("click", spiderClick);
          document.getElementById("river-1-button").addEventListener("click", river1Click);
          document.getElementById("river-2-button").addEventListener("click", river2Click);
          document.getElementById("pong-button").addEventListener("click", pongClick);

          document.getElementById("toggle-button").addEventListener("click", toggleClick);
          document.getElementById("toggle2-button").addEventListener("click", toggle2Click);
          document.getElementById("random-button").addEventListener("click", randomClick);
          document.getElementById("random-button-2").addEventListener("click", randomClick2);
          document.getElementById("random-button-3").addEventListener("click", randomClick3);
          document.getElementById("synthesize-button").addEventListener("click", synthesizeClick);
    
    
          document.getElementById("history-button").addEventListener("click", historyClick);
          document.getElementById("save-button").addEventListener("click", saveClick);
    
          // assign button styles
          updateButtonStyles();
    
          function updateButtonStyles() {
            compileButton = document.getElementById("compile-button");
            antsButton = document.getElementById("ants-button");
            particlesButton = document.getElementById("particles-button");
            lightButton = document.getElementById("light-button");
            magnetsButton = document.getElementById("magnets-button");
            plugButton = document.getElementById("plug-button");
            iceButton = document.getElementById("ice-button");
            tetrisButton = document.getElementById("tetris-button");
            hatchButton = document.getElementById("hatch-button");
            snakeButton = document.getElementById("snake-button");
            snake4Button = document.getElementById("snake4-button");
            magnets2Button = document.getElementById("magnets-button-2");
            magnets3Button = document.getElementById("magnets-button-3");
            lockButton = document.getElementById("lock-button");
            bbqButton = document.getElementById("bbq-button");
            bottleButton = document.getElementById("bottle-button");
            diseaseButton = document.getElementById("disease-button");
            balls1Button = document.getElementById("balls-button-1");
            balls2Button = document.getElementById("balls-button-2");
            spaceButton = document.getElementById("space-button");
            golButton = document.getElementById("gol-button");
            sokobanButton = document.getElementById("sokoban-button");
            sokoban2Button = document.getElementById("sokoban-button-2");
            growButton = document.getElementById("grow-button");
            marioButton = document.getElementById("mario-button");
            sandButton = document.getElementById("sand-button");
            gravityButton = document.getElementById("gravity-button");
            gravity2Button = document.getElementById("gravity-button-2");
            gravity3Button = document.getElementById("gravity-button-3");
            gravity4Button = document.getElementById("gravity-button-4");
            chargeButton = document.getElementById("charge-button");
            eggButton = document.getElementById("egg-button");
            balloonButton = document.getElementById("balloon-button");
            windButton = document.getElementById("wind-button");
            paintButton = document.getElementById("paint-button");
            chaseButton = document.getElementById("chase-button");
            coinsButton = document.getElementById("coins-button");
            
            count1Button = document.getElementById("count-button-1");
            count2Button = document.getElementById("count-button-2");
            count3Button = document.getElementById("count-button-3");
            count4Button = document.getElementById("count-button-4");
            count5Button = document.getElementById("count-button-5");
    
            arcSlackButton = document.getElementById("arc-slack-button");
            rinkButton = document.getElementById("rink-button");
            doubleCountButton = document.getElementById("double-count-button");
            doubleCount2Button = document.getElementById("double-count-2-button");
            swapButton = document.getElementById("swap-button");
            disease2Button = document.getElementById("disease-2-button");
            jumpButton = document.getElementById("jump-button");
            bulletsButton = document.getElementById("bullets-button");
            levelsButton = document.getElementById("levels-button");

            foragingButton = document.getElementById("foraging-button");
            spiderButton = document.getElementById("spider-button");
            river1Button = document.getElementById("river-1-button");
            river2Button = document.getElementById("river-2-button");
            pongButton = document.getElementById("pong-button");

            randomButton = document.getElementById("random-button");
            randomButton2 = document.getElementById("random-button-2");
            randomButton3 = document.getElementById("random-button-3");
            synthesizeButton = document.getElementById("synthesize-button");
    
            playButton = document.getElementById("play-button");
            sliderButton = document.getElementById("slider-button");
            restartButton = document.getElementById("restart-button");
            saveButton = document.getElementById("save-button");
            historyButton = document.getElementById("history-button");
            toggleButton = document.getElementById("toggle-button");
            toggle2Button = document.getElementById("toggle2-button");

    
            if (saved) {
              saveButton.classList.add("disabled");
            } else {
              saveButton.classList.remove("disabled");
            }
    
            if (compiled) {
              compileButton.innerHTML = "RESET <i style='font-size: medium' class='fa fa-code' aria-hidden='true'></i>";
              playButton.style.display = "";
              sliderButton.style.display = "";
              restartButton.style.display = "";
              saveButton.style.display = "none";
              historyButton.style.display = "none";
    
              antsButton.classList.add("disabled");
              particlesButton.classList.add("disabled");
              lightButton.classList.add("disabled");
              magnetsButton.classList.add("disabled");
              magnets2Button.classList.add("disabled");
              magnets3Button.classList.add("disabled");
              lockButton.classList.add("disabled");
              bbqButton.classList.add("disabled");
              bottleButton.classList.add("disabled");
              diseaseButton.classList.add("disabled");
              balls1Button.classList.add("disabled");
              balls2Button.classList.add("disabled");
              spaceButton.classList.add("disabled");
              golButton.classList.add("disabled");
              sokobanButton.classList.add("disabled");
              sokoban2Button.classList.add("disabled");
              growButton.classList.add("disabled");
              marioButton.classList.add("disabled");
              sandButton.classList.add("disabled");
              gravityButton.classList.add("disabled");
              gravity2Button.classList.add("disabled");
              gravity3Button.classList.add("disabled");
              gravity4Button.classList.add("disabled");
              chargeButton.classList.add("disabled");
              eggButton.classList.add("disabled");
              balloonButton.classList.add("disabled");
              windButton.classList.add("disabled");
              paintButton.classList.add("disabled");
              chaseButton.classList.add("disabled");
              coinsButton.classList.add("disabled");
    
              count1Button.classList.add("disabled");
              count2Button.classList.add("disabled");
              count3Button.classList.add("disabled");
              count4Button.classList.add("disabled");
              count5Button.classList.add("disabled");
              
              arcSlackButton.classList.add("disabled");
              rinkButton.classList.add("disabled");
              doubleCountButton.classList.add("disabled");
              doubleCount2Button.classList.add("disabled");
              swapButton.classList.add("disabled");
              disease2Button.classList.add("disabled");
              jumpButton.classList.add("disabled");
              bulletsButton.classList.add("disabled");
              levelsButton.classList.add("disabled");

              foragingButton.classList.add("disabled");
              spiderButton.classList.add("disabled");
              river1Button.classList.add("disabled");
              river2Button.classList.add("disabled");
              pongButton.classList.add("disabled");

              plugButton.classList.add("disabled");
              iceButton.classList.add("disabled");
              tetrisButton.classList.add("disabled");
              hatchButton.classList.add("disabled");
              snakeButton.classList.add("disabled");
              snake4Button.classList.add("disabled");
              randomButton.classList.add("disabled");
              randomButton2.classList.add("disabled");
              randomButton3.classList.add("disabled");
              
              if (!history_mode) {
                playButton.classList.remove("history-mode");
                sliderButton.classList.remove("history-mode");
                restartButton.classList.remove("history-mode");
                saveButton.classList.remove("history-mode");
                historyButton.classList.remove("history-mode");
                compileButton.classList.remove("history-mode");
                toggleButton.classList.remove("history-mode");
                toggle2Button.classList.remove("history-mode");

    
                playButton.classList.remove("disabled");
                if (intervalID == -1) {
                  compileButton.classList.remove("disabled");
                  synthesizeButton.classList.remove("disabled");
                  playButton.innerText = "‚ñ∂";
                  playButton.style.fontSize = "13px";
                  sliderButton.classList.remove("disabled");
                  if (not_run_yet) {
                    restartButton.classList.add("disabled");
                    saveButton.classList.add("disabled");
                    historyButton.classList.add("disabled");
                  } else {
                    restartButton.classList.remove("disabled");
                    saveButton.classList.remove("disabled");
                    historyButton.classList.remove("disabled");
                  }
                } else {
                  compileButton.classList.add("disabled");
                  synthesizeButton.classList.add("disabled");
                  playButton.innerText = "‚ñå‚ñå";
                  playButton.style.fontSize = "9px";
                  sliderButton.classList.add("disabled");
                  restartButton.classList.add("disabled");
                  saveButton.classList.add("disabled");
                  historyButton.classList.add("disabled");
                }
              } else {
                playButton.classList.add("history-mode");
                sliderButton.classList.add("history-mode");
                restartButton.classList.add("history-mode");
                saveButton.classList.add("history-mode");
                historyButton.classList.add("history-mode");
                compileButton.classList.add("history-mode");
                toggleButton.classList.remove("history-mode");
                toggle2Button.classList.remove("history-mode");

    
                if (historyIntervalID == -1) {
                  console.log("updateButtonStyles historyIntervalID == -1");
                  if (history_index < Object.keys(JSON.parse(history_response)).length) {
                    console.log("here 1");
                    playButton.classList.remove("disabled");
                  } else {
                    console.log("here 2");
                    playButton.classList.add("disabled");
                  }
                  playButton.innerText = "‚ñ∂";
                  playButton.style.fontSize = "13px";
                  restartButton.classList.remove("disabled");
                  saveButton.classList.remove("disabled");
                  historyButton.classList.remove("disabled");
                  compileButton.classList.remove("disabled");
                } else {
                  playButton.innerText = "‚ñå‚ñå";
                  playButton.style.fontSize = "9px";
                  playButton.classList.remove("disabled");
                  restartButton.classList.add("disabled");
                  saveButton.classList.add("disabled");
                  historyButton.classList.add("disabled");
                  compileButton.classList.add("disabled");
                }
              }
            } else {
              compileButton.classList.remove("history-mode")
              compileButton.innerHTML = "COMPILE <i style='font-size: medium' class='fa fa-code' aria-hidden='true'></i>"; // 
              playButton.style.display = "none";
              sliderButton.style.display = "none";
              restartButton.style.display = "none";
              saveButton.style.display = "none";
              historyButton.style.display = "none";
    
              antsButton.classList.remove("disabled");
              particlesButton.classList.remove("disabled");
              lightButton.classList.remove("disabled");
              magnetsButton.classList.remove("disabled"); 
              magnets2Button.classList.remove("disabled");
              magnets3Button.classList.remove("disabled");
              lockButton.classList.remove("disabled");
              bbqButton.classList.remove("disabled");
              bottleButton.classList.remove("disabled");
              diseaseButton.classList.remove("disabled");
              balls1Button.classList.remove("disabled");
              balls2Button.classList.remove("disabled");
              spaceButton.classList.remove("disabled");
              golButton.classList.remove("disabled");
              sokobanButton.classList.remove("disabled");
              sokoban2Button.classList.remove("disabled");
              growButton.classList.remove("disabled");
              marioButton.classList.remove("disabled");
              sandButton.classList.remove("disabled");
              gravityButton.classList.remove("disabled");
              gravity2Button.classList.remove("disabled");
              gravity3Button.classList.remove("disabled");
              gravity4Button.classList.remove("disabled");
              chargeButton.classList.remove("disabled");
              eggButton.classList.remove("disabled");
              balloonButton.classList.remove("disabled");
              windButton.classList.remove("disabled");
              paintButton.classList.remove("disabled");
              chaseButton.classList.remove("disabled");
              coinsButton.classList.remove("disabled");
    
              count1Button.classList.remove("disabled");
              count2Button.classList.remove("disabled");
              count3Button.classList.remove("disabled");
              count4Button.classList.remove("disabled");
              count5Button.classList.remove("disabled");
    
              arcSlackButton.classList.remove("disabled");
              rinkButton.classList.remove("disabled");
              doubleCountButton.classList.remove("disabled");
              doubleCount2Button.classList.remove("disabled");
              swapButton.classList.remove("disabled");
              disease2Button.classList.remove("disabled");
              jumpButton.classList.remove("disabled");
              bulletsButton.classList.remove("disabled");
              levelsButton.classList.remove("disabled");

              foragingButton.classList.remove("disabled");
              spiderButton.classList.remove("disabled");
              river1Button.classList.remove("disabled");
              river2Button.classList.remove("disabled");
              pongButton.classList.remove("disabled");

              tetrisButton.classList.remove("disabled");
              hatchButton.classList.remove("disabled");
              snakeButton.classList.remove("disabled");
              snake4Button.classList.remove("disabled");
              plugButton.classList.remove("disabled");
              iceButton.classList.remove("disabled");
              randomButton.classList.remove("disabled");
              randomButton2.classList.remove("disabled");
              randomButton3.classList.remove("disabled");
              synthesizeButton.classList.add("disabled");
            }
          }
    
          function updateCellStyles(xml_response) { 
            // console.log("updateCellStyles")
            // console.log(xml_response);
            xml_json = JSON.parse(xml_response);
            Array.from(document.getElementsByClassName("cell")).forEach(function (cell) { 
              cell.style.background = xml_json[0] == "#ffffff00" ? xml_json[0] : "linear-gradient(45deg, "+colorToRGBA(xml_json[0], 0.6)+", "+colorToRGBA(xml_json[0], 0.6)+")"
            })
            xml_json[1].forEach(function (particle) {
              // console.log("particle");
              // console.log(particle);
              if ((Math.round(particle[1]) < grid_size[1] && Math.round(particle[1]) >= 0) && (Math.round(particle[0]) < grid_size[0] && Math.round(particle[0]) >= 0)) {
                cell = document.getElementById((Math.round(particle[1])*grid_size[0] + Math.round(particle[0])).toString())
                // console.log("cell");
                // console.log(cell);
                cell.style.background = cell.style.background != "linear-gradient(45deg, "+colorToRGBA(xml_json[0], 0.6)+", "+colorToRGBA(xml_json[0], 0.6)+")" ? 
                ["linear-gradient(45deg, "+colorToRGBA(particle[2], 0.6)+", "+colorToRGBA(particle[2], 0.6)+")", cell.style.background].join(", ") : "linear-gradient(45deg, "+colorToRGBA(particle[2], 0.6)+", "+colorToRGBA(particle[2], 0.6)+")";
                // console.log(cell.style.background);
              }
            })
          } 
        
          var labeled_names = ['PARTICLES', 'ANTS', 'LIGHTS', 'MAGNETS', 'WATER PLUG', 'ICE', 'SNAKE', 'SNAKE 4', 'DISEASE', 'SPACE INVADERS', 'SOKOBAN', 'GROW', 'MARIO', 'SAND', 'GRAVITY', 'GRAVITY II', 'GRAVITY III', 'GRAVITY IV', 'EGG', 'WIND', 'PAINT', 'CHASE', 'COINS', 'COUNT I', 'COUNT II', 'COUNT III', 'COUNT IV', 'COUNT V', 'ICE RINK', 'DOUBLE COUNT I', 'DOUBLE COUNT II', 'JUMP', 'BULLETS', 'LEVELS', 'FORAGING', 'SPIDER', 'RIVER I', 'RIVER II', 'PONG'];
          var numbered_names = [...Array(document.getElementsByClassName("example-button").length).keys()].map(x => (x + 1).toString());
          index = 0;
          Array.from(document.getElementsByClassName("example-button")).forEach(function (button) {
            //// console.log(cell.id)
            button.style.width = button.offsetWidth;
            button.style.color = "black";
            // console.log("yo");
            // console.log(button.style.width);
            // console.log(button.innerText);
            button.innerText = numbered_names[index]; 
            index++;
          });
          
          function toggleLabelsClick() {
            current_names = []
            Array.from(document.getElementsByClassName("example-button")).forEach(function (button) {
              //// console.log(cell.id)
              current_names.push(button.innerText);
            })
    
            // console.log("current_names");
            // console.log(current_names);
    
            if (current_names[0] == "1") {
              Array.from(document.getElementsByClassName("example-button")).forEach(function (button) {
                button.innerText = labeled_names[parseInt(button.innerText) - 1];
                button.style.width = "fit-content";
              });
            } else {
              labeled_names = current_names;
              index = 0;
              Array.from(document.getElementsByClassName("example-button")).forEach(function (button) {
                //// console.log(cell.id)
                button.style.width = button.offsetWidth;
                // console.log("yo");
                // console.log(button.style.width);
                // console.log(button.innerText);
                button.innerText = numbered_names[index]; 
                index++;
              });
    
            }
    
          }
          
          function compileClick() {
            history_mode = false;  
            saved = false;


            x = parseau("(program (= GRID_SIZE 5))") // test_ants_actual();
            console.log(x);
            // console.log("compileClick")
            // // console.log("content: "+content);
            if (compiled) {
              compiled = false;
              not_run_yet = true;

              aex = null;
              env = null;

              cell_size = 25;
              
              myCodeMirror.setOption("readOnly", false);
              // particlesClick();
              // reset grid
              grid_size = [16, 16]
              Array.from(document.getElementsByClassName("grid")).forEach(function (grid) {
                grid.innerHTML = "";
                grid.style = "grid-template-columns: repeat("+grid_size[0]+", 25px); grid-template-rows: repeat("+grid_size[1]+", 25px);"
                for (i=0; i < grid_size[0]*grid_size[1]; i++) {
                  const button = document.createElement("button")
                  button.classList.add("cell");
                  button.id = i.toString();
                  button.padding = "12px"
                  button.width = "0px"
                  button.height = "0px"
                  button.onclick = function() { console.log(button.id); click(parseInt(button.id));};
                  grid.appendChild(button);
                }
              });
              Array.from(document.getElementsByClassName("cell")).forEach(function (cell) { cell.style.background = ""})

            } else {

              if (window.innerHeight < 900) {
                cell_size = 25;
              } else {
                cell_size = 35;
              }

              curr_program_str = myCodeMirror.getValue();
              aex = parseau(curr_program_str);

              // console.log("curr_program_str");
              // console.log(curr_program_str);

              // console.log("aex");
              // console.log(aex);
              
              compiled = true;
              myCodeMirror.setOption("readOnly", "nocursor");
              // myCodeMirror.setValue(content);
            }
            updateButtonStyles();

            // console.log("client_id: "+client_id);
            // console.log("autumn-string: "+myCodeMirror.getValue());
          }
    
          function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min; //The maximum is exclusive and the minimum is inclusive
          }
    
          function playOrPauseClick() {
            // console.log("playOrPauseClick");
            if (!history_mode) {
              if (intervalID !== -1) { // pause
                paused = true;
                clearInterval(intervalID);
                intervalID = -1;
                updateButtonStyles();
              } else { // play
                if (not_run_yet) {
          
                  // console.log("aex");
                  // console.log(aex);
                  // console.log(curr_program_str);
                  [aex, env] = start(aex);

                  // Request finished. Do processing here.
                  // console.log("success!");
                  // update grid
                  grid_size = env.current_var_values.GRID_SIZE;
                  if (!Array.isArray(grid_size)) {
                    grid_size = [grid_size, grid_size];
                  }
                  // console.log("grid_size")
                  // console.log(grid_size)
                  // console.log(typeof(grid_size))

                  // cell_size = 25;

                  if (window.innerHeight < 900) {
                    cell_size = 25;
                  } else {
                    cell_size = 35;
                  }

                  if (Math.max(grid_size[0], grid_size[1]) > 18) {
                    cell_size = Math.round(cell_size * 18/Math.max(grid_size[0], grid_size[1]))
                  }

                  Array.from(document.getElementsByClassName("grid")).forEach(function (grid) {
                    grid.innerHTML = "";
                    grid.style = "grid-template-columns: repeat("+grid_size[0]+", "+ cell_size +"px); grid-template-rows: repeat("+grid_size[1]+", " + cell_size + "px);"
                    for (i=0; i < grid_size[0]*grid_size[1]; i++) {
                      const button = document.createElement("button")
                      button.classList.add("cell");
                      button.id = i.toString();
                      button.width = "0px";
                      button.height = "0px";
                      button.padding = Math.round(Math.max(cell_size/2 - 1, 1)).toString() + "px";
                      button.onclick = function() { console.log(button.id); click(parseInt(button.id));};
                      grid.appendChild(button);
                    }
                  });
                  paused = false;
                  if (intervalID != -1) {
                    clearInterval(intervalID);
                  }

                  var background = env.state.scene.background  
                  var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);

                  updateCellStyles(JSON.stringify([background, cells])); 
                  intervalID = setInterval(step_time, timestep);
                  updateButtonStyles();
                  // console.log("here?");

                  // console.log("hello");
                  // document.getElementById("play-button").innerHTML = "<i style='font-size: medium' class='fa fa-spinner fa-spin'></i>";
                  not_run_yet = false;
                } else {
                  paused = false;
                  intervalID = setInterval(step_time, timestep);
                  updateButtonStyles();
                }
              }
            } else {
              if (historyIntervalID == -1) {
                historyIntervalID = setInterval(historyStep, historytimestep);
              } else {
                clearInterval(historyIntervalID);
                historyIntervalID = -1;
              }
              updateButtonStyles();
            }
    
          }
    
          function restartClick() {
            if (!history_mode) {
              
              [aex, env] = start(aex);
              var background = env.state.scene.background  
              var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);
              updateCellStyles(JSON.stringify([background, cells]));

              // Request finished. Do processing here.
              if (intervalID != -1) {
                clearInterval(intervalID);
              }
              //updateCellStyles(`["#ffffff00"]`);

              paused = false;
              intervalID = setInterval(step_time, timestep);
              updateButtonStyles();

            } else {
              history_index = 0;
              historyIntervalID = setInterval(historyStep, historytimestep);
              updateButtonStyles();
            }
          }
          
    
          function click(id) {
            if (!history_mode) {
              if (intervalID != -1) {                
                user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : (id % grid_size[0]), "y" : Math.floor(id/grid_size[0])}}
                env = step(aex, env, user_event);

                var background = env.state.scene.background  
                var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);

                updateCellStyles(JSON.stringify([background, cells]));
              }
            }
          }
    
          document.addEventListener('keyup', function(event) {
            if (!history_mode && (intervalID != -1)) {
              switch (event.key) {
                case "ArrowLeft":
                  user_event = {"left" : true, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "ArrowRight":
                  user_event = {"left" : false, "right" : true, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "ArrowUp":
                user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "ArrowDown":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : true, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;                  
                case "a":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : true, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "d":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : true, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "w":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : true, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "s":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : true, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "f":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : true, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "h":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : true, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "t":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : true, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "g":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : true, "left4" : false, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "j":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : true, "right4" : false, "up4" : false, "down4" : false}
                  break;
                case "l":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : true, "up4" : false, "down4" : false}
                  break;
                case "i":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : true, "down4" : false}
                  break;
                case "k":
                  user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null, "left2" : false, "right2" : false, "up2" : false, "down2" : false, "left3" : false, "right3" : false, "up3" : false, "down3" : false, "left4" : false, "right4" : false, "up4" : false, "down4" : true}
                  break;
              }

              env = step(aex, env, user_event);

              var background = env.state.scene.background  
              var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);

              updateCellStyles(JSON.stringify([background, cells]));
            }
          });
    
          window.addEventListener("resize", (event) => { 

            if (window.innerHeight < 900) {
              cell_size = 25;
            } else {
              cell_size = 35;
            }

            if (Math.max(grid_size[0], grid_size[1]) > 18) {
              cell_size = Math.round(cell_size * 18/Math.max(grid_size[0], grid_size[1]))
            }

            Array.from(document.getElementsByClassName("grid")).forEach(function (grid) {
              grid.innerHTML = "";
              grid.style = "grid-template-columns: repeat("+grid_size[0]+", "+ cell_size +"px); grid-template-rows: repeat("+grid_size[1]+", " + cell_size + "px);"
              for (i=0; i < grid_size[0]*grid_size[1]; i++) {
                const button = document.createElement("button")
                button.classList.add("cell");
                button.id = i.toString();
                button.width = "0px";
                button.height = "0px";
                button.padding = Math.round(Math.max(cell_size/2 - 1, 1)).toString() + "px";
                button.onclick = function() { console.log(button.id); click(parseInt(button.id));};
                grid.appendChild(button);
              }
            });

            var background = env.state.scene.background  
            var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);

            updateCellStyles(JSON.stringify([background, cells]));

          });
          
    
          function step_time() {
            // console.log("step_time");
            if (env.state.time < 30000) {
              env = step(aex, env);

              var background = env.state.scene.background  
              var cells = interpret({ "head" : "call", "args": ["renderScene", [env.state.scene]]}, env)[0].map(cell => [cell.position.x, cell.position.y, JSON.stringify(cell.color).slice(8, -2)]);

              // console.log("background");
              // console.log(background);

              // console.log("cells");
              // console.log(cells);

              updateCellStyles(JSON.stringify([background, cells]));

              // Request finished. Do processing here.
              clearInterval(intervalID);
              if (paused) {
                intervalID = -1;
              } else {
                intervalID = setInterval(step_time, timestep);
              }
            } else {
              playOrPauseClick();
            }
          }
    
          function saveClick() {
            history_mode = true;
            saved = false;
            if (history_mode && !(saved)) {
              var xhr = new XMLHttpRequest();
    
              xhr.open("GET", host + '/save?clientid='+client_id+"&model="+model_name+"&gridsize="+grid_size[0], true);
                //Send the proper header information along with the request
                xhr.setRequestHeader("Content-Type", "application/json");
    
              xhr.onreadystatechange = function () { // Call a function when the state changes.
                if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                  // Request finished. Do processing here.
                  // console.log("success!");
                  // console.log("xhr.response: "+JSON.stringify(xhr.response));
                  saved = true;
                  history_mode = false;
                  updateButtonStyles();
                }
              };
              xhr.send();
              
            }
          }
    
          function historyClick() {
            if (!history_mode) {
              history_mode = true;

              // Request finished. Do processing here.
              // console.log("success!");



              history_response = "";
              history_index = 0;
              historyIntervalID = setInterval(historyStep, historytimestep);
              updateButtonStyles();
            } else {
              history_mode = false;
              history_response = '{}';
              updateButtonStyles();
              updateCellStyles(`["#ffffff00"]`);
            }
    
          }
    
          function historyStep() {
            if (history_index < Object.keys(JSON.parse(history_response)).length) {
              // console.log(history_response);
              // console.log(JSON.parse(history_response)[history_index])
              ret_val = JSON.parse(history_response)[history_index]
              // console.log("here: history_index")
              // console.log(history_index)
              // console.log("here: ret_val")
              // console.log(JSON.stringify(ret_val))
              updateCellStyles(JSON.stringify(ret_val));
              history_index++;
            } else {
              clearInterval(historyIntervalID);
              historyIntervalID = -1;
              updateButtonStyles();
            }
          }
    
          var myCodeMirror = CodeMirror.fromTextArea(document.getElementById("autumn-string"), { mode : "erlang",
                                                                                                theme : "erlang-dark",                                                                                              
                                                                                                lineNumbers: true,
                                                                                                viewportMargin: 0,
                                                                                                autoCloseBrackets: true,
                                                                                                matchBrackets: true,
                                                                                                scrollbarStyle: "overlay",
                                                                                                styleActiveLine: {nonEmpty: true},
                                                                                                });
          particlesClick();
    
        updateCellStyles(`["#ffffff00", []]`);
    
        function colorToRGBA(color_, a) {
          // console.log("colorToRGBA")
          // console.log(color_);
          if (typeof(color_) != "string") {
            var color = JSON.stringify(color_).slice(8, -2);
          } else {
            var color = color_;
          }
          if (color[0] != "#") {
            hex = colors[color];
          } else {
            hex = color;
          }
          // console.log("hex: "+hex)
          return hexToRGB(hex, a)
        }
    
        function hexToRGB(hex, alpha) {
          var r = parseInt(hex.slice(1, 3), 16),
              g = parseInt(hex.slice(3, 5), 16),
              b = parseInt(hex.slice(5, 7), 16);
    
          if (alpha) {
              return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
          } else {
              return "rgb(" + r + ", " + g + ", " + b + ")";
          }
        }
    
        var colors = {"aliceblue":"#f0f8ff","antiquewhite":"#faebd7","aqua":"#00ffff","aquamarine":"#7fffd4","azure":"#f0ffff",
          "beige":"#f5f5dc","bisque":"#ffe4c4","black":"#000000","blanchedalmond":"#ffebcd","blue":"#0000ff","blueviolet":"#8a2be2","brown":"#a52a2a","burlywood":"#deb887",
          "cadetblue":"#5f9ea0","chartreuse":"#7fff00","chocolate":"#d2691e","coral":"#ff7f50","cornflowerblue":"#6495ed","cornsilk":"#fff8dc","crimson":"#dc143c","cyan":"#00ffff",
          "darkblue":"#00008b","darkcyan":"#008b8b","darkgoldenrod":"#b8860b","darkgray":"#a9a9a9","darkgreen":"#006400","darkkhaki":"#bdb76b","darkmagenta":"#8b008b","darkolivegreen":"#556b2f",
          "darkorange":"#ff8c00","darkorchid":"#9932cc","darkred":"#8b0000","darksalmon":"#e9967a","darkseagreen":"#8fbc8f","darkslateblue":"#483d8b","darkslategray":"#2f4f4f","darkturquoise":"#00ced1",
          "darkviolet":"#9400d3","deeppink":"#ff1493","deepskyblue":"#00bfff","dimgray":"#696969","dodgerblue":"#1e90ff",
          "firebrick":"#b22222","floralwhite":"#fffaf0","forestgreen":"#228b22","fuchsia":"#ff00ff",
          "gainsboro":"#dcdcdc","ghostwhite":"#f8f8ff","gold":"#ffd700","goldenrod":"#daa520","gray":"#808080","green":"#008000","greenyellow":"#adff2f",
          "honeydew":"#f0fff0","hotpink":"#ff69b4",
          "indianred ":"#cd5c5c","indigo":"#4b0082","ivory":"#fffff0","khaki":"#f0e68c",
          "lavender":"#e6e6fa","lavenderblush":"#fff0f5","lawngreen":"#7cfc00","lemonchiffon":"#fffacd","lightblue":"#add8e6","lightcoral":"#f08080","lightcyan":"#e0ffff","lightgoldenrodyellow":"#fafad2",
          "lightgrey":"#d3d3d3","lightgreen":"#90ee90","lightpink":"#ffb6c1","lightsalmon":"#ffa07a","lightseagreen":"#20b2aa","lightskyblue":"#87cefa","lightslategray":"#778899","lightsteelblue":"#b0c4de",
          "lightyellow":"#ffffe0","lime":"#00ff00","limegreen":"#32cd32","linen":"#faf0e6",
          "magenta":"#ff00ff","maroon":"#800000","mediumaquamarine":"#66cdaa","mediumblue":"#0000cd","mediumorchid":"#ba55d3","mediumpurple":"#9370d8","mediumseagreen":"#3cb371","mediumslateblue":"#7b68ee",
          "mediumspringgreen":"#00fa9a","mediumturquoise":"#48d1cc","mediumvioletred":"#c71585","midnightblue":"#191970","mintcream":"#f5fffa","mistyrose":"#ffe4e1","moccasin":"#ffe4b5",
          "navajowhite":"#ffdead","navy":"#000080",
          "oldlace":"#fdf5e6","olive":"#808000","olivedrab":"#6b8e23","orange":"#ffa500","orangered":"#ff4500","orchid":"#da70d6",
          "palegoldenrod":"#eee8aa","palegreen":"#98fb98","paleturquoise":"#afeeee","palevioletred":"#d87093","papayawhip":"#ffefd5","peachpuff":"#ffdab9","peru":"#cd853f","pink":"#ffc0cb","plum":"#dda0dd","powderblue":"#b0e0e6","purple":"#800080",
          "rebeccapurple":"#663399","red":"#ff0000","rosybrown":"#bc8f8f","royalblue":"#4169e1",
          "saddlebrown":"#8b4513","salmon":"#fa8072","sandybrown":"#f4a460","seagreen":"#2e8b57","seashell":"#fff5ee","sienna":"#a0522d","silver":"#c0c0c0","skyblue":"#87ceeb","slateblue":"#6a5acd","slategray":"#708090","snow":"#fffafa","springgreen":"#00ff7f","steelblue":"#4682b4",
          "tan":"#d2b48c","teal":"#008080","thistle":"#d8bfd8","tomato":"#ff6347","turquoise":"#40e0d0",
          "violet":"#ee82ee",
          "wheat":"#f5deb3","white":"#ffffff","whitesmoke":"#f5f5f5",
          "yellow":"#ffff00","yellowgreen":"#9acd32"};
    
          function antsClick() {
            model_name = "ants";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Ant (Cell 0 0 "gray"))
  (object Food (Cell 0 0 "red"))
  
  (: ants (List Ant))
  (= ants (initnext (list (Ant (Position 5 5)) (Ant (Position 1 14))) (prev ants)))
  
  (: foods (List Food))
  (= foods (initnext (list) (prev foods)))
  
  (on true (= ants (updateObj (prev ants) (--> obj (move obj (unitVector obj (closest obj Food)))))))
  (on true (= foods (updateObj (prev foods) (--> obj (if (intersects obj (prev ants))
  ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†                                             then (removeObj obj)
  ¬†¬†¬†¬†  ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†                               else obj)))))
  
  (on clicked (= foods (addObj foods (map Food (randomPositions GRID_SIZE 2)))))
)`);
        }
    
        function particlesClick() {
          model_name = "particles";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Particle (Cell 0 0 "blue"))

  (: particles (List Particle))
  (= particles 
    (initnext (list) 
              (updateObj (prev particles) (--> obj (uniformChoice (list (moveLeft obj) (moveRight obj) (moveDown obj) (moveUp obj)) )))))¬†

  (on clicked (= particles (addObj (prev particles) (Particle (Position (.. click x) (.. click y))))))
)`);
        }
    
        function lightClick() {
          model_name = "lights";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 10)
  
  (object Light (: on Bool) (Cell 0 0 (if on then "yellow" else "white")))
  
  (: lights (List Light))
  (= lights (initnext (map (--> pos (Light false pos)) (filter (--> pos (== (.. pos x) (.. pos y))) (allPositions GRID_SIZE))) 
                      (prev lights)))
  
  (on clicked (= lights (updateObj lights (--> obj (updateObj obj "on" (! (.. obj on)))))))
  )`)
        }
    
        function magnetsClick() {
          model_name = "magnets_i";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Magnet (: color String) (list (Cell 0 0 color) (Cell 0 1 color)))
  
  (: fixedMagnet Magnet)
  (= fixedMagnet (initnext (Magnet "red" (Position 7 7)) (prev fixedMagnet)))
  
  (: mobileMagnet Magnet)
  (= mobileMagnet (initnext (Magnet "blue" (Position 4 7)) (prev mobileMagnet)))
  
  (on left (= mobileMagnet (moveNoCollision (prev mobileMagnet) -1 0)))
  (on right (= mobileMagnet (moveNoCollision (prev mobileMagnet) 1 0)))
  (on up (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 -1)))
  (on down (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 1)))
  (on (adjacent (posPole mobileMagnet) (posPole fixedMagnet) 1) (= mobileMagnet (prev mobileMagnet)))
  (on (adjacent (negPole mobileMagnet) (negPole fixedMagnet) 1) (= mobileMagnet (prev mobileMagnet)))
  (on (in (displacement (posPole mobileMagnet) (negPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet    (unitVector (displacement (posPole mobileMagnet) (negPole fixedMagnet))))))
  (on (in (displacement (negPole mobileMagnet) (posPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (displacement (negPole mobileMagnet) (posPole fixedMagnet))))))
    
  (= posPole (fn (magnet) (first (render magnet))))  
  (= negPole (fn (magnet) (last (render magnet))))  
  
  (= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
  )`);
        }
    
        function plugClick() {
          model_name = "plug";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Button (: color String) (Cell 0 0 color))
  (object Vessel (Cell 0 0 "purple"))
  (object Plug (Cell 0 0 "orange"))
  (object Water (Cell 0 0 "blue"))
  
  (: vesselButton Button)
  (= vesselButton (Button "purple" (Position 2 0)))
  (: plugButton Button)
  (= plugButton (Button "orange" (Position 5 0)))
  (: waterButton Button)
  (= waterButton (Button "blue" (Position 8 0)))
  (: removeButton Button)
  (= removeButton (Button "black" (Position 11 0)))
  (: clearButton Button)
  (= clearButton (Button "red" (Position 14 0)))
  
  (: vessels (List Vessel))
  (= vessels (initnext (list (Vessel (Position 6 15)) (Vessel (Position 6 14)) (Vessel (Position 6 13)) (Vessel (Position 5 12)) (Vessel (Position 4 11)) (Vessel (Position 3 10)) (Vessel (Position 9 15)) (Vessel (Position 9 14)) (Vessel (Position 9 13)) (Vessel (Position 10 12)) (Vessel (Position 11 11)) (Vessel (Position 12 10))) (prev vessels)))
  (: plugs (List Plug))
  (= plugs (initnext (list (Plug (Position 7 15)) (Plug (Position 8 15)) (Plug (Position 7 14)) (Plug (Position 8 14)) (Plug (Position 7 13)) (Plug (Position 8 13))) (prev plugs)))
  (: water (List Water))
  (= water (initnext (list) (prev water)))
  
  (= currentParticle (initnext "vessel" (prev currentParticle)))
  
  (on true (= water (updateObj (prev water) (--> obj (nextLiquid obj)))))
  (on (& clicked (& (isFree click) (== currentParticle "vessel"))) (= vessels (addObj vessels (Vessel (Position (.. click x) (.. click y))))))
  (on (& clicked (& (isFree click) (== currentParticle "plug"))) (= plugs (addObj plugs (Plug (Position (.. click x) (.. click y))))))
  (on (& clicked (& (isFree click) (== currentParticle "water"))) (= water (addObj water (Water (Position (.. click x) (.. click y))))))
  (on (clicked vesselButton) (= currentParticle "vessel"))
  (on (clicked plugButton) (= currentParticle "plug"))
  (on (clicked waterButton) (= currentParticle "water"))
  (on (clicked removeButton) (= plugs (removeObj plugs (--> obj true))))
  (on (clicked clearButton) (let ((= vessels (removeObj vessels (--> obj true))) (= plugs (removeObj plugs (--> obj true))) (= water (removeObj water (--> obj true))))))  
  )`);
        }
    
        function iceClick() {
          model_name = "ice";
          myCodeMirror.setValue(`(program
  (= GRID_SIZE 8)
  (object CelestialBody (: day Bool) (list (Cell 0 0 (if day then "gold" else "gray"))
                                          (Cell 0 1 (if day then "gold" else "gray"))
                                          (Cell 1 0 (if day then "gold" else "gray"))
                                          (Cell 1 1 (if day then "gold" else "gray"))))
  (object Cloud (list (Cell -1 0 "gray")
                      (Cell 0 0 "gray")
                      (Cell 1 0 "gray")))
  
  (object Water (: liquid Bool) (Cell 0 0 (if liquid then "blue" else "lightblue")))
  
  (: celestialBody CelestialBody)
  (= celestialBody (initnext (CelestialBody true (Position 0 0)) (prev celestialBody)))
  
  (: cloud Cloud)
  (= cloud (initnext (Cloud (Position 4 0)) (prev cloud)))
  
  (: water (List Water))
  (= water (initnext (list) (updateObj (prev water) nextWater)))
  
  (on left (= cloud (nextCloud cloud (Position -1 0))))
  (on right (= cloud (nextCloud cloud (Position 1 0))))
  (on down (= water (addObj water (Water (.. celestialBody day) (move (.. cloud origin) (Position 0 1))))))
  (on clicked (let ((= celestialBody (updateObj celestialBody "day" (! (.. celestialBody day)))) (= water (updateObj water (--> drop (updateObj drop "liquid" (! (.. drop liquid)))))))))
  
  (= nextWater (fn (drop) 
                  (if (.. drop liquid)
                    then (nextLiquid drop)
                    else (nextSolid drop))))
  
  (= nextCloud (fn (cloud position)
                  (if (isWithinBounds (move cloud position)) 
                    then (move cloud position)
                    else cloud)))
  )`);
        }
    
      function tetrisClick() {
        model_name = "tetris";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  (object Tetris (: shape (List Cell)) shape)

  (: blocks (List Tetris))
  (= blocks (initnext (list) (nextBlocks (prev blocks) (prev activeTetris))))
  
  (: activeTetris Tetris)
  (= activeTetris (initnext (Tetris (list (Cell 0 0 "blue") (Cell 0 1 "blue") (Cell 0 2 "blue") (Cell 1 2 "blue")) 
                                    (uniformChoice (list (Position 4 0) (Position 7 0) (Position 10 0))))
                            (nextTetris (prev activeTetris))))
  
  (on up (= activeTetris (rotateNoCollision (prev activeTetris))))
  (on down (= activeTetris (rotateNoCollision (rotateNoCollision (rotateNoCollision (prev activeTetris))))))
  (on left (= activeTetris (moveNoCollision (prev activeTetris) (Position -1 0))))
  (on right (= activeTetris (moveNoCollision (prev activeTetris) (Position 1 0))))
  (on (== (.. (nextSolid (prev activeTetris)) origin) (.. (prev activeTetris) origin)) 
    (let ((= activeTetris (nextTetris (prev activeTetris))) (= blocks (nextBlocks (prev blocks) (prev activeTetris))))))
  
  (= nextBlocks (fn (blocks tetris) 
                    (if (& (isFree (Position 0 0) (Position 15 0) tetris) 
                              (== (.. (nextSolid tetris) origin) (.. tetris origin))) 
                    then (addObj blocks tetris) 
                    else blocks)))  

  (= nextTetris (fn (tetris) 
                    (if (isFree (Position 0 0) (Position 15 0) tetris) 
                      then 
                      (if (== (.. (nextSolid tetris) origin) (.. tetris origin)) 
                      then (Tetris (uniformChoice (list (list (Cell 0 0 "blue") (Cell 0 1 "blue") (Cell 0 2 "blue") (Cell 1 2 "blue"))
                                                        (list (Cell -1 0 "yellow") (Cell 0 0 "yellow") (Cell 0 1 "yellow") (Cell 1 0 "yellow"))
                                                        (list (Cell 0 0 "purple") (Cell 0 1 "purple") (Cell 1 0 "purple") (Cell 1 1 "purple"))
                                                        (list (Cell 0 0 "limegreen") (Cell 0 1 "limegreen") (Cell 1 1 "limegreen") (Cell 1 2 "limegreen")))) 
                                    (uniformChoice (list (Position 4 0) (Position 7 0) (Position 10 0)))) 
                      else (nextSolid tetris))
                    else (removeObj tetris))))
)`);
      }
    
      function hatchClick() {
        model_name = "egg";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Eggshell (: broken Bool) (Cell 0 0 "tan"))
  (object Feather (: color String) (Cell 0 0 color))


  (: eggshells (List Eggshell))
  (= eggshells (initnext egg (nextEggshells (prev eggshells) (prev feathers))))

  (: feathers (List Feather))
  (= feathers (initnext (updateObj chick (--> feather (updateObj feather "hidden" true))) (nextFeathers (prev feathers))))

  (on (clicked eggshells) (= eggshells (updateObj (prev eggshells) 
                                                  (--> eggshell 
                                                        (if (& (== (.. (.. eggshell origin) x) (.. click x)) (== (.. (.. eggshell origin) y) (.. click y))) 
                                                        then (updateObj eggshell "broken" true) 
                                                        else eggshell)))))
                        
  (= nextEggshells (fn (eggshells feathers) 
                        (updateObj eggshells (--> eggshell (if (.. eggshell broken)
                                                            then (if (intersects eggshell feathers) 
                                                                  then (removeObj eggshell) 
                                                                  else (nextLiquid eggshell))
                                                            else eggshell)))))

  (= nextFeathers (fn (feathers) 
                      (updateObj feathers (--> feather (if (& (isFree (.. feather origin) feather) (.. feather hidden)) 
                                                        then (updateObj feather "hidden" false)
                                                        else feather)))))

  (= egg (list                                    
          (Eggshell false (Position 7 15)) 
          (Eggshell false (Position 8 15))
          (Eggshell false (Position 9 15))  
          (Eggshell false (Position 6 14)) 
          (Eggshell false (Position 7 14)) 
          (Eggshell false (Position 8 14)) 
          (Eggshell false (Position 9 14))
          (Eggshell false (Position 10 14)) 
          (Eggshell false (Position 5 13)) 
          (Eggshell false (Position 6 13))
          (Eggshell false (Position 7 13)) 
          (Eggshell false (Position 8 13)) 
          (Eggshell false (Position 9 13)) 
          (Eggshell false (Position 10 13))
          (Eggshell false (Position 11 13)) 
          (Eggshell false (Position 5 12)) 
          (Eggshell false (Position 6 12)) 
          (Eggshell false (Position 7 12))
          (Eggshell false (Position 8 12)) 
          (Eggshell false (Position 9 12)) 
          (Eggshell false (Position 10 12)) 
          (Eggshell false (Position 11 12))
          (Eggshell false (Position 5 11)) 
          (Eggshell false (Position 6 11)) 
          (Eggshell false (Position 7 11)) 
          (Eggshell false (Position 8 11))
          (Eggshell false (Position 9 11)) 
          (Eggshell false (Position 10 11)) 
          (Eggshell false (Position 11 11)) 
          (Eggshell false (Position 6 10)) 
          (Eggshell false (Position 7 10)) 
          (Eggshell false (Position 8 10)) 
          (Eggshell false (Position 9 10))
          (Eggshell false (Position 10 10))
          (Eggshell false (Position 7 9)) 
          (Eggshell false (Position 8 9)) 
          (Eggshell false (Position 9 9))))

  (= chick (list (Feather "orange" (Position 7 15))
            (Feather "orange" (Position 8 15))
            (Feather "yellow" (Position 6 14))
            (Feather "yellow" (Position 7 14))
            (Feather "yellow" (Position 8 14))
            (Feather "yellow" (Position 9 14))
            (Feather "yellow" (Position 6 13))
            (Feather "yellow" (Position 7 13))
            (Feather "yellow" (Position 8 13))
            (Feather "yellow" (Position 9 13))
            (Feather "yellow" (Position 6 12))
            (Feather "yellow" (Position 7 12))
            (Feather "yellow" (Position 8 12))
            (Feather "yellow" (Position 9 12))
            (Feather "yellow" (Position 9 11))
            (Feather "yellow" (Position 10 11))
            (Feather "orange" (Position 11 11))
            (Feather "yellow" (Position 9 10))
            (Feather "black" (Position 10 10))))

)`);
      }

      function snake4Click() {
        model_name = "snake";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 18)
  (= background "black")
  
  (object Snake (: head Cell) (: tail (List Cell)) (: direction Position) (vcat head tail))
  (object Food (Cell 0 0 "pink"))
  
  (: snake Snake)
  (= snake (initnext (Snake (Cell 7 7 "green") (list (Cell 8 7 "green")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake) (prev food))))

  (: snake2 Snake)
  (= snake2 (initnext (Snake (Cell 10 10 "blue") (list (Cell 11 10 "blue")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake2) (prev food))))  

  (: snake3 Snake)
  (= snake3 (initnext (Snake (Cell 13 13 "mediumpurple") (list (Cell 11 10 "mediumpurple")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake3) (prev food))))  

  (: snake4 Snake)
  (= snake4 (initnext (Snake (Cell 4 4 "magenta") (list (Cell 11 10 "magenta")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake4) (prev food))))    
  
  (: food Food)
  (= food (initnext (Food (Position 10 8)) (nextFood food)))
  
  (= nextSnake (fn (snake food) (let (
                                      (= new_snake (Snake (Cell (moveWrap (.. snake head) (.. snake direction)) (.. (.. snake head) color)) (vcat (.. snake head) (.. snake tail)) (.. snake direction) (.. snake origin)))
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†  (if (in (.. new_snake head) (.. new_snake tail)) 
                                        then (Snake (Cell (.. (.. snake head) position) "red") (.. snake tail) (.. snake direction) (.. snake origin)) 
                                        else (if (intersects (prev food) (if (== (.. (.. snake head) color) "green") then (prev snake) else (if (== (.. (.. snake head) color) "blue") then (prev snake2) else (if (== (.. (.. snake head) color) "mediumpurple") then (prev snake3) else (prev snake4))))) 
                                              then new_snake 
                                              else (updateObj new_snake "tail" (filter 
                                            (--> cell (!= (.. cell position) (.. (last (.. new_snake tail)) position))) 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†        (.. new_snake tail)))))
                                      ))))
  
  (= nextFood (fn (food) (if (! (intersects (prev food) (list (prev snake4) (prev snake3) (prev snake2) (prev snake))) )
                          then food 
                          else (Food (uniformChoice (filter isFree (allPositions GRID_SIZE)))) )))


  (on left (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position -1 0)))))
  (on right (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 1 0)))))
  (on up (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 0 -1)))))
  (on down (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 0 1)))))

  (on left2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position -1 0)))))
  (on right2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 1 0)))))
  (on up2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 0 -1)))))
  (on down2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 0 1)))))

  (on left3 (= snake3 (if (== (.. (.. (prev snake3) head) color) "red") then (prev snake3) else (updateObj (prev snake3) "direction" (Position -1 0)))))
  (on right3 (= snake3 (if (== (.. (.. (prev snake3) head) color) "red") then (prev snake3) else (updateObj (prev snake3) "direction" (Position 1 0)))))
  (on up3 (= snake3 (if (== (.. (.. (prev snake3) head) color) "red") then (prev snake3) else (updateObj (prev snake3) "direction" (Position 0 -1)))))
  (on down3 (= snake3 (if (== (.. (.. (prev snake3) head) color) "red") then (prev snake3) else (updateObj (prev snake3) "direction" (Position 0 1)))))

  (on left4 (= snake4 (if (== (.. (.. (prev snake4) head) color) "red") then (prev snake4) else (updateObj (prev snake4) "direction" (Position -1 0)))))
  (on right4 (= snake4 (if (== (.. (.. (prev snake4) head) color) "red") then (prev snake4) else (updateObj (prev snake4) "direction" (Position 1 0)))))
  (on up4 (= snake4 (if (== (.. (.. (prev snake4) head) color) "red") then (prev snake4) else (updateObj (prev snake4) "direction" (Position 0 -1)))))
  (on down4 (= snake4 (if (== (.. (.. (prev snake4) head) color) "red") then (prev snake4) else (updateObj (prev snake4) "direction" (Position 0 1)))))

  (on (== (.. (.. snake head) color) "red") (= snake (Snake (Cell (.. (.. (prev snake) head) position) "red") (.. (prev snake) tail) (.. (prev snake) direction) (.. (prev snake) origin))))
  (on (== (.. (.. snake2 head) color) "red") (= snake2 (Snake (Cell (.. (.. (prev snake2) head) position) "red") (.. (prev snake2) tail) (.. (prev snake2) direction) (.. (prev snake2) origin))))
  (on (== (.. (.. snake3 head) color) "red") (= snake (Snake (Cell (.. (.. (prev snake3) head) position) "red") (.. (prev snake3) tail) (.. (prev snake3) direction) (.. (prev snake3) origin))))
  (on (== (.. (.. snake4 head) color) "red") (= snake2 (Snake (Cell (.. (.. (prev snake4) head) position) "red") (.. (prev snake4) tail) (.. (prev snake4) direction) (.. (prev snake4) origin))))

  (on (== (.. (.. (prev snake) head) color) "red") (= snake (prev snake)))
  (on (== (.. (.. (prev snake2) head) color) "red") (= snake2 (prev snake2)))
  (on (== (.. (.. (prev snake3) head) color) "red") (= snake3 (prev snake3)))
  (on (== (.. (.. (prev snake4) head) color) "red") (= snake4 (prev snake4)))
)`);
      }

      

      function snakeClick() {
        model_name = "snake";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Snake (: head Cell) (: tail (List Cell)) (: direction Position) (vcat head tail))
  (object Food (Cell 0 0 "pink"))
  
  (: snake Snake)
  (= snake (initnext (Snake (Cell 7 7 "green") (list (Cell 8 7 "green")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake) (prev food))))

  (: snake2 Snake)
  (= snake2 (initnext (Snake (Cell 10 10 "blue") (list (Cell 11 10 "blue")) (Position -1 0) (Position 0 0)) 
                      (nextSnake (prev snake2) (prev food))))  
  
  (: food Food)
  (= food (initnext (Food (Position 10 8)) (nextFood food)))
  
  (= nextSnake (fn (snake food) (let (
                                      (= new_snake (Snake (Cell (moveWrap (.. snake head) (.. snake direction)) (.. (.. snake head) color)) (vcat (.. snake head) (.. snake tail)) (.. snake direction) (.. snake origin)))
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†  (if (in (.. new_snake head) (.. new_snake tail)) 
                                        then (Snake (Cell (.. (.. snake head) position) "red") (.. snake tail) (.. snake direction) (.. snake origin)) 
                                        else (if (intersects (prev food) (if (== (.. (.. snake head) color) "green") then (prev snake) else (prev snake2))) 
                                              then new_snake 
                                              else (updateObj new_snake "tail" (filter 
                                            (--> cell (!= (.. cell position) (.. (last (.. new_snake tail)) position))) 
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†        (.. new_snake tail)))))
                                      ))))
  
  (= nextFood (fn (food) (if (! (intersects (prev food) (list (prev snake2) (prev snake))) )
                          then food 
                          else (Food (uniformChoice (filter isFree (allPositions GRID_SIZE)))) )))


  (on left (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position -1 0)))))
  (on right (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 1 0)))))
  (on up (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 0 -1)))))
  (on down (= snake (if (== (.. (.. (prev snake) head) color) "red") then (prev snake) else (updateObj (prev snake) "direction" (Position 0 1)))))

  (on left2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position -1 0)))))
  (on right2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 1 0)))))
  (on up2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 0 -1)))))
  (on down2 (= snake2 (if (== (.. (.. (prev snake2) head) color) "red") then (prev snake2) else (updateObj (prev snake2) "direction" (Position 0 1)))))
  
  (on (== (.. (.. snake head) color) "red") (= snake (Snake (Cell (.. (.. (prev snake) head) position) "red") (.. (prev snake) tail) (.. (prev snake) direction) (.. (prev snake) origin))))
  (on (== (.. (.. snake2 head) color) "red") (= snake2 (Snake (Cell (.. (.. (prev snake2) head) position) "red") (.. (prev snake2) tail) (.. (prev snake2) direction) (.. (prev snake2) origin))))
)`);
      }


    
      function magnets2Click() {
        model_name = "magnets_ii";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Magnet (list (Cell 0 0 "blue") (Cell 0 1 "blue")))

  (: fixedMagnets (List Magnet))
  (= fixedMagnets (initnext (list (Magnet (Position 7 7))) (prev fixedMagnets)))

  (: mobileMagnet Magnet)
  (= mobileMagnet (initnext (Magnet (Position 4 7)) (prev mobileMagnet)))

  (on clicked (let ((= fixedMagnets (if (! (intersects (Magnet (Position (.. click x) (.. click y))))) then (addObj fixedMagnets mobileMagnet) else (prev fixedMagnets)))
                    (= mobileMagnet (if (! (intersects (Magnet (Position (.. click x) (.. click y))))) then (Magnet (Position (.. click x) (.. click y))) else (prev mobileMagnet)))
                    )))
  (on (clicked (prev mobileMagnet)) (= mobileMagnet (rotateNoCollision (prev mobileMagnet))))
  (on (clicked (prev fixedMagnets)) 
    (let ((= fixedMagnets (addObj fixedMagnets mobileMagnet)) 
          (= mobileMagnet (objClicked click fixedMagnets))
          (= fixedMagnets (removeObj fixedMagnets (objClicked click fixedMagnets)))
          )))
  (on left (= mobileMagnet (moveNoCollision (prev mobileMagnet) -1 0)))
  (on right (= mobileMagnet (moveNoCollision (prev mobileMagnet) 1 0)))
  (on up (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 -1)))
  (on down (= mobileMagnet (moveNoCollision (prev mobileMagnet) 0 1)))
  (on (adjacent (posPole mobileMagnet) (map posPole fixedMagnets)) (let ((= mobileMagnet (prev mobileMagnet)) (= fixedMagnets (prev fixedMagnets)))))
  (on (adjacent (negPole mobileMagnet) (map negPole fixedMagnets)) (let ((= mobileMagnet (prev mobileMagnet)) (= fixedMagnets (prev fixedMagnets)))))
  (on (intersects (map (--> magnet (displacement (posPole mobileMagnet) (negPole magnet))) fixedMagnets) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (uniformChoice (intersect (map (--> magnet (displacement (posPole mobileMagnet) (negPole magnet))) fixedMagnets) attractVectors))))))
  (on (intersects (map (--> magnet (displacement (negPole mobileMagnet) (posPole magnet))) fixedMagnets) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (uniformChoice (intersect (map (--> magnet (displacement (negPole mobileMagnet) (posPole magnet))) fixedMagnets) attractVectors))))))

  (= posPole (fn (magnet) (if (== (render magnet) (list)) then (Cell -1 -1 "blue") else (first (render magnet)))))  
  (= negPole (fn (magnet) (if (== (render magnet) (list)) then (Cell -1 -1 "blue") else (last (render magnet)))))  

  (= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
)`);
      }
    
      function magnets3Click() { 
        model_name = "magents_iii";
        myCodeMirror.setValue(`(program
    (= GRID_SIZE 16) 
  
  (object Magnet (list (Cell 0 0 "blue") (Cell 0 1 "blue")))
  
  (: fixedMagnet Magnet)
  (= fixedMagnet (initnext (Magnet (Position 7 7)) (prev fixedMagnet)))

  (: mobileMagnet Magnet)
  (= mobileMagnet (initnext (Magnet (Position 4 7)) (prev mobileMagnet)))
  
  (: isAttached Bool)
  (= isAttached (initnext false (prev isAttached)))
  
  (on clicked (= mobileMagnet (rotateNoCollision (prev mobileMagnet))))
  (on left (= mobileMagnet (move (prev mobileMagnet) -1 0))) 
  (on right (= mobileMagnet (move (prev mobileMagnet) 1 0)))
  (on up (= mobileMagnet (move (prev mobileMagnet) 0 -1)))
  (on down (= mobileMagnet (move (prev mobileMagnet) 0 1)))
  (on (& isAttached left) (= fixedMagnet (move (prev fixedMagnet) -1 0)))
  (on (& isAttached right) (= fixedMagnet (move (prev fixedMagnet) 1 0)))
  (on (& isAttached up) (= fixedMagnet (move (prev fixedMagnet) 0 -1)))
  (on (& isAttached down) (= fixedMagnet (move (prev fixedMagnet) 0 1)))
  (on (adjacent (posPole mobileMagnet) (posPole fixedMagnet)) (= mobileMagnet (prev mobileMagnet)))
  (on (adjacent (negPole mobileMagnet) (negPole fixedMagnet)) (= mobileMagnet (prev mobileMagnet)))
  (on (in (displacement (posPole mobileMagnet) (negPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet    (unitVector (displacement (posPole mobileMagnet) (negPole fixedMagnet))))))
  (on (in (displacement (negPole mobileMagnet) (posPole fixedMagnet)) attractVectors) (= mobileMagnet (move mobileMagnet (unitVector (displacement (negPole mobileMagnet) (posPole fixedMagnet))))))
  (on (& (adjacent (posPole mobileMagnet) (negPole fixedMagnet)) (adjacent (posPole fixedMagnet) (negPole mobileMagnet))) (= isAttached true))  
  
  (= posPole (fn (magnet) (first (render magnet))))  
  (= negPole (fn (magnet) (last (render magnet))))  

  (= attractVectors (list (Position 0 2) (Position 2 0) (Position -2 0) (Position 0 -2)))
)`);
      }
    
      function lockClick() { 
        model_name = "lock";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Key (list (Cell 0 0 "blue") (Cell 0 1 "blue")))
  (object Lock (list (Cell 0 0 "red") (Cell 0 1 "red") (Cell 0 2 "red") (Cell 0 3 "red") (Cell 1 2 "red") (Cell 1 3 "red") (Cell 2 0 "red") (Cell 2 1 "red") (Cell 2 2 "red") (Cell 2 3 "red")))
  (object Wall (list (Cell 0 0 "black") (Cell 1 0 "black") (Cell 2 0 "black") (Cell 3 0 "black") (Cell 4 0 "black")
  (Cell 5 0 "black") (Cell 6 0 "black") (Cell 7 0 "black") (Cell 8 0 "black") (Cell 9 0 "black")
  (Cell 10 0 "black") (Cell 11 0 "black") (Cell 12 0 "black")))

  (: fixedLock Lock)
  (= fixedLock (initnext (Lock (Position 0 7)) (prev fixedLock)))

  (: mobileKey Key)
  (= mobileKey (initnext (Key (Position 0 0)) (prev mobileKey)))

  (: movingWall Wall)
  (= movingWall (initnext (Wall (Position 3 7)) (prev movingWall)))

  (on left (= mobileKey (moveNoCollision (prev mobileKey) -1 0)))
  (on right (= mobileKey (moveNoCollision (prev mobileKey) 1 0)))
  (on up (= mobileKey (moveNoCollision (prev mobileKey) 0 -1)))
  (on down (= mobileKey (moveNoCollision (prev mobileKey) 0 1)))
  (on (& (== (.. mobileKey origin) (Position 1 7)) (!= (.. movingWall origin) (Position 4 7))) (= movingWall (move (prev movingWall) 1 0)))
  (on (& (!= (.. mobileKey origin) (Position 1 7)) (== (.. movingWall origin) (Position 4 7))) (= movingWall (move (prev movingWall) -1 0)))

)`);
      }

      function pongClick() { 
        model_name = "pong";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 50)
  (= background "black")
  
  (object Paddle (: color String) (map (--> pos (Cell pos color)) (rect (Position 0 -5) (Position 1 5))))
  (object Ball (map (--> pos (Cell pos "red")) (rect (Position -1 -1) (Position 1 1))))
  
  (: paddle1 Paddle)
  (= paddle1 (initnext (Paddle "yellow" (Position 0 25)) (prev paddle1)))
  
  (: paddle2 Paddle)
  (= paddle2 (initnext (Paddle "orange" (Position 48 25)) (prev paddle2)))
  
  (: ball Ball)
  (= ball (initnext (Ball (uniformChoice (rect (Position 20 20) (Position 30 30)))) (prev ball) ))
  
  (: ballDir Position)
  (= ballDir (initnext 
               (uniformChoice (filter (--> pos (& (!= (.. pos x) 0) (!= (.. pos y) 0))) (rect (Position -1 -1) (Position 1 1)))) 
               (prev ballDir)))
  
  (on up (= paddle2 (move (prev paddle2) 0 -5)))
  (on down (= paddle2 (move (prev paddle2) 0 5)))

  (on up2 (= paddle1 (move (prev paddle1) 0 -5)))
  (on down2 (= paddle1 (move (prev paddle1) 0 5)))
  
  (%% boundary handling)
  (on (== (.. (.. ball origin) x) 1) (= ballDir (Position (- 0 (.. ballDir x)) (.. ballDir y))))
  (on (== (.. (.. ball origin) y) 1) (= ballDir (Position (.. ballDir x) (- 0 (.. ballDir y)))))

  (on (== (.. (.. ball origin) x) (- GRID_SIZE 2)) (= ballDir (Position (- 0 (.. ballDir x)) (.. ballDir y))))
  (on (== (.. (.. ball origin) y) (- GRID_SIZE 2)) (= ballDir (Position (.. ballDir x) (- 0 (.. ballDir y)))))

  (%% paddle collision handling)
  (on (& (== (.. (.. (prev paddle1) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle1)))
      (= ballDir (Position 2 0)))

  (on (& (> (.. (.. (prev paddle1) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle1)))
      (= ballDir (Position 1 -1)))

  (on (& (< (.. (.. (prev paddle1) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle1)))
      (= ballDir (Position 1 1)))

  (on (& (== (.. (.. (prev paddle2) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle2)))
      (= ballDir (Position -2 0)))

  (on (& (> (.. (.. (prev paddle2) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle2)))
      (= ballDir (Position -1 -1)))

  (on (& (< (.. (.. (prev paddle2) origin) y) (.. (.. (prev ball) origin) y)) (intersects (move (prev ball) (prev ballDir)) (prev paddle2)))
      (= ballDir (Position -1 1)))

  (on true (= ball (move (prev ball) ballDir)))

)`);
      }
    
      function bbqClick() { 
        model_name = "bbq";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Bbq (: fire Bool) (: gas Integer) (list (Cell 0 1 "black") (Cell 1 1 "black") (Cell 2 1 "black") (Cell 1 0 (if fire then "orange" else "white")) (Cell 0 2 "gray") (Cell 0 3 "gray") (Cell 2 2 "gray") (Cell 2 3 "gray") (Cell 1 2 (if (> gas 20) then "yellow" else "white")) (Cell 1 3 (if (> gas 0) then "yellow" else "white"))))
  (object Person (: sick Bool) (Cell 0 0 (if sick then "green" else "blue")))
  (object Meat (: cooked Integer)  (Cell 0 0 (if (< cooked 15) then "pink" else (if (< cooked 30) then "brown" else "black"))))

  (object FillBBQ (Cell 0 0 "yellow"))

  (: bbq Bbq)
  (= bbq (initnext (Bbq true 28 (Position 7 12))
            (if (== (.. (prev bbq) gas) 0) then (updateObj (prev bbq) "fire" false) else
                  (if (.. (prev bbq) fire)
                    then (updateObj (prev bbq) "gas" (- (.. (prev bbq) gas) 1))
                    else (prev bbq)))))

  (: meat Meat)
  (= meat (initnext (Meat 0 (Position 8 11))
          (if (.. bbq fire)
            then (updateObj (prev meat) "cooked" (+ (.. (prev meat) cooked) 1))
            else (prev meat))))


  (: fillButton FillBBQ)
  (= fillButton (FillBBQ (Position 0 15)))

  (on (clicked bbq) (= bbq (if (== (.. (prev bbq) gas) 0) then (prev bbq) else (updateObj bbq "fire" (! (.. bbq fire))))))
  (on (clicked fillButton) (= bbq (updateObj bbq "gas" (+ (.. (prev bbq) gas) 5))))
)`);
      }
    
      function bottleClick() { 
        model_name = "bottle";
        myCodeMirror.setValue(`(program 
  (= GRID_SIZE 16)

  (object Suzie (Cell 0 0 "blue"))
  (object Billy (Cell 0 0 "red"))

  (object Bottle (: broken Bool) (list (Cell 0 0 (if broken then "yellow" else "white"))
                                        (Cell 0 1 (if broken then "white" else "yellow"))
                                        (Cell 0 2 (if broken then "gray" else "yellow"))
                                        (Cell 0 3 (if broken then "white" else "yellow"))
                                        (Cell 0 4 (if broken then "yellow" else "white"))))

  (object BottleSpot (Cell 0 0 "white"))
  (object Rock (Cell 0 0 "black"))

  (: suzie Suzie)
  (= suzie (Suzie (Position 0 0)))

  (: billy Billy)
  (= billy (Billy (Position 0 15)))

  (: bottleSpot BottleSpot)
  (= bottleSpot (initnext (BottleSpot (Position 15 7)) (BottleSpot (Position 15 7))))


  (: rocks (List Rock))
  (= rocks
    (initnext (list)
              (updateObj (prev rocks) (--> obj
                              (if (intersects bottleSpot obj) then (removeObj obj)
                                else (move obj (unitVector obj bottleSpot)))))))
  (= nextBottle (fn (bot rockst bottleSpott) (if (intersects bottleSpott rockst) then (updateObj bot "broken" true) else bot)))

  (: bottle Bottle)
  (= bottle (initnext (Bottle false (Position 15 5)) (nextBottle (prev bottle) (prev rocks) (prev bottleSpot))))

  (on (clicked suzie) (= rocks (addObj (prev rocks) (Rock (Position 0 0)))))
  (on (clicked billy) (= rocks (addObj (prev rocks) (Rock (Position 0 15)))))

  )`);
      }
    
      function diseaseClick() { 
        model_name = "disease";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 8)
  
  (object Particle (: health Bool) (Cell 0 0 (if health then "gray" else "darkgreen")))
  
  (: inactiveParticles (List Particle))
  (= inactiveParticles (initnext (list (Particle true (Position 5 3)) (Particle true (Position 2 1)) (Particle true (Position 4 4)) (Particle true (Position 1 3)) )  
                      (updateObj (prev inactiveParticles) (--> obj (if true
                                                                    then (updateObj obj "health" false)
                                                                    else obj)) 
                                                          (--> obj (adj (prev obj) (filter (--> obj (! (.. (prev obj) health))) (vcat (list (prev activeParticle)) (prev inactiveParticles))) 1)))))   
  
  (: activeParticle Particle)
  (= activeParticle (initnext (Particle false (Position 0 0)) (prev activeParticle)))¬†
  
  (on (!= (length (filter (--> obj (! (.. obj health))) (adjacentObjs activeParticle 1))) 0) (= activeParticle (updateObj (prev activeParticle) "health" false)))
  (on (clicked (prev inactiveParticles)) 
      (let ((= inactiveParticles (addObj (prev inactiveParticles) (prev activeParticle))) 
            (= activeParticle (objClicked click (prev inactiveParticles)))
            (= inactiveParticles (removeObj inactiveParticles (objClicked click (prev inactiveParticles))))
          )))
  (on left (= activeParticle (move (prev activeParticle) -1 0)))
  (on right (= activeParticle (move (prev activeParticle) 1 0)))
  (on up (= activeParticle (move (prev activeParticle) 0 -1)))
  (on down (= activeParticle (move (prev activeParticle) 0 1)))
)`);
      }
    
      function balls1Click() { 
        model_name = "balls1";
        myCodeMirror.setValue(`(program 
      (= GRID_SIZE 16)
    
      (object Goal (Cell 0 0 "green"))
      (: goal Goal)
      (= goal (initnext (Goal (Position 0 10)) (prev goal)))
    
      (object Ball (: direction Integer) (: color String) (Cell 0 0 color))
      (object Wall (: visible Bool)(list (Cell 0 0 (if visible then "black" else "white")) (Cell 0 1 (if visible then "black" else "white")) (Cell 0 2 (if visible then "black" else "white"))))
    
      (: wall Wall)
      (= wall (initnext (Wall true (Position 4 9)) (prev wall)))
    
      (= nextBall (fn (ball)
                    (if (== (.. ball direction) 1)
      then (updateObj ball "origin"
             (Position (.. (.. ball origin) x) (- (.. (.. ball origin) y) 1)))
      else
      (if (== (.. ball direction) 2)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
      else
      (if (== (.. ball direction) 3)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
      else
      (if (== (.. ball direction) 4)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
      else
      (if (== (.. ball direction) 5)
      then (updateObj ball "origin"
             (Position (.. (.. ball origin) x) (+ (.. (.. ball origin) y) 1)))
      else
      (if (== (.. ball direction) 6)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
      else
      (if (== (.. ball direction) 7)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
      else
      (if (== (.. ball direction) 8)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
      else ball))))))))))
    
    
      (on (clicked wall) (= wall (updateObj wall "visible" (! (.. wall visible)))))
    
      (= wallintersect (fn (ball)
                         (if (& (== (.. ball direction) 4) (== (.. (.. ball origin) y) 15)) then 2 else
      (if (& (== (.. ball direction) 5) (== (.. (.. ball origin) y) 15)) then 1 else
      (if (& (== (.. ball direction) 6) (== (.. (.. ball origin) y) 15)) then 8 else
      (if (& (== (.. ball direction) 6) (== (.. (.. ball origin) x) 0)) then 4 else
      (if (& (== (.. ball direction) 7) (== (.. (.. ball origin) x) 0)) then 3 else
      (if (& (== (.. ball direction) 8) (== (.. (.. ball origin) x) 0)) then 2 else
      (if (& (== (.. ball direction) 2) (== (.. (.. ball origin) x) 15)) then 8 else
      (if (& (== (.. ball direction) 3) (== (.. (.. ball origin) x) 15)) then 7 else
      (if (& (== (.. ball direction) 4) (== (.. (.. ball origin) x) 15)) then 6 else
      (if (& (== (.. ball direction) 8) (== (.. (.. ball origin) y) 0)) then 6 else
      (if (& (== (.. ball direction) 1) (== (.. (.. ball origin) y) 0)) then 5 else
      (if (& (== (.. ball direction) 2) (== (.. (.. ball origin) y) 0)) then 4 else
    
      (.. ball direction)))))))))))))))
    
    
      (: ball_a Ball)
      (= ball_a (initnext (Ball 7 "blue" (Position 15 10)) (if (intersects ball_a ball_b) then (nextBall (updateObj (prev ball_a) "direction" 6)) else (nextBall (updateObj (prev ball_a) "direction" (wallintersect (prev ball_a)))))))
    
      (: ball_b Ball)
      (= ball_b (initnext (Ball 6 "red" (Position 15 5)) (if (intersects (prev ball_a) ball_b) then (nextBall (updateObj (prev ball_b) "direction" 2)) else (nextBall (updateObj (prev ball_b) "direction" (wallintersect (prev ball_b)))))))
      )`);
      }
    
      function balls2Click() { 
        model_name = "balls2";
        myCodeMirror.setValue(`(program
      (= GRID_SIZE 16)
    
      (object Goal (Cell 0 0 "green"))
      (: goal Goal)
      (= goal (initnext (Goal (Position 0 10)) (prev goal)))
    
      (object Ball (: direction Integer) (: color String) (Cell 0 0 color))
    
      (= nextBall (fn (ball)
                    (if (< (.. ball direction) 45)
      then (updateObj ball "origin"
             (Position (.. (.. ball origin) x) (- (.. (.. ball origin) y) 1)))
      else
      (if (< (.. ball direction) 90)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
      else
      (if (< (.. ball direction) 135)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
      else
      (if (< (.. ball direction) 180)
      then (updateObj ball "origin"
             (Position (+ (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
      else
      (if (< (.. ball direction) 225)
      then (updateObj ball "origin"
             (Position (.. (.. ball origin) x) (+ (.. (.. ball origin) y) 1)))
      else
      (if (< (.. ball direction) 270)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (+ (.. (.. ball origin) y) 1)))
      else
      (if (< (.. ball direction) 315)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (.. (.. ball origin) y)))
      else
      (if (< (.. ball direction) 360)
      then (updateObj ball "origin"
             (Position (- (.. (.. ball origin) x) 1) (- (.. (.. ball origin) y) 1)))
      else ball))))))))))
    
    
      (on (clicked goal) (= goal (prev goal)))
    
      (= wallintersect (fn (ball)
                         (if (& (< (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then (- 180 (.. ball direction)) else
      (if (& (== (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then 0 else
      (if (& (> (.. ball direction) 180) (== (.. (.. ball origin) y) 15)) then (+ 90 (.. ball direction)) else
      (if (& (& (< (.. ball direction) 270) (> (.. ball direction) 180)) (== (.. (.. ball origin) x) 0)) then (- 360 (.. ball direction)) else
      (if (& (== (.. ball direction) 270) (== (.. (.. ball origin) x) 0)) then 90 else
      (if (& (> (.. ball direction) 270) (== (.. (.. ball origin) x) 0)) then (- 360 (.. ball direction)) else
      (if (& (< (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then (+ 270 (.. ball direction)) else
      (if (& (== (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then 270 else
      (if (& (> (.. ball direction) 90) (== (.. (.. ball origin) x) 15)) then (+ 90 (.. ball direction)) else
      (if (& (> (.. ball direction) 180) (== (.. (.. ball origin) y) 0)) then (- 520 (.. ball direction)) else
      (if (& (== (.. ball direction) 45) (== (.. (.. ball origin) y) 0)) then 180 else
      (if (& (< (.. ball direction) 180) (== (.. (.. ball origin) y) 0)) then (- 180 (.. ball direction)) else
      (.. ball direction)))))))))))))))
    
      (= ballcollision (fn (ball1 ball2)
                         (.. ball2 direction)
              ))
    
      (: ball_a Ball)
      (= ball_a (initnext (Ball 361 "blue" (Position 6 10)) (if (intersects ball_a ball_b) then (nextBall (updateObj (prev ball_a) "direction" (ballcollision (prev ball_a) (prev ball_b)))) else (nextBall (updateObj (prev ball_a) "direction" (wallintersect (prev ball_a)))))))
    
      (: ball_b Ball)
      (= ball_b (initnext (Ball 361 "red" (Position 10 10)) (if (intersects ball_b ball_c) then (nextBall (updateObj (prev ball_b) "direction" (ballcollision (prev ball_b) (prev ball_c)))) else (if (intersects (prev ball_a) ball_b) then (nextBall (updateObj (prev ball_b) "direction" 361)) else (nextBall (updateObj (prev ball_b) "direction" (wallintersect (prev ball_b))))))))
    
      (: ball_c Ball)
      (= ball_c (initnext (Ball 270 "purple" (Position 14 10)) (if (intersects (prev ball_b) ball_c) then (nextBall (updateObj (prev ball_c) "direction" 361)) else (nextBall (updateObj (prev ball_c) "direction" (wallintersect (prev ball_c)))))))
    
      (on (intersects ball_a goal) (= ball_a (updateObj ball_a "direction" 361)))
    )`);
      }
    
      function spaceInvadersClick() {
        model_name = "space_invaders";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Enemy (Cell 0 0 "blue"))
  (object Hero (Cell 0 0 "black"))
  (object Bullet (Cell 0 0 "red"))
  (object EnemyBullet (Cell 0 0 "orange"))
  
  (: enemies1 (List Enemy))
  (= enemies1 (initnext (map 
                          (--> pos (Enemy pos)) 
                          (filter (--> pos (& (== (.. pos y) 1) (== (% (.. pos x) 3) 1))) (allPositions GRID_SIZE)))
                        (prev enemies1)))
  
  (: enemies2 (List Enemy))
  (= enemies2 (initnext (map 
                          (--> pos (Enemy pos)) 
                          (filter (--> pos (& (== (.. pos y) 3) (== (% (.. pos x) 3) 2))) (allPositions GRID_SIZE)))
                        (prev enemies2)))
  
  
  (: hero Hero)
  (= hero (initnext (Hero (Position 8 15)) (prev hero)))
  
  (: enemyBullets (List EnemyBullet))
  (= enemyBullets (initnext (list) (prev enemyBullets)))
  
  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))                                                         
  
  (on true (= enemyBullets (updateObj enemyBullets (--> obj (moveDown obj)))))
  (on true (= bullets (updateObj bullets (--> obj (moveUp obj)))))
  (on left (= hero (moveLeftNoCollision (prev hero))))
  (on right (= hero (moveRightNoCollision (prev hero))))
  (on (& up (.. (prev hero) alive)) (= bullets (addObj bullets (Bullet (.. (prev hero) origin)))))  
  
  (on (== (% time 10) 5) (= enemies1 (updateObj enemies1 (--> obj (moveLeft obj)))))
  (on (== (% time 10) 0) (= enemies1 (updateObj enemies1 (--> obj (moveRight obj)))))
  
  (on (== (% time 10) 5) (= enemies2 (updateObj enemies2 (--> obj (moveRight obj)))))
  (on (== (% time 10) 0) (= enemies2 (updateObj enemies2 (--> obj (moveLeft obj)))))
  
  (on (intersects (prev bullets) (prev enemies1))
    (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies1)))))
          (= enemies1 (removeObj enemies1 (--> obj (intersects (prev obj) (prev bullets)))))))
  )          
          
  (on (intersects (prev bullets) (prev enemies2))
    (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies2)))))
          (= enemies2 (removeObj enemies2 (--> obj (intersects (prev obj) (prev bullets)))))))
  )
          
  (on (== (% time 5) 2) (= enemyBullets (addObj enemyBullets (EnemyBullet (uniformChoice (map (--> obj (.. obj origin)) (vcat (prev enemies1) (prev enemies2))))))))         
  (on (intersects (prev hero) (prev enemyBullets)) (= hero (removeObj (prev hero))))
  
  (on (intersects (prev bullets) (prev enemyBullets)) 
    (let 
      ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemyBullets))))) 
        (= enemyBullets (removeObj enemyBullets (--> obj (intersects (prev obj) (prev bullets))))))))           
)`)
      }
    
      function gameOfLifeClick() {
        model_name = "gol";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Particle (: living Bool) (Cell 0 0 (if living then "black" else "white")))
  
  (: particles (List Particle))
  (= particles 
      (initnext (map (--> pos (Particle false pos)) (allPositions GRID_SIZE)) 
                (prev particles)))¬†
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
    
  (on (& clicked (< time 20)) (= particles (addObj (removeObj (prev particles) (objClicked click particles)) (Particle true (Position (.. click x) (.. click y))))))
  (on (> time 20) (= particles 
                      (updateObj 
                        (prev particles) 
                        (--> obj 
                            (if (& (.. obj living) 
                  (| (<= (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 1)
                                      (>= (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 4))) 
              then (updateObj obj "living" false)
              else (if (& (! (.. obj living))
                                        (== (length (filter (--> o (.. o living)) (adjacentObjsDiag obj))) 3))
                  then (updateObj obj "living" true)
                                  else obj))))))
)`)
      }
    
      function sokobanClick() {
        model_name = "sokoban_i";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Agent (Cell 0 0 "blue"))
  (object Box (Cell 0 0 "black"))
  (object Goal (Cell 0 0 "red"))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 7 4)) (prev agent)))
    
  (: boxes (List Box))
  (= boxes (initnext (list (Box (Position 14 2)) (Box (Position 9 14)) (Box (Position 1 2)) (Box (Position 0 4)) (Box (Position 4 4)) (Box (Position 9 9)) (Box (Position 10 9)) (Box (Position 0 11))) (prev boxes)))
  
  (: goal Goal)
  (= goal (initnext (Goal (Position 0 0)) (prev goal)))
  
  (on left (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) -1 0)) 
                (= agent (moveAgent (prev agent) (prev boxes) (prev goal) -1 0))))) 
  
  (on right (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 1 0)) 
                  (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 1 0))))) 
  
  (on up (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 -1)) 
              (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 -1))))) 
  
  (on down (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 1)) 
                (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 1))))) 
  
  (on (& clicked (isFree click)) (= boxes (addObj boxes (Box (Position (.. click x) (.. click y))))))
  
  (: moveBoxes (-> (List Box) Agent Goal Int Int (List Box)))
  (= moveBoxes (fn (boxes agent goal x y) 
                  (updateObj boxes 
                    (--> obj (if (intersects (move obj x y) goal) then (removeObj obj) else (moveNoCollision obj x y))) 
                    (--> obj (== (displacement (.. obj origin) (.. agent origin)) (Position (- 0 x) (- 0 y)))))))
  
  (: moveAgent (-> Agent (List Box) Goal Int Int Agent))
  (= moveAgent (fn (agent boxes goal x y) 
                  (if (intersects (list (move agent x y)) (moveBoxes boxes agent goal x y))
                    then agent 
                    else (move agent x y))))
)`)
      }
    
      function sokobanClick2() {
        model_name = "sokoban_ii";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 8)
  
  (object Agent (Cell 0 0 "blue"))
  (object Box (Cell 0 0 "darkorange"))
  (object Goal (Cell 0 0 "red"))
  (object Teleporter (Cell 0 0 "green"))
  (object Wall (Cell 0 0 "black"))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 3 3)) (prev agent)))
      
  (: boxes (List Box))
  (= boxes (initnext (list (Box (Position 1 6)) (Box (Position 4 1)) (Box (Position 6 4)) (Box (Position 3 6))) (prev boxes)))
  
  (: goal Goal)
  (= goal (initnext (Goal (Position 0 0)) (prev goal)))
  
  (: teleporter1 Teleporter)
  (= teleporter1 (initnext (Teleporter (Position 2 6)) (prev teleporter1)))

  (: teleporter2 Teleporter)
  (= teleporter2 (initnext (Teleporter (Position 0 4)) (prev teleporter2)))
  
  (: walls (List Wall))
  (= walls (initnext (list (Wall (Position 1 1)) 
                            (Wall (Position 1 2)) 
                            (Wall (Position 1 3)) 
                            (Wall (Position 1 4)) 
                            (Wall (Position 1 5))
                            (Wall (Position 2 1))
                            (Wall (Position 3 1))
                            (Wall (Position 5 1))
                            (Wall (Position 5 0))) (prev walls)))
  
  (on left (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) -1 0)) 
                  (= agent (moveAgent (prev agent) (prev boxes) (prev goal) -1 0))))) 

  (on right (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 1 0)) 
                  (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 1 0))))) 

  (on up (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 -1)) 
                (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 -1))))) 

  (on down (let ((= boxes (moveBoxes (prev boxes) (prev agent) (prev goal) 0 1)) 
                  (= agent (moveAgent (prev agent) (prev boxes) (prev goal) 0 1))))) 
  
  (on (& clicked (isFree click)) (= boxes (addObj boxes (Box (Position (.. click x) (.. click y))))))

  (: moveBoxes (-> (List Box) Agent Goal Int Int (List Box)))
  (= moveBoxes (fn (boxes agent goal x y) 
                    (updateObj boxes 
                      (--> obj (if (intersects (move obj x y) goal) 
                                then (removeObj obj) 
                                else (if (& (intersects (move obj x y) (prev teleporter1)) (! (intersects (prev teleporter2) (prev boxes)))) 
                                      then (move obj (displacement (.. obj origin) (.. (prev teleporter2) origin))) 
                    else (moveNoCollision obj (Position x y))))) 
                      (--> obj (== (displacement (.. obj origin) (.. agent origin)) (Position (- 0 x) (- 0 y)))))))

  (: moveAgent (-> Agent (List Box) Goal Int Int Agent))
  (= moveAgent (fn (agent boxes goal x y) 
                    (if (| (| (intersects (list (move agent x y)) (moveBoxes boxes agent goal x y))
                              (intersects (list (move agent x y)) (prev walls)))
                          (! (isWithinBounds (move agent x y)))) 
                    then agent 
                    else (move agent x y))))
)`)
      }
    
      function growClick() {
        model_name = "grow";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 7)
  
  (object Water (Cell 0 0 "blue"))
  (object Leaf (: color String) (Cell 0 0 color))
  (object Cloud (list (Cell -1 0 "gray") (Cell 0 0 "gray") (Cell 1 0 "gray")
                      (Cell -1 1 "gray") (Cell 0 1 "gray") (Cell 1 1 "gray")))
  
  (object Sun (: movingLeft Bool) (list (Cell 0 0 "gold")
                                (Cell 0 1 "gold")
                                  (Cell 1 0 "gold")
                                (Cell 1 1 "gold")))
  
  (: sun Sun)
  (= sun (initnext (Sun false (Position 0 0)) (prev sun)))
  
  (: water (List Water))
  (= water (initnext (list) (updateObj (prev water) (--> obj (if (! (isWithinBounds obj)) then (removeObj obj) else (moveDown obj))))))
  
  (: cloud Cloud)
  (= cloud (initnext (Cloud (Position 5 0)) (prev cloud)))
  
  (: leaves (List Leaf))
  (= leaves (initnext (list (Leaf "green" (Position 1 6) ) (Leaf "green" (Position 3 6)) (Leaf "green" (Position 5 6)) ) (prev leaves)))
      
  (on down
    (= water (addObj (prev water) (Water (.. (moveDown (prev cloud)) origin)))))
  
  (on (intersects (map (--> obj (moveDown obj)) (prev water) ) (prev leaves))
    (= water (removeObj water (--> obj (intersects (moveDown (prev obj)) (prev leaves))) ) ) )
  
  (on (& (intersects (map (--> obj (moveDown obj)) (prev water)) (filter (--> obj (== (.. obj color) "green")) (prev leaves))) (! (intersects (prev sun) (prev cloud))))
    (= leaves (addObj (prev leaves) (map (--> obj (Leaf (if (== (.. (.. (moveUp obj) origin) y) 4) then "mediumpurple" else "green") (.. (moveUp obj) origin))) (filter (--> obj (intersects (moveUp obj) (prev water))) (prev leaves))))))
    
  (on left (= cloud (moveLeft (prev cloud))))
  (on right (= cloud (moveRight (prev cloud))))
  
  (on (== (.. (.. (prev sun) origin) x) 0) (= sun (updateObj (prev sun) "movingLeft" false)))
  (on (== (.. (.. (prev sun) origin) x) 5) (= sun (updateObj (prev sun) "movingLeft" true)))
  
  (on (clicked (prev sun)) (= sun (if (.. (prev sun) movingLeft) then (moveLeft (prev sun)) else (moveRight (prev sun)))))
)`)
      }
    
      function marioClick() {
        model_name = "mario";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "white")
  
  (object Mario (: bullets Int) (Cell 0 0 "red"))
  (object Step (list (Cell -1 0 "darkorange") (Cell 0 0 "darkorange") (Cell 1 0 "darkorange")))
  (object Coin (Cell 0 0 "gold"))
  (object Enemy (: movingLeft Bool) (: lives Int) (list (Cell -1 0 "blue") (Cell 0 0 "blue") (Cell 1 0 "blue")
                                      (Cell -1 1 "blue") (Cell 0 1 "blue") (Cell 1 1 "blue")))
  (object Bullet (Cell 0 0 "mediumpurple"))
  
  (: mario Mario)
  (= mario (initnext (Mario 0 (Position 7 15)) (if (intersects (moveDown (prev mario)) (prev coins)) then (moveDown (prev mario)) else (moveDownNoCollision (prev mario)))))
  
  (: steps (List Step))
  (= steps (initnext (list (Step (Position 4 13)) (Step (Position 8 10)) (Step (Position 11 7))) (prev steps)))
  
  (: coins (List Coin))
  (= coins (initnext (list (Coin (Position 4 12)) (Coin (Position 7 4)) (Coin (Position 11 6))) (prev coins)))
  
  (: enemy Enemy)
  (= enemy (initnext (Enemy true 1 (Position 7 0)) (if (.. (prev enemy) movingLeft) then (moveLeft (prev enemy)) else (moveRight (prev enemy)))))
  
  (: bullets (List Bullet))
  (= bullets (initnext (list) (updateObj (prev bullets) (--> obj (if (intersects (moveUp obj) (prev steps)) then (removeObj obj) else (moveUp obj))))))
  
  (: enemyLives Int)
  (= enemyLives (initnext 1 (prev enemyLives)))
  
  (on (== (.. (.. (prev enemy) origin) x) 1) (= enemy (moveRight (updateObj (prev enemy) "movingLeft" false))))
  (on (== (.. (.. (prev enemy) origin) x) 14) (= enemy (moveLeft (updateObj (prev enemy) "movingLeft" true))))
  
  (on left (= mario (if (intersects (moveLeft (prev mario)) (prev coins)) then (moveLeft (prev mario)) else (moveLeftNoCollision (prev mario)))))
  (on right (= mario (if (intersects (moveRight (prev mario)) (prev coins)) then (moveRight (prev mario)) else (moveRightNoCollision (prev mario)))))
  (on (& up (== (moveDownNoCollision (prev mario)) (prev mario))) (= mario (moveNoCollision (prev mario) 0 -4)))
  
  (on (intersects (prev mario) (prev coins)) 
    (let ((= coins (removeObj (prev coins) (--> obj (intersects obj (prev mario))))) 
          (= mario (moveDownNoCollision (updateObj (prev mario) "bullets" (+ (.. (prev mario) bullets) 1)))))) )
  
  (on (& clicked (> (.. (prev mario) bullets) 0)) 
    (let ((= bullets (addObj (prev bullets) (Bullet (.. (prev mario) origin)))) 
          (= mario (moveDownNoCollision (updateObj (prev mario) "bullets" (- (.. (prev mario) bullets) 1)))))))
  
  (on (intersects (prev enemy) (prev bullets))
    (let ((= bullets (removeObj (prev bullets) (--> obj (intersects obj (prev enemy))))) 
          (= enemy (if (== (prev enemyLives) 1) then (removeObj (prev enemy)) else (if (.. (prev enemy) movingLeft) then (moveLeft (prev enemy)) else (moveRight (prev enemy))) ))
          (= enemyLives (- (prev enemyLives) 1)))))
)`)
    
      }
    
      function sandClick() {
        model_name = "sand";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 10)
  
  (object Button (: color String) (Cell 0 0 color))
  (object Sand (: liquid Bool) (Cell 0 0 (if liquid then "sandybrown" else "tan")))
  (object Water (Cell 0 0 "skyblue"))
  
  (: sandButton Button)
  (= sandButton (initnext (Button "red" (Position 2 0)) (prev sandButton)))
  
  (: waterButton Button)
  (= waterButton (initnext (Button "green" (Position 7 0)) (prev waterButton)))
  
  (: sand (List Sand))
  (= sand (initnext (list (Sand false (Position 2 9)) (Sand false (Position 3 9)) (Sand false (Position 4 9)) (Sand false (Position 5 9)) (Sand false (Position 6 9)) (Sand false (Position 7 9))
                          (Sand false (Position 2 8)) (Sand false (Position 3 8)) (Sand false (Position 4 8)) (Sand false (Position 5 8)) (Sand false (Position 6 8)) (Sand false (Position 7 8))
                          (Sand false (Position 2 7)) (Sand false (Position 3 7)) (Sand false (Position 4 7)) (Sand false (Position 5 7)) (Sand false (Position 6 7)) (Sand false (Position 7 7))
                          (Sand false (Position 2 6)) (Sand false (Position 4 6))  (Sand false (Position 5 6)) (Sand false (Position 7 6))
                          (Sand false (Position 2 5)) (Sand false (Position 4 5))  (Sand false (Position 5 5)) (Sand false (Position 7 5))                    
                    )
            		
            (updateObj (prev sand) (--> obj (if (.. obj liquid) 
  then (nextLiquid obj)
  else (nextSolid obj))))))
  
  (: water (List Water))
  (= water (initnext (list) (updateObj (prev water) (--> obj (nextLiquid obj)))))
  
  
  (: clickType String)
  (= clickType (initnext "sand" (prev clickType)))
  
  (on true (= sand (updateObj sand (--> obj (updateObj obj "liquid" true)) (--> obj (& (! (.. obj liquid)) (intersects (adjacentObjs obj 1) (prev water)))))))
  
  (on (clicked sandButton) (= clickType "sand"))
  (on (clicked waterButton) (= clickType "water"))
  (on (& (& clicked (isFree click)) (== clickType "sand"))  (= sand (addObj sand (Sand false (Position (.. click x) (.. click y))))))
  (on (& (& clicked (isFree click)) (== clickType "water")) (= water (addObj water (Water (Position (.. click x) (.. click y))))))
    
)`)
      }
    
      function gravityClick() {
        model_name = "gravity_i";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 -1 "blue") (Cell 0 0 "blue") (Cell 1 -1 "blue") (Cell 1 0 "blue")))
  
  (: leftButton Button)
  (= leftButton (initnext (Button "red" (Position 0 7)) (prev leftButton)))
  
  (: rightButton Button)
  (= rightButton (initnext (Button "darkorange" (Position 15 7)) (prev rightButton)))
    
  (: upButton Button)
  (= upButton (initnext (Button "gold" (Position 7 0)) (prev upButton)))
  
  (: downButton Button)
  (= downButton (initnext (Button "green" (Position 7 15)) (prev downButton)))
  
  (: blobs (List Blob))
  (= blobs (initnext (list) (prev blobs)))
  
  (: gravity String)
  (= gravity (initnext "down" (prev gravity)))
  
  (on (== gravity "left") (= blobs (updateObj blobs (--> obj (moveLeft obj)))))
  (on (== gravity "right") (= blobs (updateObj blobs (--> obj (moveRight obj)))))
  (on (== gravity "up") (= blobs (updateObj blobs (--> obj (moveUp obj)))))
  (on (== gravity "down") (= blobs (updateObj blobs (--> obj (moveDown obj)))))
  
  (on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))) )
  
  (on (clicked leftButton) (= gravity "left"))
  
  (on (clicked rightButton) (= gravity "right"))
  
  (on (clicked upButton) (= gravity "up"))
  
  (on (clicked downButton) (= gravity "down"))
)`)
      }
    
      function gravity2Click() {
        model_name="gravity_ii";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 30)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (: color String) (list (Cell 0 -1 color) (Cell 0 0 color) (Cell 1 -1 color) (Cell 1 0 color)))
  
  (: leftButton Button)
  (= leftButton (initnext (Button "red" (Position 0 14)) (prev leftButton)))
  
  (: rightButton Button)
  (= rightButton (initnext (Button "darkorange" (Position 29 14)) (prev rightButton)))
    
  (: upButton Button)
  (= upButton (initnext (Button "gold" (Position 14 0)) (prev upButton)))
  
  (: downButton Button)
  (= downButton (initnext (Button "green" (Position 14 29)) (prev downButton)))
  
  (: blobs (List Blob))
  (= blobs (initnext (list) (prev blobs)))
  
  (: gravity String)
  (= gravity (initnext "down" (prev gravity)))
  
  (: blobColor Int)
  (= blobColor (initnext 0 (prev blobColor)))
  
  (on (== gravity "left") (= blobs (updateObj (prev blobs) (--> obj (moveLeft obj)))))
  (on (== gravity "right") (= blobs (updateObj (prev blobs) (--> obj (moveRight obj)))))
  (on (== gravity "up") (= blobs (updateObj (prev blobs) (--> obj (moveUp obj)))))
  (on (== gravity "down") (= blobs (updateObj (prev blobs) (--> obj (moveDown obj)))))
  
  (on (& clicked (isFree click)) (= blobColor (% (+ (prev blobColor) 1) 3)))
  (on (& (& clicked (isFree click)) (== blobColor 0)) (= blobs (addObj blobs (Blob "blue" (Position (.. click x) (.. click y))))))
  (on (& (& clicked (isFree click)) (== blobColor 1)) (= blobs (addObj blobs (Blob "mediumpurple" (Position (.. click x) (.. click y))))))
  (on (& (& clicked (isFree click)) (== blobColor 2)) (= blobs (addObj blobs (Blob "magenta" (Position (.. click x) (.. click y))))))
  
  (on (clicked leftButton) (= gravity "left"))
  
  (on (clicked rightButton) (= gravity "right"))
  
  (on (clicked upButton) (= gravity "up"))
  
  (on (clicked downButton) (= gravity "down"))
)`)
      }
    
      function gravity3Click() {
        model_name = "gravity_iii";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 40)
  (= background "black")
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 19 19))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
            
  (on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))))
  
  (on (& left (!= (prev xVel) -1)) (= xVel (- (prev xVel) 1)))
  (on (& right (!= (prev xVel) 1)) (= xVel (+ (prev xVel) 1)))
  
  (on (& up (!= (prev yVel) -1)) (= yVel (- (prev yVel) 1)))
  (on (& down (!= (prev yVel) 1)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (prev xVel) (prev yVel)))))))
)`)
      }
    
      function gravity4Click() {
        model_name = "gravity_iv";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 -1 "black") (Cell 0 0 "black") (Cell 1 -1 "black") (Cell 1 0 "black")))
  
  (: buttons (List Button))
  (= buttons (initnext (list (Button "red" (Position 4 0)) 
              (Button "gold" (Position 8 0))                             
              (Button "darkorange" (Position 12 0))
                        
              (Button "lightgreen" (Position (- GRID_SIZE 1) 4))
                            (Button "green" (Position (- GRID_SIZE 1) 8))
                            (Button "lightseagreen" (Position (- GRID_SIZE 1) 12))
                            
                            (Button "lightblue" (Position 4 (- GRID_SIZE 1)))
                            (Button "blue" (Position 8 (- GRID_SIZE 1)))
                            
  
                        ) (prev buttons)))
  
  (: blobs (List Blob))
  (= blobs (initnext (list) (prev blobs)))
  
  (: gravity String)
  (= gravity (initnext "rr" (prev gravity)))
                                                                    
  (on (== gravity "ul") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) -1 -2)))))
  (on (== gravity "uu") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 0 -2)))))
  (on (== gravity "ur") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 1 -2)))))
  
  (on (== gravity "ru") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 -1)))))
  (on (== gravity "rr") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 0)))))
  (on (== gravity "rd") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 2 1)))))
  
  (on (== gravity "dl") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) -1 2)))))
  (on (== gravity "dd") (= blobs (updateObj (prev blobs) (--> obj (move (prev obj) 0 2)))))
  
  
  (on (clicked (filter (--> obj (== (.. obj color) "red")) (prev buttons))) (= gravity "ul"))
  (on (clicked (filter (--> obj (== (.. obj color) "gold")) (prev buttons))) (= gravity "uu"))
  (on (clicked (filter (--> obj (== (.. obj color) "darkorange")) (prev buttons))) (= gravity "ur"))
  
  (on (clicked (filter (--> obj (== (.. obj color) "lightgreen")) (prev buttons))) (= gravity "ru"))
  (on (clicked (filter (--> obj (== (.. obj color) "green")) (prev buttons))) (= gravity "rr"))
  (on (clicked (filter (--> obj (== (.. obj color) "lightseagreen")) (prev buttons))) (= gravity "rd"))
  
  (on (clicked (filter (--> obj (== (.. obj color) "lightblue")) (prev buttons))) (= gravity "dl"))
  (on (clicked (filter (--> obj (== (.. obj color) "blue")) (prev buttons))) (= gravity "dd"))
  
  (on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))))
)`)
      }
    
      function chargeClick() {
        model_name = "charge";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  
  (object Jumper (map (--> pos (Cell pos "red")) (rect (Position 0 0) (Position 1 1))))
  (object Stop (: gold Bool) (list (Cell 0 0 (if gold then "gold" else "blue")) (Cell 1 0 (if gold then "gold" else "blue"))))
    
  (: jumper Jumper)  
  (= jumper (initnext (Jumper (Position 0 (- GRID_SIZE 2))) (moveDownNoCollision (prev jumper))))

  (: stop Stop)
  (= stop (initnext (Stop false (Position 7 3)) (prev stop)))
  
  (: energy Int)
  (= energy (initnext 0 (prev energy)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
  
  (on left (= jumper (moveLeftNoCollision jumper)))
  (on right (= jumper (moveRightNoCollision jumper)))

  (on (& (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2)) (<= energy 10))
      (= energy (+ energy 1)))

  (on (& clicked (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2))) 
    (let ((= jumper (move (prev jumper) (Position 0 (* -1 (prev energy)))))
            (= energy 0))))

  (on (intersects (prev stop) (adjacentObjs (prev jumper)))
      (= stop (updateObj stop "gold" (! (.. stop gold)))))
)`)
      }
    
      function eggClick() {
        model_name = "egg";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  
  (object Button (: color String) (Cell 0 0 color))
  (object Piece (Cell 0 0 "gold"))
  (object Egg (list (Cell -1 -2 "tan") (Cell 0 -2 "tan") (Cell 1 -2 "tan")  
                    (Cell -2 -1 "tan") (Cell -1 -1 "tan") (Cell 0 -1 "tan") (Cell 1 -1 "tan") (Cell 2 -1 "tan")
                    (Cell -2 0 "tan") (Cell -1 0 "tan") (Cell 0 0 "tan") (Cell 1 0 "tan") (Cell 2 0 "tan") 
                    (Cell -2 1 "tan") (Cell -1 1 "tan") (Cell 0 1 "tan") (Cell 1 1 "tan") (Cell 2 1 "tan") 
                  (Cell -1 2 "tan") (Cell 0 2 "tan") (Cell 1 2 "tan")))
  
  (: egg Egg)
  (= egg (initnext (Egg (Position 7 13)) (prev egg)))
  
  (: pieces (List Piece))
  (= pieces (initnext (list) (updateObj (prev pieces) (--> obj (nextLiquid obj)))))
  
  (: button Button)
  (= button (initnext (Button "red" (Position 0 0)) (updateObj (prev button) "color" (if gravity then "pink" else "red"))))
  
  (: gravity Bool)
  (= gravity (initnext false (prev gravity)))
  
  (: height Int)
  (= height (initnext 15 (prev height)))
  
  (on gravity (= egg (moveDownNoCollision (prev egg))))
    
  (on (& left (! gravity)) (= egg (moveLeftNoCollision (prev egg))))
  (on (& right (! gravity)) (= egg (moveRightNoCollision (prev egg))))
  (on (& up (! gravity)) (= egg (moveUpNoCollision (prev egg))))
  (on (& down (! gravity)) (= egg (moveDownNoCollision (prev egg))))
  
  (on (clicked (prev button)) 
    (let ((= gravity (! (prev gravity)))
          (= height (.. (.. (prev egg) origin) y)))))
  
  (on (& (< height 7) (== (.. (.. egg origin) y) 13)) 
    (let ((= egg (removeObj egg)) 
          (= pieces (addObj (prev pieces) (map (--> obj (Piece (Position (.. (.. obj position) x) (+ 1 (.. (.. obj position) y))))) (render (prev egg))))))))
)`)
      }
    
      function balloonClick() {
        model_name = "balloon";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "skyblue")
  
  (object Rock (Cell 0 0 "black"))
  (object Balloon (: color String) (list (Cell -1 -2 color) (Cell 0 -2 color) (Cell 1 -2 color)  
                      (Cell -2 -1 color) (Cell -1 -1 color) (Cell 0 -1 color) (Cell 1 -1 color) (Cell 2 -1 color)
                      (Cell -2 0 color) (Cell -1 0 color) (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) 
                      (Cell -2 1 color) (Cell -1 1 color) (Cell 0 1 color) (Cell 1 1 color) (Cell 2 1 color) 
                      (Cell -1 2 color) (Cell 0 2 color) (Cell 1 2 color) 
                      (Cell -1 3 "tan") (Cell 0 4 "tan") (Cell 1 3 "tan")
                      (Cell -1 5 "tan") (Cell 1 5 "tan")
                      (Cell -2 6 "brown") (Cell -2 7 "brown") (Cell -2 8 "brown")
                      (Cell 2 6 "brown") (Cell 2 7 "brown") (Cell 2 8 "brown")
                      (Cell -1 8 "brown") (Cell 0 8 "brown") (Cell 1 8 "brown")      
                  ))

  (: balloon Balloon)
  (= balloon (initnext (Balloon "mediumpurple" (Position 7 7)) (prev balloon)))
  
  (: rocks (List Rock))
  (= rocks (initnext (list) (updateObj (prev rocks) (--> obj (nextSolid obj)))) )
  
  (: weight Bool)
  (= weight (initnext false (prev weight)))
  
  (on (>= (count (--> pos (intersects (list pos) (map (--> obj (.. obj origin)) (filter (--> obj (intersects obj (nextSolid obj))) (prev rocks)))) ) 
            (rect (move (.. (prev balloon) origin) (Position -2 0)) 
          (move (.. (prev balloon) origin) (Position 2 7)))) 3)
      (= weight true))

  (on (< (count (--> pos (intersects (list pos) (map (--> obj (.. obj origin)) (filter (--> obj (intersects obj (nextSolid obj))) (prev rocks)))) ) 
            (rect (move (.. (prev balloon) origin) (Position -2 0)) 
          (move (.. (prev balloon) origin) (Position 2 7)))) 3)
      (= weight false))
  
  (on (prev weight) 
    (let 
        ((= rocks (updateObj 
                    (prev rocks) 
                    (--> obj (if (| (! (intersects obj (nextSolid obj))) (isWithinBounds (moveDown (prev balloon)))) then (moveDown obj) else obj)) 
                    (--> obj (intersects (list (.. obj origin)) 
              (rect (move (.. (prev balloon) origin) (Position -2 0)) 
                    (move (.. (prev balloon) origin) (Position 2 7)))))))
        (= balloon (if (! (isWithinBounds (moveDown (prev balloon)))) then (prev balloon) else (moveDown (prev balloon)))))))  

  (on (! (prev weight)) 
    (let 
        ((= rocks (updateObj 
                    (prev rocks) 
                    (--> obj (if (! (isWithinBounds (moveUp (prev balloon)))) then (nextSolid obj) else (moveUp obj))) 
                    (--> obj (intersects (list (.. obj origin)) 
              (rect (move (.. (prev balloon) origin) (Position -2 0)) 
                    (move (.. (prev balloon) origin) (Position 2 7)))))))
        (= balloon (if (! (isWithinBounds (moveUp (prev balloon)))) then (prev balloon) else (moveUp (prev balloon)))))))  
  
  (on (& clicked (isFree click)) (= rocks (addObj (prev rocks) (Rock (Position (.. click x) (.. click y ))))))

  (on (clicked (prev rocks)) 
    (= rocks (removeObj 
                (prev rocks) 
                (--> obj (== (.. obj id) (.. (objClicked click (prev rocks)) id)))))) 
)`)
      }
    
      function windClick() {
        model_name = "wind";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 17)
  
  (object Water (Cell 0 0 "lightblue"))
  (object Cloud (map (--> pos (Cell (.. pos x) (.. pos y) "gray")) (rect (Position 0 0) (Position 16 1))))
  
  (: water (List Water))
  (= water (initnext (list) (updateObj (prev water) (--> obj (removeObj obj)) (--> obj (! (isWithinBounds obj)))))) 
      ¬†
  (: cloud Cloud)
  (= cloud (initnext (Cloud (Position 0 0)) (prev cloud)))
  
  (: wind Int)
  (= wind (initnext 0 (prev wind)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
  
  (on (== wind 0) (= water (updateObj (prev water) (--> obj (moveDown obj)))))
  (on (== wind 1) (= water (updateObj (prev water) (--> obj (moveRight (moveDown obj))))))
  (on (== wind -1) (= water (updateObj (prev water) (--> obj (moveLeft (moveDown obj))))))
  
  (on true (= water (updateObj water (--> obj (removeObj (prev obj))) (--> obj (! (isWithinBounds (prev obj)))))))
  
  
  (on left (= wind (if (== (prev wind) -1) then (prev wind) else (- (prev wind) 1))))
  (on right (= wind (if (== (prev wind) 1) then (prev wind) else (+ (prev wind) 1))))
  
  
  (on (== (% time 5) 2) 
    (= water (addObj 
              water 
              (map (--> pos (Water pos)) (list (Position 2 2)
                                                
                                              (Position 6 2)
                                              
                                              (Position 10 2)
                                              
                                              (Position 14 2))))))
)`)
      }
    
      function paintClick() {
        model_name = "paint";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Particle (: color String) (Cell 0 0 color))
  
  (: particles (List Particle))
  (= particles (initnext (list) (prev particles)))
  
  (: currColor String)
  (= currColor (initnext "red" (prev currColor)))
  
  (on clicked (= particles (addObj (prev particles) (Particle currColor (Position (.. click x) (.. click y))))))
  (on (& up (== (prev currColor) "red")) (= currColor "gold"))
  (on (& up (== (prev currColor) "gold")) (= currColor "green"))
  (on (& up (== (prev currColor) "green")) (= currColor "blue"))
  (on (& up (== (prev currColor) "blue")) (= currColor "purple"))
  (on (& up (== (prev currColor) "purple")) (= currColor "red"))
)`)
      }
    
      function chaseClick() {
        model_name = "chase";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Ant (Cell 0 0 "red"))
  (object Agent (Cell 0 0 "green"))
  
  (: ants (List Ant))
  (= ants (initnext (list ) 
                    (prev ants)))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 7 5)) (prev agent))) 
                                                                                                                  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))                                                                                                                   
                                  
  (on true (= ants (updateObj (prev ants) (--> obj (move obj (unitVector obj (closest obj Agent)))) )))
  (on (== (% time 10) 5) (= ants (addObj ants (map Ant (randomPositions GRID_SIZE 1)))))
  
  (on left (= agent (moveLeft (prev agent))))
  (on right (= agent (moveRight (prev agent))))
  (on up (= agent (moveUp (prev agent))))
  (on down (= agent (moveDown (prev agent))))
          
  (on (intersects (prev agent) (prev ants)) (= agent (removeObj (prev agent))))                                                                                                                   
)`)
      }
    
      function coinsClick() {
        model_name = "coins";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Agent (Cell 0 0 "red"))
  (object Coin (Cell 0 0 "gold"))
  (object Bullet (Cell 0 0 "mediumpurple"))

  (: agent Agent)
  (= agent (initnext (Agent (Position 7 9)) (prev agent)))

  (: coins (List Coin))
  (= coins (initnext (map (--> pos (Coin pos)) (filter (--> p (& (== (% (.. p y) 2) 0) (== (% (.. p x) 2) 0))) (rect (Position 3 2) (Position 12 4)))) (prev coins)))

  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: numBullets Int)
  (= numBullets (initnext 0 (prev numBullets)))
  
  (on left (= agent (moveLeft agent)))
  (on right (= agent (moveRight agent)))
  (on up (= agent (moveUp agent)))
  (on down (= agent (moveDown agent)))

  (on true (= bullets (updateObj bullets (--> obj (moveUp (prev obj))))))
  
  (on (& clicked (> (prev numBullets) 0)) 
      (let ((= numBullets (- (prev numBullets) 1)) 
            (= bullets (addObj bullets (Bullet (.. (prev agent) origin)))))))  

  (on (intersects (prev agent) (prev coins)) 
      (let ((= numBullets (+ (prev numBullets) 1)) 
            (= coins (removeObj coins (--> obj (intersects (prev obj) (prev agent))))))))
)`)
      }
    
      function count1Click() {
        model_name = "count_1";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
  
  (: xActive Bool)
  (= xActive (initnext true (prev xActive)))
  
  (on clicked (= xActive (! xActive)))
  
  (on (& (& left xActive) (> (prev xVel) -1)) (= xVel (- (prev xVel) 1)))
  (on (& (& right xActive) (< (prev xVel) 1)) (= xVel (+ (prev xVel) 1)))
  
  (on (& (& up (! xActive)) (> (prev yVel) -1)) (= yVel (- (prev yVel) 1)))
  (on (& (& down (! xActive)) (> (prev yVel) 1)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function count2Click() {
        model_name = "count_2";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
  
  (: xActive Bool)
  (= xActive (initnext true (prev xActive)))
  
  (on clicked (= xActive (! xActive)))
  
  (on (& (& left xActive) (> (prev xVel) -2)) (= xVel (- (prev xVel) 1)))
  (on (& (& right xActive) (< (prev xVel) 2)) (= xVel (+ (prev xVel) 1)))
  
  (on (& (& up (! xActive)) (> (prev yVel) -2)) (= yVel (- (prev yVel) 1)))
  (on (& (& down (! xActive)) (> (prev yVel) 2)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function count3Click() {
        model_name = "count_3";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
  
  (: xActive Bool)
  (= xActive (initnext true (prev xActive)))
  
  (on clicked (= xActive (! xActive)))
  
  (on (& (& left xActive) (> (prev xVel) -3)) (= xVel (- (prev xVel) 1)))
  (on (& (& right xActive) (< (prev xVel) 3)) (= xVel (+ (prev xVel) 1)))
  
  (on (& (& up (! xActive)) (> (prev yVel) -3)) (= yVel (- (prev yVel) 1)))
  (on (& (& down (! xActive)) (> (prev yVel) 3)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function count4Click() {
        model_name = "count_4";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
  
  (: xActive Bool)
  (= xActive (initnext true (prev xActive)))
  
  (on clicked (= xActive (! xActive)))
  
  (on (& (& left xActive) (> (prev xVel) -4)) (= xVel (- (prev xVel) 1)))
  (on (& (& right xActive) (< (prev xVel) 4)) (= xVel (+ (prev xVel) 1)))
  
  (on (& (& up (! xActive)) (> (prev yVel) -4)) (= yVel (- (prev yVel) 1)))
  (on (& (& down (! xActive)) (> (prev yVel) 4)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function count5Click() {
        model_name = "count_5";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 50 50))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
  
  (: xActive Bool)
  (= xActive (initnext true (prev xActive)))
  
  (on clicked (= xActive (! xActive)))
  
  (on (& (& left xActive) (> (prev xVel) -5)) (= xVel (- (prev xVel) 1)))
  (on (& (& right xActive) (< (prev xVel) 5)) (= xVel (+ (prev xVel) 1)))
  
  (on (& (& up (! xActive)) (> (prev yVel) -5)) (= yVel (- (prev yVel) 1)))
  (on (& (& down (! xActive)) (> (prev yVel) 5)) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function arcSlackClick() {
        model_name = "arc_slack";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Particle (: active Bool) (: green Bool) (Cell 0 0 (if green then "green" else "gold")))
  (object Button (: color String) (Cell 0 0 color))
  
  (: particles (List Particle))
  (= particles (initnext (list (Particle true true (Position 1 1)) (Particle false true (Position 5 5)) (Particle false false (Position 11 14)) (Particle false true (Position 4 8)) (Particle false false (Position 9 9)) (Particle false true (Position 1 13)) (Particle false false (Position 14 5)))  
                (prev particles)))

  (: colorButton Button)
  (= colorButton (initnext (Button "gray" (Position (- GRID_SIZE 1) 0)) (prev colorButton)))

  (: removeButton Button)
  (= removeButton (initnext (Button "orangered" (Position (- GRID_SIZE 1) 2)) (prev removeButton)))
  
  (on (clicked colorButton) (= particles (updateObj particles (--> obj (updateObj obj "green" (! (.. obj green)))) (--> obj (.. obj active)))))
  (on (clicked removeButton) (= particles (updateObj particles (--> obj (removeObj obj)) (--> obj (.. obj active)))))  
  (on (clicked particles) 
      (let ((= particles (updateObj particles (--> obj (updateObj obj "active" false)) (--> obj (!= obj (objClicked click particles)))))
            (= particles (updateObj particles (--> obj (updateObj obj "active" true)) (--> obj (== obj (objClicked click particles)))))) ))
  
  (on left (= particles (updateObj particles (--> obj (moveLeftNoCollision obj)) (--> obj (.. obj active)))))
  (on right (= particles (updateObj particles (--> obj (moveRightNoCollision obj)) (--> obj (.. obj active)))))
  (on up (= particles (updateObj particles (--> obj (moveUpNoCollision obj)) (--> obj (.. obj active)))))
  (on down (= particles (updateObj particles (--> obj (moveDownNoCollision obj)) (--> obj (.. obj active)))))
)`)
      }
    
      function rinkClick() {
        model_name = "rink";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 28)
  (= background "black")
  
  (object Rink (map (--> pos (Cell pos "lightblue")) (rect (Position 0 0) (Position 21 21))))
  (object Skater (Cell 0 0 "red"))
    
  (: rink Rink)
  (= rink (initnext (Rink (Position 3 3)) (prev rink)) )
  
  (: skater Skater)
  (= skater (initnext (Skater (Position 0 0)) (prev skater)))
  
  (: slide String)
  (= slide (initnext "none" (prev slide)))
  
  (on left (= skater (moveLeft skater)))
  (on right (= skater (moveRight skater)))
  (on up (= skater (moveUp skater)))
  (on down (= skater (moveDown skater)))
    
  (on (& left (! (in slide (list "none" "right")))) (= slide "left"))
  (on (& right (! (in slide (list "none" "left")))) (= slide "right"))
  (on (& up (! (in slide (list "none" "down")))) (= slide "up"))
  (on (& down (! (in slide (list "none" "up")))) (= slide "down"))

  (on (& (!= (prev slide) "none") (! (intersects (prev skater) rink))) 
    (= slide "none"))  
  
  (on (== slide "left") (= skater (move (prev skater) -2 0)))
  (on (== slide "right") (= skater (move (prev skater) 2 0)))
  (on (== slide "up") (= skater (move (prev skater) 0 -2)))
  (on (== slide "down") (= skater (move (prev skater) 0 2)))

   
  (on (& (! (intersects (prev skater) rink)) (intersects skater rink)) 
    (= slide (if left then "left" else (if right then "right" else (if up then "up" else "down")))))    
)`)
      }
    
      function doubleCountClick() {
        model_name = "double_1";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 49 49))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
    
  (on (& (> (prev xVel) -1) (& left (== (prev yVel) 0))) (= xVel (- (prev xVel) 1)))
  (on (& (< (prev xVel) 1) (& right (== (prev yVel) 0))) (= xVel (+ (prev xVel) 1)))
  
  (on (& (> (prev yVel) -1) (& up (== (prev xVel) 0))) (= yVel (- (prev yVel) 1)))
  (on (& (< (prev yVel) 1) (& down (== (prev xVel) 0))) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function doubleCount2Click() {
        model_name = "double_2";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 100)
    
  (object Button (: color String) (Cell 0 0 color))
  (object Blob (list (Cell 0 0 "blue")))
  
  (: blobs (List Blob))
  (= blobs (initnext (list (Blob (Position 49 49))) (prev blobs)))
  
  (: xVel Int)
  (= xVel (initnext 0 (prev xVel)))
  
  (: yVel Int)
  (= yVel (initnext 0 (prev yVel)))
    
  (on (& (> (prev xVel) -2) (& left (== (prev yVel) 0))) (= xVel (- (prev xVel) 1)))
  (on (& (< (prev xVel) 2) (& right (== (prev yVel) 0))) (= xVel (+ (prev xVel) 1)))
  
  (on (& (> (prev yVel) -2) (& up (== (prev xVel) 0))) (= yVel (- (prev yVel) 1)))
  (on (& (< (prev yVel) 2) (& down (== (prev xVel) 0))) (= yVel (+ (prev yVel) 1)))
  
  (on true (= blobs (updateObj blobs (--> obj (move obj (Position (sign (prev xVel)) (sign (prev yVel))))))))
)`)
      }
    
      function swapClick() {
        model_name = "swap";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 40)
  (= background "black")
  
  (object Blob (map (--> pos (Cell pos "mediumpurple")) (rect (Position 0 0) (Position 1 1))))
  (object Button (: color String) (Cell 0 0 color))
  
  (: button1 Button)
  (= button1 (initnext (Button "red" (Position 0 3)) (prev button1)))
  
  (: button2 Button)
  (= button2 (initnext (Button "gold" (Position 0 6)) (prev button2)))
  
  (: button3 Button)
  (= button3 (initnext (Button "green" (Position 0 9)) (prev button3)))
  
  (: button4 Button)
  (= button4 (initnext (Button "blue" (Position 0 12)) (prev button4)))
  
  (: button5 Button)
  (= button5 (initnext (Button "red" (Position (- GRID_SIZE 1) 3)) (prev button5)))
  
  (: button6 Button)
  (= button6 (initnext (Button "gold" (Position (- GRID_SIZE 1) 6)) (prev button6)))
  
  (: button7 Button)
  (= button7 (initnext (Button "green" (Position (- GRID_SIZE 1) 9)) (prev button7)))

  (: button8 Button)
  (= button8 (initnext (Button "blue" (Position (- GRID_SIZE 1) 12)) (prev button8)))
  
  (: swapButton Button)
  (= swapButton (initnext (Button "red" (Position (/ GRID_SIZE 2) 0)) (prev swapButton)))

  (: blob Blob)
  (= blob (initnext (Blob (Position (/ GRID_SIZE 2) (/ GRID_SIZE 2))) (prev blob)))  
  
  (: globalState String)
  (= globalState (initnext "none" (prev globalState)))
  
  (: swapState String)
  (= swapState (initnext 1 (prev swapState)))
  
  (on (== globalState "left") (= blob (moveLeftNoCollision blob)))
  (on (== globalState "right") (= blob (moveRightNoCollision blob)))
  (on (== globalState "up") (= blob (moveUpNoCollision blob)))
  (on (== globalState "down") (= blob (moveDownNoCollision blob)))
  
  (on (== globalState "left-up") (= blob (moveLeftNoCollision (moveUpNoCollision blob))))
  (on (== globalState "right-up") (= blob (moveRightNoCollision (moveUpNoCollision blob))))
  (on (== globalState "left-down") (= blob (moveLeftNoCollision (moveDownNoCollision blob))))
  (on (== globalState "right-down") (= blob (moveRightNoCollision (moveDownNoCollision blob))))

  (on (& (== swapState 1) (clicked button1)) (= globalState "left"))
  (on (& (== swapState 1) (clicked button2)) (= globalState "right"))
  (on (& (== swapState 1) (clicked button3)) (= globalState "up"))
  (on (& (== swapState 1) (clicked button4)) (= globalState "down"))
  
  (on (& (== swapState 2) (clicked button5)) (= globalState "left-up"))
  (on (& (== swapState 2) (clicked button6)) (= globalState "right-up"))
  (on (& (== swapState 2) (clicked button7)) (= globalState "left-down"))
  (on (& (== swapState 2) (clicked button8)) (= globalState "right-down"))
  
  (on (& (== (prev swapState) 1) (clicked swapButton)) 
    (let ((= swapState 2)
          (= globalState "left-up"))))
  
  (on (& (== (prev swapState) 2) (clicked swapButton)) 
    (let ((= swapState 1)
          (= globalState "left"))))

)`)
      }
      
      function disease2Click() {
        model_name = "disease_2";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 30)
  (= background "black")
  
  (object Hospital (map (--> pos (Cell pos "darkorange")) (rect (Position 0 0) (Position 5 5))))
  (object DiseasePool (: color String) (map (--> pos (Cell pos color)) (rect (Position 0 0) (Position 5 5))))
  (object Person (: active Bool) (: health Int) (Cell 0 0 "mediumpurple"))
  
  (: hospital Hospital)
  (= hospital (initnext (Hospital (Position 0 0)) (prev hospital)))
  
  (: diseasePool1 DiseasePool)
  (= diseasePool1 (initnext (DiseasePool "darkgreen" (Position (- GRID_SIZE 6) 6)) (prev diseasePool1)))

  (: diseasePool2 DiseasePool)
  (= diseasePool2 (initnext (DiseasePool "darkblue" (Position (- GRID_SIZE 6) 12)) (prev diseasePool2)))

  (: diseasePool3 DiseasePool)
  (= diseasePool3 (initnext (DiseasePool "darkkhaki" (Position (- GRID_SIZE 6) 18)) (prev diseasePool3)))

  (: diseasePool4 DiseasePool)
  (= diseasePool4 (initnext (DiseasePool "gray" (Position 0 (- GRID_SIZE 6))) (prev diseasePool4)))

  (: people (List Person))
  (= people (initnext (list (Person true 6 (Position 14 15)) (Person false 6 (Position 7 1)) (Person false 6 (Position 2 10)) (Person false 6 (Position 11 11))) (prev people)))

  (on left (= people (updateObj people (--> obj (move obj (* -1 (.. obj health)) 0)) (--> obj (.. obj active)))))
  (on right (= people (updateObj people (--> obj (move obj (* 1 (.. obj health)) 0)) (--> obj (.. obj active)))))
  (on up (= people (updateObj people (--> obj (move obj 0 (* -1 (.. obj health)))) (--> obj (.. obj active)))))
  (on down (= people (updateObj people (--> obj (move obj 0 (* 1 (.. obj health)))) (--> obj (.. obj active)))))

  (on (clicked people) (let ((= people (updateObj people (--> obj (updateObj obj "active" false)) (--> obj (!= obj (objClicked click people)))))
                              (= people (updateObj people (--> obj (updateObj obj "active" true)) (--> obj (== obj (objClicked click people))))))))

  (on (& clicked (isFree click)) (let ((= people (updateObj people (--> obj (updateObj obj "active" false))))
                                        (= people (addObj people (Person true 6 (Position (.. click x) (.. click y))))))))

  (on (intersects (prev people) (prev hospital)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 6)) (--> obj (intersects obj hospital)))))  

  (on (intersects (prev people) (prev diseasePool1)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 3)) (--> obj (& (intersects obj diseasePool1) (> (.. obj health) 3))))))  

  (on (intersects (prev people) (prev diseasePool2)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 2)) (--> obj (& (intersects obj diseasePool2) (> (.. obj health) 2))))))  

  (on (intersects (prev people) (prev diseasePool3)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 1)) (--> obj (& (intersects obj diseasePool3) (> (.. obj health) 1))))))  

  (on (intersects (prev people) (prev diseasePool4)) 
    (= people (updateObj people (--> obj (updateObj obj "health" 0)) (--> obj (intersects obj diseasePool4)))))  
)`)
      }
    
      function bulletsClick() {
        model_name = "bullets";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (object Particle (Cell 0 0 "blue"))
  (object Bullet (: dir String) (Cell 0 0 "red"))
  
  (: particle Particle)
  (= particle (initnext (Particle (Position 8 8)) (prev particle)))
  
  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: dir String)
  (= dir (initnext "none" (prev dir)))
  
  (on true (= bullets (updateObj bullets (--> obj (moveLeft obj)) (--> obj (== (.. obj dir) "left")))))
  (on true (= bullets (updateObj bullets (--> obj (moveRight obj)) (--> obj (== (.. obj dir) "right")))))
  (on true (= bullets (updateObj bullets (--> obj (moveUp obj)) (--> obj (== (.. obj dir) "up")))))
  (on true (= bullets (updateObj bullets (--> obj (moveDown obj)) (--> obj (== (.. obj dir) "down")))))
  
  (on left (let ((= dir "left")
                (= particle (moveLeft particle)))))
  (on right (let ((= dir "right")
                  (= particle (moveRight particle)))))
  (on up (let ((= dir "up")
              (= particle (moveUp particle)))))
  (on down (let ((= dir "down")
                (= particle (moveDown particle)))))
  
  
  (on (& clicked (== dir "left")) (= bullets (addObj bullets (Bullet "left" (.. (moveLeft particle) origin)))))
  (on (& clicked (== dir "right")) (= bullets (addObj bullets (Bullet "right" (.. (moveRight particle) origin)))))
  (on (& clicked (== dir "up")) (= bullets (addObj bullets (Bullet "up" (.. (moveUp particle) origin)))))
  (on (& clicked (== dir "down")) (= bullets (addObj bullets (Bullet "down" (.. (moveDown particle) origin)))))
)`)
      }
    
      function levelsClick() {
        model_name = "levels";
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 40)
  (= background "black")
  
  (object Floor (map (--> pos (Cell pos "skyblue")) (rect (Position 0 0) (Position 35 0))))
  (object Agent (Cell 0 0 "red"))
  (object Stair (: color String) (list (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) (Cell 3 0 color) (Cell 4 0 color) 
                                                (Cell 1 -1 color) (Cell 2 -1 color) (Cell 3 -1 color) (Cell 4 -1 color)
                                                          (Cell 2 -2 color) (Cell 3 -2 color) (Cell 4 -2 color)
                                                                  (Cell 3 -3 color) (Cell 4 -3 color)
                ))
  
  (object ReverseStair (: color String) (list (Cell 0 0 color) (Cell 1 0 color) (Cell 2 0 color) (Cell 3 0 color) (Cell 4 0 color) 
                                            (Cell 0 -1 color) (Cell 1 -1 color) (Cell 2 -1 color) (Cell 3 -1 color)
                                              (Cell 0 -2 color) (Cell 1 -2 color) (Cell 2 -2 color)
                                              (Cell 0 -3 color) (Cell 1 -3 color)
                ))
  
  (object Barrier (map (--> pos (Cell pos "blue")) (rect (Position 0 -1) (Position 0 1))))
  (object Barrier2 (map (--> pos (Cell pos "rebeccapurple")) (rect (Position 0 -1) (Position 0 1))))
  (object Bullet (: color String) (: dir String) (map (--> pos (Cell pos "mediumpurple")) (rect (Position -1 -1) (Position 1 0))))
  (object Ammo (Cell 0 0 "gold"))
  (object Goal (: color String) (map (--> pos (Cell pos color)) (rect (Position 0 0) (Position 3 3))))
    
  (: goal Goal)
  (= goal (initnext (Goal "darkorange" (Position 0 0)) (prev goal)))
  
  (: agent Agent)
  (= agent (initnext (Agent (Position 19 39)) (prev agent)))

  (: walls (List Wall))
  (= walls (initnext (list (Floor (Position 0 36)) 
                            (Floor (Position 4 32))
                            (Floor (Position 0 28))
                            (Floor (Position 4 24))
                            (Floor (Position 0 20))
                            (Floor (Position 4 16))
                            (Floor (Position 0 12))
                            (Floor (Position 4 8)) 
                            (Floor (Position 0 4))) 
                      (prev walls)))
  
  (: stairs (List Stair))
  (= stairs (initnext (list (Stair "green" (Position 35 39)) 
                            (Stair "green" (Position 35 31))
                            (Stair "green" (Position 35 23))
                            (Stair "green" (Position 35 15))
                            (Stair "green" (Position 35 7))) 
                    (prev stairs)))
  
  (: reverseStairs (List ReverseStair))
  (= reverseStairs (initnext (list (ReverseStair "green" (Position 0 35)) 
                                    (ReverseStair "green" (Position 0 27))
                                    (ReverseStair "green" (Position 0 19))
                                    (ReverseStair "green" (Position 0 11))
                                    ) 
                    (prev reverseStairs)))
  
  (: bullets (List Bullet))
  (= bullets (initnext (list) (prev bullets)))
  
  (: barriers (List Barrier))
  (= barriers (initnext (list (Barrier (Position 6  38))
                              (Barrier (Position 33 38)) (Barrier (Position 31 38))
                              (Barrier (Position 33 30)) (Barrier (Position 31 30)) (Barrier (Position 29 30))
                              (Barrier (Position 33 22)) (Barrier (Position 31 22)) (Barrier (Position 29 22)) (Barrier (Position 27 22)) (Barrier (Position 25 22))
                              (Barrier (Position 33 14)) (Barrier (Position 31 14)) (Barrier (Position 29 14)) (Barrier (Position 27 14)) (Barrier (Position 25 14)) (Barrier (Position 23 14)) (Barrier (Position 21 14))
                              (Barrier (Position 33 6))  (Barrier (Position 31 6))  (Barrier (Position 29 6))  (Barrier (Position 27 6))  (Barrier (Position 25 6))  (Barrier (Position 23 6))  (Barrier (Position 21 6))  (Barrier (Position 19 6)) (Barrier (Position 17 6))
                          
                              (Barrier (Position 6 34)) (Barrier (Position 8 34))
                              (Barrier (Position 6 26)) (Barrier (Position 8 26)) (Barrier (Position 10 26)) (Barrier (Position 12 26))
                              (Barrier (Position 6 18)) (Barrier (Position 8 18)) (Barrier (Position 10 18)) (Barrier (Position 12 18)) (Barrier (Position 14 18)) (Barrier (Position 16 18)) 
                              (Barrier (Position 6 10)) (Barrier (Position 8 10)) (Barrier (Position 10 10)) (Barrier (Position 12 10)) (Barrier (Position 14 10)) (Barrier (Position 16 10)) (Barrier (Position 18 10)) (Barrier (Position 20 10))
                              (Barrier (Position 6 2))   (Barrier (Position 8 2)) (Barrier (Position 10 2))  (Barrier (Position 12 2))   (Barrier (Position 14 2))   (Barrier (Position 16 2))   (Barrier (Position 18 2))   (Barrier (Position 20 2))   (Barrier (Position 22 2))   (Barrier (Position 24 2))
                              
                        ) 
                    (prev barriers)))
  
  (: barriers2 (List Barrier2))
  (= barriers2 (initnext (list (Barrier2 (Position 34 38)) (Barrier2 (Position 5 38))
                                (Barrier2 (Position 34 30)) 
                                (Barrier2 (Position 34 22)) 
                                (Barrier2 (Position 34 14)) 
                                (Barrier2 (Position 34 6))  
                          
                                (Barrier2 (Position 5 34)) 
                                (Barrier2 (Position 5 26)) 
                                (Barrier2 (Position 5 18)) 
                                (Barrier2 (Position 5 10)) 
                                (Barrier2 (Position 5 2))                                
                        ) 
                    (prev barriers2)))
  
  (: ammo (List Ammo))
  (= ammo (initnext (list (Ammo (Position 4 39)) (Ammo (Position 2 39)) (Ammo (Position 14 39))
                          (Ammo (Position 35 35)) (Ammo (Position 34 34))
                          (Ammo (Position 4 31)) (Ammo (Position 5 30)) (Ammo (Position 6 31))
                          (Ammo (Position 35 27)) (Ammo (Position 34 26)) (Ammo (Position 33 27)) (Ammo (Position 32 26))
                          (Ammo (Position 4 23)) (Ammo (Position 5 22)) (Ammo (Position 6 23)) (Ammo (Position 7 22)) (Ammo (Position 8 23))
                          (Ammo (Position 35 19)) (Ammo (Position 34 18)) (Ammo (Position 33 19)) (Ammo (Position 32 18)) (Ammo (Position 31 19)) (Ammo (Position 30 18))
                          (Ammo (Position 4 15)) (Ammo (Position 5 14)) (Ammo (Position 6 15)) (Ammo (Position 7 14)) (Ammo (Position 8 15)) (Ammo (Position 9 14)) (Ammo (Position 10 15))
                          (Ammo (Position 35 11)) (Ammo (Position 34 10)) (Ammo (Position 33 11)) (Ammo (Position 32 10)) (Ammo (Position 31 11)) (Ammo (Position 30 10)) (Ammo (Position 29 11)) (Ammo (Position 28 10))
                          (Ammo (Position 4 7)) (Ammo (Position 5 6)) (Ammo (Position 6 7)) (Ammo (Position 7 6)) (Ammo (Position 8 7)) (Ammo (Position 9 6)) (Ammo (Position 10 7)) (Ammo (Position 11 6)) (Ammo (Position 12 7))
                          (Ammo (Position 35 3)) (Ammo (Position 34 2)) (Ammo (Position 33 3)) (Ammo (Position 32 2)) (Ammo (Position 31 3)) (Ammo (Position 30 2)) (Ammo (Position 29 3)) (Ammo (Position 28 2)) (Ammo (Position 27 3)) (Ammo (Position 26 2))

                    
                    ) (prev ammo)))
  
  (: numBullets Int)
  (= numBullets (initnext 0 (prev numBullets)))

  (: bulletDir String)
  (= bulletDir (initnext "left" (prev bulletDir)))
  
  (on true (= bullets (updateObj bullets (--> obj (moveLeft (prev obj))) (--> obj (== (.. (prev obj) dir) "left")))))
  (on true (= bullets (updateObj bullets (--> obj (moveRight (prev obj))) (--> obj (== (.. (prev obj) dir) "right")))))

  (on true (= agent (moveDownNoCollision (prev agent))))
  (on left (= agent (moveLeftNoCollision (prev agent))))
  (on right (= agent (moveRightNoCollision (prev agent))))
  (on (& up (== (.. (prev agent) origin) (.. (moveDownNoCollision (prev agent)) origin))) (= agent (move (prev agent) 0 -2)))

  (on (& left (intersects (moveLeft (prev agent)) (prev ammo))) (= agent (moveLeft (prev agent))))
  (on (& right (intersects (moveRight (prev agent)) (prev ammo))) (= agent (moveRight (prev agent))))
  (on (& up (intersects (moveUp (prev agent)) (prev ammo))) (= agent (moveUp (prev agent))))

  
  (on left (= bulletDir "left"))
  (on right (= bulletDir "right"))
  
  (on (intersects (prev agent) (prev ammo)) 
      (let ((= ammo (removeObj ammo (--> obj (intersects (prev obj) (prev agent)))))
            (= numBullets (+ (prev numBullets) 1))
            )))
  
  (on (& clicked (> (prev numBullets) 0))
      (let ((= bullets (addObj bullets (Bullet "mediumpurple" (prev bulletDir) (.. (move (prev agent) (if (== (prev bulletDir) "left") then -1 else 1) 0) origin))))
            (= numBullets (- (prev numBullets) 1)))))
  
  (on (intersects (prev bullets) (prev barriers)) 
      (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev barriers)))))
            (= barriers (removeObj barriers (--> obj (intersects (prev obj) (prev bullets))))))))

  (on clicked (= barriers2 (updateObj barriers2 (--> obj (removeObj (prev obj))) (--> obj (! (intersects (prev barriers) (adjacentObjs (prev obj))))))))
  (on (intersects (moveLeft (prev agent)) (prev goal)) (= goal (updateObj (prev goal) "color" "lightgreen")))
)`)
      }
    
      function jumpClick() {
        myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  (= background "black")
  
  (object Jumper (map (--> pos (Cell pos "red")) (rect (Position 0 0) (Position 1 1))))
  (object Stop (: gold Bool) (list (Cell 0 0 (if gold then "gold" else "blue")) (Cell 1 0 (if gold then "gold" else "blue"))))
  
  
  (: jumper Jumper)
  (= jumper (initnext (Jumper (Position 0 (- GRID_SIZE 2))) (moveDownNoCollision (prev jumper))))

  (: stop Stop)
  (= stop (initnext (Stop false (Position (- (/ GRID_SIZE 2) 1) 2)) (prev stop)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))

  (: energy Int)
  (= energy (initnext 0 (prev energy)))
  
  (on left (= jumper (moveLeftNoCollision (prev jumper))))
  (on right (= jumper (moveRightNoCollision (prev jumper))))
  
  (on (& (== (% time 10) 0) (& (<= (prev energy) 10) (== (.. (.. (prev jumper) origin) y) (- GRID_SIZE 2))))
      (= energy (+ energy 1)))

  (on clicked (let ((= jumper (move (prev jumper) 0 (* -1 energy))) 
                    (= energy 0))))
  
  (on (intersects (prev jumper) (adjacentObjs (prev stop))) 
      (= stop (updateObj stop "gold" (! (.. stop gold)))))  
)`)
      }

function foragingClick() {
  myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)
  
  (object Ant (Cell 0 0 "gray"))
  (object Food (: neighbors Int) (Cell 0 0 "green"))
  (object Button (: color String) (Cell 0 0 color))
  
  (: ants (List Ant))
  (= ants (initnext (list (Ant (Position 5 5)) (Ant (Position 1 14)) (Ant (Position 13 3)) (Ant (Position 9 8)))  (prev ants)))
  
  (: foods (List Food))
  (= foods (initnext (map (--> pos (Food 3 pos)) (rect (Position 11 11) (Position 12 12))) (prev foods)))
  
  (: antButton Button)
  (= antButton (initnext (Button "dimgray" (Position 5 0)) (prev antButton)))
  
  (: foodButton Button)
  (= foodButton (initnext (Button "darkgreen" (Position 9 0)) (prev foodButton)))  
  
  (: active String)
  (= active (initnext "food" (prev active)))
  
  (on true (= ants (updateObj ants (--> obj (uniformChoice (list (moveLeftNoCollision (prev obj)) (moveRightNoCollision (prev obj)) (moveUpNoCollision (prev obj)) (moveDownNoCollision (prev obj))))))))
  (on true (= ants (updateObj ants (--> obj (move (prev obj) (unitVector (prev obj) (closest (prev obj) Food)))) (--> obj (adj (prev obj) (filter (--> obj2 (> (.. obj2 neighbors) 0)) (prev foods)) 1)))))

  (on true (= foods (updateObj foods (--> obj (removeObj (prev obj))) (--> obj (& (> (.. obj neighbors) 0) (intersects (prev obj) (prev ants)))))))

  (on (& (& clicked (isFree click)) (== active "ant")) (= ants (addObj ants (Ant (Position (.. click x) (.. click y))))))

  (on (clicked foodButton) (= active "food"))
  (on (clicked antButton) (= active "ant"))
  
  (on true (= foods (updateObj 
                      foods 
                      (--> obj (updateObj obj "neighbors" (length (intersect (filter (--> obj2 (.. obj2 alive)) foods) (adjacentObjsDiag obj))))) 
					  (--> obj (>= (.. obj neighbors) 0)))))
  (on true (= foods (updateObj 
                      foods 
                      (--> obj (updateObj obj "neighbors" (- (.. obj neighbors) 1))) 
					  (--> obj (<= (.. obj neighbors) 0))
                      )))
  
  (on (& true (> (length (filter (--> obj (& (.. obj alive) (<= (.. obj neighbors) -20))) foods)) 0)) (= foods (addObj foods (map (--> pos (Food 3 pos)) (uniformChoice (adjPositions (.. (first (filter (--> obj (& (.. obj alive) (<= (.. obj neighbors) -20))) foods) ) origin)) (uniformChoice (list 1 2 3 4))  )))))
  (on (> (length (filter (--> obj (& (.. obj alive) (<= (.. obj neighbors) -20))) foods)) 0) (= foods (updateObj foods (--> obj (updateObj obj "neighbors" (length (intersect (filter (--> obj (.. obj alive)) foods) (adjacentObjsDiag obj)))) ) (--> obj (== (.. (first (filter (--> obj2 (& (.. obj2 alive) (<= (.. obj2 neighbors) -20))) foods)) id) (.. obj id)) ) )))
  
  (on (& (& clicked (isFree click)) (== active "food")) (= foods (addObj foods (map (--> pos (Food 3 pos)) (rect (Position (.. click x) (.. click y)) (move (Position (.. click x) (.. click y)) (Position 1 1)))))))

)`);
}

function spiderClick() {
  myCodeMirror.setValue(`(program
  (= GRID_SIZE 17)
  (= background "skyblue")
  (object Web (Cell 0 0 "white"))
  (object Spider (Cell 0 0 "green"))
  (object Fly (Cell 0 0 "black"))
  (object StuckFly (Cell 0 0 "brown"))
  (object DeadFly (Cell 0 0 "white"))
  (object Button (: color String) (Cell 0 0 color))
  
  (: web (List Web))
  (= web (initnext (map (--> obj (move obj (Position 6 -6))) (list (Web (Position 8 8))
                         (Web (Position 8 7))
                         (Web (Position 8 6))
                         (Web (Position 8 9))                     
                         (Web (Position 8 10))
						 
                     	 (Web (Position 6 8))
                         (Web (Position 6 7))
                         (Web (Position 6 6))
                         (Web (Position 6 9))                     
                         (Web (Position 6 10))                     
                     
                         (Web (Position 10 8))
                         (Web (Position 10 7))
                         (Web (Position 10 6))
                         (Web (Position 10 9))                     
                         (Web (Position 10 10)) 
                     
                         (Web (Position 7 8))
                         (Web (Position 9 8))                     
						 
                         (Web (Position 7 6))
                         (Web (Position 9 6))                     
                     
                         (Web (Position 7 10))
                         (Web (Position 9 10))
                                          
                         (Web (Position 7 11))
                         (Web (Position 7 12))
                         (Web (Position 8 12))                     
                         (Web (Position 9 12))
                         (Web (Position 9 11))
                     
                         (Web (Position 5 7))
                         (Web (Position 4 7))
                         (Web (Position 4 8))                     
                         (Web (Position 4 9))
                         (Web (Position 5 9))

                         (Web (Position 10 12))
                         (Web (Position 9 13))
                         (Web (Position 9 14))                     
                         (Web (Position 10 14))
                         (Web (Position 10 15))

                         (Web (Position 4 6))
                         (Web (Position 3 7))
                         (Web (Position 2 7))                     
                         (Web (Position 2 6))
                         (Web (Position 1 6))

                                                               

                   ) )(prev web)))
  
  (: flies (List Fly))
  (= flies (initnext (list (Fly (Position 4 4)) (Fly (Position 14 14)) (Fly (Position 4 14)) (Fly (Position 10 10)) (Fly (Position 7 14))) (prev flies)))

  (: stuckFlies (List StuckFly))
  (= stuckFlies (initnext (list) (prev stuckFlies)))

  (: deadFlies (List DeadFly))
  (= deadFlies (initnext (list) (prev deadFlies)))
  
  (: spider Spider)
  (= spider (initnext (Spider (Position 12 4)) (prev spider)))
  
  (: flyButton Button)
  (= flyButton (initnext (Button "black" (Position 6 16)) (prev flyButton)))
  
  (: webButton Button)
  (= webButton (initnext (Button "white" (Position 10 16)) (prev webButton)))

  (: active String)
  (= active (initnext "fly" (prev active)))
  
  (: time Int)
  (= time (initnext 0 (+ (prev time) 1)))
  
  (on true (= flies (updateObj flies (--> obj (uniformChoice (list (moveLeft (prev obj)) (moveRight (prev obj)) (moveUp (prev obj)) (moveDown (prev obj))))) (--> obj (! (intersects (prev obj) (prev web)))))))
  (on true (= flies (updateObj flies (--> obj (prev obj)) (--> obj (! (isWithinBounds obj))))))  
  (on true (= stuckFlies (updateObj stuckFlies (--> obj (move (prev obj) (Position 
                                                                  (* (.. (unitVector (prev obj) (closest (prev obj) Spider)) x) -1)
                                                                  (* (.. (unitVector (prev obj) (closest (prev obj) Spider)) y) -1)
                                                               ))) 
                                     (--> obj (& (== (/ (prev time) 2) 0) (intersects (prev obj) (prev web)))))))    
  (on true (= stuckFlies (updateObj stuckFlies (--> obj (prev obj)) (--> obj (! (intersects obj (prev web)))))))

  (on (intersects (prev flies) (prev web)) (let ((= flies (removeObj flies (--> obj (intersects (prev obj) (prev web)))))
                                                 (= stuckFlies (addObj stuckFlies (map (--> obj2 (StuckFly (.. obj2 origin))) (filter (--> obj (intersects (prev obj) (prev web))) (prev flies)) )))
                                                 )))
  (on true (= stuckFlies (removeObj stuckFlies (--> obj (intersects (prev obj) (prev spider))))))
  (on (intersects (prev stuckFlies) (prev web)) (= spider (move spider (unitVector (prev spider) (closest (prev spider) StuckFly)))))
  (on (! (intersects spider (prev web))) (= spider (move spider (unitVector spider (closest spider Web)))))
  (on (& (intersects (prev stuckFlies) (prev web)) (== (.. spider origin) (.. (prev spider) origin))) (= spider (move (prev spider) (displacement (.. (prev spider) origin) (uniformChoice (intersect (map (--> obj (.. obj origin)) (prev web)) (adjPositionsDiag (.. (prev spider) origin))))))))                                                     


  (on (clicked flyButton) (= active "fly"))                                                      
  (on (clicked webButton) (= active "web"))                                                      
                                                      
  (on (& (& clicked (isFree click)) (== (prev active) "fly")) (= flies (addObj flies (Fly (Position (.. click x) (.. click y)))))) 
  (on (& (& clicked (isFree click)) (== (prev active) "web")) (= web (addObj web (Web (Position (.. click x) (.. click y)))))) 

)`);
}

function river1Click() {
  myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Sand (vcat (map (--> pos (Cell pos "sandybrown")) (vcat (rect (Position 0 0) (Position 2 15)) (rect (Position 13 0) (Position 15 15))))))
  (object SlowWater (map (--> pos (Cell pos "blue")) (vcat (rect (Position 3 0) (Position 5 15)) (rect (Position 10 0) (Position 12 15))) ))
  (object FastWater (map (--> pos (Cell pos "darkblue")) (rect (Position 6 0) (Position 9 15))))
  (object LightRock (Cell 0 0 "gray"))
  (object HeavyRock (Cell 0 0 "black"))
  (object Agent (Cell 0 0 "maroon"))

  (: sand Sand)
  (= sand (initnext (Sand (Position 0 0)) sand))

  (: slowWater SlowWater)
  (= slowWater (initnext (SlowWater (Position 0 0)) slowWater))

  (: fastWater FastWater)
  (= fastWater (initnext (FastWater (Position 0 0)) fastWater))

  (: lightRock (List LightRock))
  (= lightRock (initnext 
                 (map (--> pos (LightRock pos)) 
                   (list)) 
                 lightRock))

  (: heavyRock (List HeavyRock))
  (= heavyRock (initnext 
                 (map (--> pos (HeavyRock pos))
                   (list (Position 1 8)
                         (Position 1 6)
                         (Position 2 5)
                         (Position 2 9)
                         (Position 2 7)
                         (Position 14 8)
                         (Position 14 6)
                         (Position 13 5)
                         (Position 13 9)
                         (Position 13 7)
                   )) 
                 heavyRock))

  (: agent Agent)
  (= agent (initnext (Agent (Position 0 0)) (prev agent)))
  
  (: time Int)
  (= time (initnext 0 (+ 1 (prev time))))

  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) left) (= agent (moveLeft agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) right) (= agent (moveRight agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) up) (= agent (moveUp agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) down) (= agent (moveDown agent)))

  (on (& (intersects (prev agent) slowWater) (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) ) (= agent (moveDown (prev agent))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) left)) (= agent (moveDown (moveLeft (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) right)) (= agent (moveDown (moveRight (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) up)) (= agent (moveDown (moveUp (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (& (intersects (prev agent) slowWater) down))) (= agent (moveDown (moveDown (prev agent)))))

  (on (& (intersects (prev agent) fastWater) (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock)))) (= agent (moveDown (moveDown (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) left)) (= agent (moveDown (moveDown (moveLeft (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) right)) (= agent (moveDown (moveDown (moveRight (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) up)) (= agent (moveDown (moveDown (moveUp (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (& (intersects (prev agent) fastWater) down))) (= agent (moveDown (moveDown (moveDown (prev agent))))))

  
  (on true (= lightRock (updateObj lightRock (--> obj (moveLeft (prev obj))) (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveRight (prev obj))) (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveUp (prev obj))) (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveDown (prev obj))) (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveDown (prev obj))) (--> obj (& (! (intersects (prev obj) (prev heavyRock))) (intersects (prev obj) fastWater))))))

  (on true (= heavyRock (updateObj heavyRock (--> obj (moveLeft (prev obj))) (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveRight (prev obj))) (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveUp (prev obj))) (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveDown (prev obj))) (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))))))            

  (on (> (+ (length (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock))) 1)
      (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock))) id)))))
            (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock))) id)))))
    	    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock))) id)))))
    	    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (intersects (prev obj) sand)) (intersects (moveDown (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock))) id)))))
  		    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (intersects (prev obj) sand)) (intersects (moveDown (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (& (<= (.. (.. agent origin) y) 15) (! (isWithinBounds agent))) (= agent (prev agent)))

  (on (& (! (clicked agent)) (& (& (! (clicked heavyRock)) (! (clicked lightRock))) (| false (clicked sand)))) (= heavyRock (addObj heavyRock (HeavyRock (Position (.. click x) (.. click y))))))
)`);
}

function river2Click() {
  myCodeMirror.setValue(`(program
  (= GRID_SIZE 16)

  (object Sand (vcat (map (--> pos (Cell pos "sandybrown")) (vcat (rect (Position 0 0) (Position 2 15)) (rect (Position 13 0) (Position 15 15))))))
  (object SlowWater (map (--> pos (Cell pos "blue")) (vcat (rect (Position 3 0) (Position 5 15)) (rect (Position 10 0) (Position 12 15))) ))
  (object FastWater (map (--> pos (Cell pos "darkblue")) (rect (Position 6 0) (Position 9 15))))
  (object LightRock (Cell 0 0 "gray"))
  (object HeavyRock (Cell 0 0 "black"))
  (object Agent (Cell 0 0 "maroon"))

  (: sand Sand)
  (= sand (initnext (Sand (Position 0 0)) sand))

  (: slowWater SlowWater)
  (= slowWater (initnext (SlowWater (Position 0 0)) slowWater))

  (: fastWater FastWater)
  (= fastWater (initnext (FastWater (Position 0 0)) fastWater))

  (: lightRock (List LightRock))
  (= lightRock (initnext 
                 (map (--> pos (LightRock pos)) 
                   (list (Position 1 12) 
                         (Position 1 10) 
                         (Position 1 14) 
                         (Position 2 13) 
                         (Position 2 11)))
                 lightRock))

  (: heavyRock (List HeavyRock))
  (= heavyRock (initnext 
                 (map (--> pos (HeavyRock pos))
                   (list (Position 1 8)
                         (Position 1 6)
                         (Position 2 5)
                         (Position 2 9)
                         (Position 2 7)
                         (Position 14 8)
                         (Position 14 6)
                         (Position 13 5)
                         (Position 13 9)
                         (Position 13 7)
                   )) 
                 heavyRock))

  (: agent Agent)
  (= agent (initnext (Agent (Position 0 0)) (prev agent)))
  
  (: time Int)
  (= time (initnext 0 (+ 1 (prev time))))

  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) left) (= agent (moveLeft agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) right) (= agent (moveRight agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) up) (= agent (moveUp agent)))
  (on (& (| (| (intersects agent heavyRock) (intersects agent lightRock)) (intersects agent sand)) down) (= agent (moveDown agent)))

  (on (& (intersects (prev agent) slowWater) (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) ) (= agent (moveDown (prev agent))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) left)) (= agent (moveDown (moveLeft (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) right)) (= agent (moveDown (moveRight (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) slowWater)) up)) (= agent (moveDown (moveUp (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (& (intersects (prev agent) slowWater) down))) (= agent (moveDown (moveDown (prev agent)))))

  (on (& (intersects (prev agent) fastWater) (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock)))) (= agent (moveDown (moveDown (prev agent)))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) left)) (= agent (moveDown (moveDown (moveLeft (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) right)) (= agent (moveDown (moveDown (moveRight (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (intersects (prev agent) fastWater)) up)) (= agent (moveDown (moveDown (moveUp (prev agent))))))
  (on (& (== (% (prev time) 1) 0) (& (& (! (intersects (prev agent) heavyRock)) (! (intersects (prev agent) lightRock))) (& (intersects (prev agent) fastWater) down))) (= agent (moveDown (moveDown (moveDown (prev agent))))))

  
  (on true (= lightRock (updateObj lightRock (--> obj (moveLeft (prev obj))) (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveRight (prev obj))) (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveUp (prev obj))) (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveDown (prev obj))) (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))))))            
  (on true (= lightRock (updateObj lightRock (--> obj (moveDown (prev obj))) (--> obj (& (! (intersects (prev obj) (prev heavyRock))) (intersects (prev obj) fastWater))))))

  (on true (= heavyRock (updateObj heavyRock (--> obj (moveLeft (prev obj))) (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveRight (prev obj))) (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveUp (prev obj))) (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))))))            
  (on true (= heavyRock (updateObj heavyRock (--> obj (moveDown (prev obj))) (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))))))            

  (on (> (+ (length (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock))) 1)
      (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock))) id)))))
            (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& left (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveLeft (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock))) id)))))
    	    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& right (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveRight (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock))) id)))))
    	    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& up (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveUp (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (> (+ (length (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock)) (length (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (| (intersects (prev obj) (prev heavyRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) lightRock))) 1)
	  (let ((= heavyRock (updateObj heavyRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (intersects (prev obj) sand)) (intersects (moveDown (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock))) id)))))
  		    (= lightRock (updateObj lightRock (--> obj (prev obj)) (--> obj (== (.. obj id) (.. (last (vcat (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev lightRock))) (intersects (prev obj) sand)) (intersects (moveDown (prev agent)) (prev obj))))) lightRock) (filter (--> obj (& down (& (| (intersects (prev obj) (filter (--> obj2 (!= (.. obj id) (.. obj2 id))) (prev heavyRock))) (| (intersects (prev obj) (prev lightRock)) (intersects (prev obj) sand))) (intersects (moveDown (prev agent)) (prev obj))))) heavyRock))) id))))))))

  (on (& (<= (.. (.. agent origin) y) 15) (! (isWithinBounds agent))) (= agent (prev agent)))

  (on (& (! (clicked agent)) (& (& (! (clicked heavyRock)) (! (clicked lightRock))) (| false (clicked sand)))) (= heavyRock (addObj heavyRock (HeavyRock (Position (.. click x) (.. click y))))))
)`);
}

    
      function toggleClick() {
        div = document.getElementById("button-div")
        if (div.style.display == "none") {
          div.style.display = "block";
        } else {
          div.style.display = "none";
        }
      }
    
      function toggle2Click() {
        div1 = document.getElementById("model-input");
        div2 = document.getElementById("grid-view");
        if (div1.style.width == "0%") { // split mode
          div1.style.width = "50%";
          div2.style.width = "50%";
        } else { // full screen mode
          div1.style.width = "0%";
          div2.style.width = "100%";
        }

        if (window.innerHeight < 900) {
          cell_size = 25;
        } else {
          cell_size = 35;
        }
      }

      function randomClick() {
    
        console.log("randomClick")
        var xhr = new XMLHttpRequest(); 
        xhr.open("GET", host + '/random', true);
    
        //Send the proper header information along with the request
        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === 4 && this.status === 200) {
            content = JSON.parse(xhr.response)[0];
            console.log("content: "+content);
            myCodeMirror.setValue(content);
            compileClick();
          }
        };
        xhr.send();
      }
    
      function randomClick2() {
        console.log("randomClick2")
        var xhr = new XMLHttpRequest(); 
        xhr.open("GET", host + '/random2', true);
    
        //Send the proper header information along with the request
        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === 4 && this.status === 200) {
            content = JSON.parse(xhr.response)[0];
            console.log("content: "+content);
            myCodeMirror.setValue(content);
            compileClick();
          }
        };
        xhr.send();
      }
    
      function randomClick3() {
        console.log("randomClick3")
        var xhr = new XMLHttpRequest(); 
        xhr.open("GET", host + '/random3', true);
    
        //Send the proper header information along with the request
        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === 4 && this.status === 200) {
            content = JSON.parse(xhr.response)[0];
            console.log("content: "+content);
            myCodeMirror.setValue(content);
            compileClick();
          }
        };
        xhr.send();
      }
    
      function synthesizeClick() {
        console.log("synthesize")
        var xhr = new XMLHttpRequest(); 
        xhr.open("GET", host + '/synthesize?clientid='+client_id, true);
    
        //Send the proper header information along with the request
        xhr.onreadystatechange = function () { // Call a function when the state changes.
          if (this.readyState === 4 && this.status === 200) {
            document.getElementById("synthesize-button").innerHTML = "SYNTHESIZE";
            compileClick();
            content = JSON.parse(xhr.response)[0];
            console.log("content: "+content);
            myCodeMirror.setValue(content);
          }
        };
        document.getElementById("synthesize-button").innerHTML = "SYNTHESIZING...";
        xhr.send();
    
      }

      // import { parseau } from "{{ url_for('static', filename='js/sexpr.js')}}";
      // a = parseau("(hello there)");


      // sexpr.js 

      // var parse = require('s-expression');
      // import { SParse as parse } from "../node_modules/s-expression/index.js";
      // module.exports = { parseau };
      // export { parseau };

      // Construct Autumn Expression (AExpr) from program string
      function parseau(program_str) {
        var cleaned_sexpr = remove_comments(SParse(program_str));
        var aexpr = s_to_a(cleaned_sexpr); 
        return aexpr;
      }

      function remove_comments(sexpr) {
        let new_sexpr = [];
        for (arg of sexpr) {
          if (Array.isArray(arg)) {
            if (arg.length != 0) {
              if (arg[0] != "%%") {
                new_sexpr.push(remove_comments(arg));
              }
            } else {
              new_sexpr.push(arg);
            }
          } else {
            new_sexpr.push(arg);
          }
        }
        return new_sexpr;
      }

      // Convert S-Expression (SExpr) to Autumn Expression (AExpr)
      function s_to_a(sexpr) {
        if (Array.isArray(sexpr)) { 
          if (sexpr[0] == "program") {
            return {"head" : "program", "args" : sexpr.slice(1).map(line => s_to_a(line))};
          } else if (sexpr[0] == "%%") {
            return {"head" : "%%", "args": []};
          } else if (sexpr[0] == "if") {
            return {"head" : "if", "args" : [s_to_a(sexpr[1]), s_to_a(sexpr[3]), s_to_a(sexpr[5])]};
          } else if (sexpr[0] == "initnext") {
            return {"head" : "initnext", "args" : [s_to_a(sexpr[1]), s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "=") {
            return {"head" : "assign", "args" : [sexpr[1], s_to_a(sexpr[2])]};
          } else if (sexpr[0] == ":") {
            return {"head" : "typedecl", "args" : [sexpr[1], s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "let") {
            return {"head" : "let", "args" : sexpr[1].map(line => s_to_a(line))};
          } else if (sexpr[0] == "fn") {
            return {"head" : "fn", "args" : [{"head" : "list", "args" : sexpr[1]}, s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "-->") {
            return {"head" : "lambda", "args" : [s_to_a(sexpr[1]), s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "..") {
            return {"head" : "field", "args" : [s_to_a(sexpr[1]), s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "list") {
            return {"head" : "list", "args" : sexpr.slice(1).map(elt => s_to_a(elt))};
          } else if (sexpr[0] == "on") {
            return {"head" : "on", "args" : [s_to_a(sexpr[1]), s_to_a(sexpr[2])]};
          } else if (sexpr[0] == "object") {
            return {"head" : "object", "args" : sexpr.slice(1).map(elt => s_to_a(elt))};
          } else if (sexpr.length > 1) {
            return {"head" : "call", "args" : [s_to_a(sexpr[0]), sexpr.slice(1).map(s => s_to_a(s))]};
          } else {
            return {"head" : "list", "args" : sexpr.slice(1).map(elt => s_to_a(elt))};
          } 
        } else if (!isNaN(sexpr)) {
          return parseInt(sexpr);
        } else if (typeof(sexpr) == "string") {
          return sexpr;
        } else {
          return {"str" : sexpr.valueOf()};
        }
      }

      function SParser(stream) {
        this._line = this._col = this._pos = 0;
        this._stream = stream;
      }

      SParser.not_whitespace_or_end = /^(\S|$)/;
      SParser.space_quote_paren_escaped_or_end = /^(\s|\\|"|'|`|,|\(|\)|$)/;
      SParser.string_or_escaped_or_end = /^(\\|"|$)/;
      SParser.string_delimiters = /["]/;
      SParser.quotes = /['`,]/;
      SParser.quotes_map = {
        '\'': 'quote',
        '`':  'quasiquote',
        ',':  'unquote'
      };

      SParser.prototype = {
        peek: peek,
        consume: consume,
        until: until,
        error: error,
        string: string,
        atom: atom,
        quoted: quoted,
        expr: expr,
        list: list
      };

      function SParse(stream) {
        var parser = new SParser(stream);
        var expression = parser.expr();

        if (expression instanceof Error) {
            return expression;
        }

        // if anything is left to parse, it's a syntax error
        if (parser.peek() != '') {
            return parser.error('Superfluous characters after expression: `' + parser.peek() + '`');
        }

        return expression;
      };

      // module.exports.Parser = SParser;
      // module.exports.SyntaxError = Error;

      // export {SParse, SParser as Parser };

      function error(msg) {
        var e = new Error('Syntax error: ' + msg);
        e.line = this._line + 1;
        e.col  = this._col + 1;
        return e;
      }

      function peek() {
        if (this._stream.length == this._pos) return '';
        return this._stream[this._pos];
      }

      function consume() {
        if (this._stream.length == this._pos) return '';

        var c = this._stream[this._pos];
        this._pos += 1;

        if (c == '\r') {
            if (this.peek() == '\n') {
                this._pos += 1;
                c += '\n';
            }
            this._line++;
            this._col = 0;
        } else if (c == '\n') {
            this._line++;
            this._col = 0;
        } else {
            this._col++;
        }

        return c;
      }

      function until(regex) {
        var s = '';

        while (!regex.test(this.peek())) {
            s += this.consume();
        }

        return s;
      }

      function string() {
        // consume "
        var delimiter = this.consume();

        var str = '';

        while (true) {
            str += this.until(SParser.string_or_escaped_or_end);
            var next = this.peek();

            if (next == '') {
                return this.error('Unterminated string literal');
            }

            if (next == delimiter) {
                this.consume();
                break;
            }

            if (next == '\\') {
                this.consume();
                next = this.peek();

                if (next == 'r') {
                    this.consume();
                    str += '\r';
                } else if (next == 't') {
                    this.consume();
                    str += '\t';
                } else if (next == 'n') {
                    this.consume();
                    str += '\n';
                } else if (next == 'f') {
                    this.consume();
                    str += '\f';
                } else if (next == 'b') {
                    this.consume();
                    str += '\b';
                } else {
                    str += this.consume();
                }

                continue;
            }

            str += this.consume();
        }

        // wrap in object to make strings distinct from symbols
        return new String(str);
      }

      function atom() {
        if (SParser.string_delimiters.test(this.peek())) {
            return this.string();
        }

        var atom = '';

        while (true) {
            atom += this.until(SParser.space_quote_paren_escaped_or_end);
            var next = this.peek();

            if (next == '\\') {
                this.consume();
                atom += this.consume();
                continue;
            }

            break;
        }

        return atom;
      }

      function quoted() {
        var q = this.consume();
        var quote = SParser.quotes_map[q];

        if (quote == "unquote" && this.peek() == "@") {
            this.consume();
            quote = "unquote-splicing";
            q = ',@';
        }

        // ignore whitespace
        this.until(SParser.not_whitespace_or_end);
        var quotedExpr = this.expr();

        if (quotedExpr instanceof Error) {
            return quotedExpr;
        }

        // nothing came after '
        if (quotedExpr === '') {
            return this.error('Unexpected `' + this.peek() + '` after `' + q + '`');
        }

        return [quote, quotedExpr];
      }

      function expr() {
        // ignore whitespace
        this.until(SParser.not_whitespace_or_end);

        if (SParser.quotes.test(this.peek())) {
            return this.quoted();
        }

        var expr = this.peek() == '(' ? this.list() : this.atom();

        // ignore whitespace
        this.until(SParser.not_whitespace_or_end);

        return expr;
      }

      function list() {
        if (this.peek() != '(') {
            return this.error('Expected `(` - saw `' + this.peek() + '` instead.');
        }

        this.consume();

        var ls = [];
        var v = this.expr();

        if (v instanceof Error) {
            return v;
        }

        if (v !== '') {
            ls.push(v);

            while ((v = this.expr()) !== '') {
                if (v instanceof Error) return v;
                ls.push(v);
            }
        }

        if (this.peek() != ')') {
            return this.error('Expected `)` - saw: `' + this.peek() + '`');
        }

        // consume that closing paren
        this.consume();

        return ls;
      }


      // autumnstdlib.js 

      function ObjectType(render, fields) {
  // console.log("OBJECT_TYPE");
  // console.log({"render" : render, "fields" : fields});
  return {"render" : render, "fields" : fields};
}

function Position(args, state=null) {
  var [x, y] = args;
  // console.log("POSITION")
  // console.log([x, y])
  return {"x" : x, "y" : y};
}

function Cell(args, state=null) {
  if (args.length == 3) {
    var [x, y, color] = args;
    // console.log("CELL")
    // console.log([x, y, color])
    return {"position" : {"x" : x, "y" : y}, "color" : color };
  } else {
    var [position, color] = args;
    // console.log("CELL")
    // console.log([position, color])
    return {"position" : {"x" : position.x, "y" : position.y}, "color" : color };
  }
}

function moveLeft(args, state=null) {
  // console.log("MOVELEFT");
  // console.log(args);
  var obj = JSON.parse(JSON.stringify(args[0]));
  obj.origin.x = obj.origin.x - 1;
  return obj;
}

function moveRight(args, state=null) {
  // console.log("MOVERIGHT");
  // console.log(args);
  var obj = JSON.parse(JSON.stringify(args[0]));
  obj.origin.x = obj.origin.x + 1;
  return obj;
}

function moveUp(args, state=null) {
  // console.log("MOVEUP");
  // console.log(args);
  var obj = JSON.parse(JSON.stringify(args[0]));
  obj.origin.y = obj.origin.y - 1;
  return obj;
}

function moveDown(args, state=null) {
  // console.log("MOVEDOWN");
  // console.log(args);
  var obj = JSON.parse(JSON.stringify(args[0]));
  obj.origin.y = obj.origin.y + 1;
  return obj;
}

function prev(args, state=null) {
  var obj = args[0];
  var prev_objects = state.scene.objects.filter(o => o.id == obj.id);
  if (prev_objects.length != 0) {
    return JSON.parse(JSON.stringify(prev_objects[0]));
  } else {
    return JSON.parse(JSON.stringify(obj));
  }
}

function render(args, state=null) {
  var obj = args[0];
  if (obj.alive) {
    if (obj.render == null) {
      render_ = state.object_types[obj.type].render;
      // console.log("render_");
      // console.log(render_);
      return render_.map(cell => Cell([move([cell.position, obj.origin]), cell.color]));
    } else {
      return obj.render.map(cell => Cell([move([cell.position, obj.origin]), cell.color]));
    }
  } else {
    return [];
  }
}

function renderScene(args, state=null) {
  var scene = args[0];
  return unfold([scene.objects.filter(x => x.alive).map(o => render([o], state))]);
}

function occurred(args, state=null) {
  var click = args[0];
  return (click != null);
}

function uniformChoice(args, state=null) {
  // console.log("UNIFORMCHOICE");
  var freePositions = args[0];
  // console.log("freePositions");
  // console.log(freePositions);
  if (args.length == 1) {
    return freePositions[Math.floor(Math.random()*freePositions.length)];
  } else {
    var n = args[1];
    var vals = [];
    for (let i = 0; i < n; i++) {
      vals.push(freePositions[Math.floor(Math.random()*freePositions.length)]);
    }
    return vals;
  }
}

function isWithinBounds(args, state=null) {
  if (args[0].id != undefined) {
    var obj = args[0];
    return render([obj], state).filter(cell => !isWithinBounds([cell.position], state)).length == 0;
  } else {
    var position = args[0];
    var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()]; 
    if (Array.isArray(GRID_SIZE)) { 
      var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
    } else {
      var GRID_SIZE_X = GRID_SIZE;
      var GRID_SIZE_Y = GRID_SIZE;
    }
    return (position.x >= 0) && (position.x < GRID_SIZE_X) && (position.y >= 0) && (position.y < GRID_SIZE_Y);
  }
}

function isOutsideBounds(args, state=null) {
  var obj = args[0];
  return render([obj], state).filter(cell => isWithinBounds([cell.position], state)).length == 0;
}

function clicked(args, state=null) {
  // console.log("clicked woo");
  // console.log(args);
  // console.log(JSON.stringify(args));
  // console.log(state);
  // console.log(JSON.stringify(state));
  if (args.length == 2) {
    if (Array.isArray(args[1])) { // clicked array of objects
      var [click, objects] = args;
      if (click == null) {
        return false;
      } else {
        // console.log("clicked sad");
        // console.log("ret_val");
        // console.log(objects.map(obj => clicked([click, obj], state)).reduce((a, b) => a || b, false));
        // console.log("huh");
        return objects.map(obj => clicked([click, obj], state)).reduce((a, b) => a || b, false);
      }
    } else if (args[1].id != undefined) { // clicked(click, object)

      var [click, object] = args;
      if (click == null) {
        return false;
      } else {
        var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
        if (Array.isArray(GRID_SIZE)) {
          var GRID_SIZE_X = GRID_SIZE[0]
          var nums = render([object], state).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
          return nums.includes(GRID_SIZE_X * click.y + click.x);
        } else {
          nums = render([object], state).map(cell => GRID_SIZE*cell.position.y + cell.position.x)
          return nums.includes(GRID_SIZE * click.y + click.x)
        }
      }

    } else { // clicked(click, position)
      var [click, position] = args;
      if (click == null) {
        return false;
      } else {
        return (click.x == position.x) && (click.y == position.y);
      }
    }
  } else { // clicked(click, x, y)
    var [click, x, y] = args;
      if (click == null) {
        return false;
      } else {
        return (click.x == x) && (click.y == y);
      }
    }
}

function objClicked(args, state=null) {
  // console.log("objClicked woo");
  // console.log(args);
  var [click, objects] = args;
  if (click == null) {
    return null;
  } else {
    var clicked_objects = objects.filter(obj => clicked([click, obj], state));
    if (clicked_objects.length == 0) {
      return null;
    } else {
      // console.log("answer");
      // console.log(clicked_objects[0]);
      return JSON.parse(JSON.stringify(clicked_objects[0]));
    }
  }
}

function pushConfiguration(args, state=null) {
  if (args.length == 3) {
    var [arrow, obj1, obj2] = args;
    if (!Array.isArray(obj2)) {
      return pushConfiguration([arrow, obj1, [obj2]], state);
    } else {
      return moveIntersects([arrow, obj1, obj2], state) && isFree([move([move([obj1, arrow], state), arrow], state).origin], state);
    }
  } else { // args.length == 4
    var [arrow, obj1, obj2, obj3] = args;
    return moveIntersects([arrow, obj1, obj2], state) && intersects([move([move([obj1, arrow], state), arrow], state), obj3], state);
  }
}

function moveIntersects(args, state=null) {
  var [arrow, obj1, obj2] = args;
  return (arrow != Position([0, 0])) && intersects([move([obj1, arrow], state), obj2], state);
}

function intersects(args, state=null) {
  // console.log("INTERSECTS");
  // console.log(args);
  // console.log("state");
  // console.log(state);
  if (args.length == 2) {
    var [obj1, obj2] = args;

    if (!Array.isArray(obj1) && !Array.isArray(obj2)) {

      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) {
        var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
        var nums1 = render([obj1], state).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        var nums2 = render([obj2], state).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      } else {
        nums1 = render([obj1], state).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        nums2 = render([obj2], state).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      }

    } else if (!Array.isArray(obj1) && Array.isArray(obj2)) {

      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) {
        var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
        var nums1 = render([obj1], state).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        var nums2 = unfold([obj2.map(o => render([o], state))]).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        
        return nums1.filter(n => nums2.includes(n)).length != 0;
      } else {
        // console.log(JSON.stringify(obj1));
        // console.log(JSON.stringify(obj2));

        // console.log("GRID_SIZE");
        // console.log(GRID_SIZE);
        // console.log("HUH");
        // console.log(render([obj1], state));
        // console.log("HUH END");
        // console.log(unfold([obj2.map(o => render([o], state))]));
        // console.log("HUH END 2");
        var nums1 = render([obj1], state).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        var nums2 = unfold([obj2.map(o => render([o], state))]).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        
        // console.log("nums1");
        // console.log(nums1);
        // console.log("nums2");
        // console.log(nums2);
        
        return nums1.filter(n => nums2.includes(n)).length != 0;
      }

    } else if (Array.isArray(obj1) && !Array.isArray(obj2)) {

      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) {
        var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
        var nums2 = render([obj2], state).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        var nums1 = unfold([obj1.map(o => render([o], state))]).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      } else {
        var nums2 = render([obj2], state).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        var nums1 = unfold([obj1.map(o => render([o], state))]).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      }

    } else if (Array.isArray(obj1) && Array.isArray(obj2)) {

      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) {
        var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
        var nums2 = unfold([obj2.map(o => render([o], state))]).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        var nums1 = unfold([obj1.map(o => render([o], state))]).map(cell => GRID_SIZE_X*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      } else {
        var nums2 = unfold([obj2.map(o => render([o], state))]).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        var nums1 = unfold([obj1.map(o => render([o], state))]).map(cell => GRID_SIZE*cell.position.y + cell.position.x);
        return nums1.filter(n => nums2.includes(n)).length != 0;
      }

    }

  } else {
    var object = args[0];
    return intersects([object, state.scene.objects], state)
  }
}

function addObj(args, state=null) {
  // console.log("addObj woo");
  // console.log("args");
  // console.log(args);
  var [arr, obj] = args; 
  var new_arr = JSON.parse(JSON.stringify(arr));
  if (!Array.isArray(obj)) {
    new_arr.push(JSON.parse(JSON.stringify(obj)));
  } else {
    new_arr.push(...JSON.parse(JSON.stringify(obj)));
  }
  // console.log("new_arr");
  // console.log(new_arr);
  return new_arr;
}

function removeObj(args, state=null) {
  // console.log("removeObj woo");
  // console.log(args);
  if (args.length == 2) {
    var [arr, x] = JSON.parse(JSON.stringify(args)); 
    if (x.id != undefined) { // x is an object
      for (let elt of arr) {
        if (elt.id == x.id) {
          elt.alive = false;
        }
      }
      // console.log("filtered_arr");
      // console.log(arr);
      return arr;
    } else {
      // console.log("filtered_arr 2");
      // console.log(arr.filter(elt => !x(elt)))
      return arr.filter(elt => !x(elt));
    }
    return arr;
  } else {
    var obj = JSON.parse(JSON.stringify(args[0]));
    obj.alive = false;
    return obj;
  }
}

function updateObj(args, state=null) {
  return null;
}

function filter_fallback(args, state=null) {
  return true;
}

function adjPositions(args, state=null) {
  var position = args[0];
  return [Position([position.x, position.y + 1]), Position([position.x, position.y - 1]), Position([position.x + 1, position.y]), Position([position.x - 1, position.y])].filter(x => isWithinBounds([x], state));
}

function adjPositionsDiag(args, state=null) {
  var position = args[0];
  return [Position([position.x, position.y + 1]), Position([position.x, position.y - 1]), Position([position.x + 1, position.y]), Position([position.x - 1, position.y]), Position([position.x - 1, position.y - 1]), Position([position.x - 1, position.y + 1]), Position([position.x + 1, position.y - 1]), Position([position.x + 1, position.y + 1])].filter(x => isWithinBounds([x], state));
}

function isFree(args, state=null) {
  // console.log("isFree");
  // console.log(args);
  if (args.length == 1) {
    if (Array.isArray(args[0])) {
      var positions = args[0];
      return positions.map(pos => isFree([pos], state)).reduce((a,b) => a || b, false);
    } else {
      if (args[0] == null) {
        return false;
      } else {
        var position = args[0];
        return renderScene([state.scene], state).filter(cell => cell.position.x == position.x && cell.position.y == position.y).length == 0;
      }
    }
  } else if (args.length == 2) {
    if (args[0].id == undefined && args[1].id == undefined) { // position, position
      var [start, stop] = args;
      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) { 
        var GRID_SIZE_X = GRID_SIZE[0];
        var GRID_SIZE_Y = GRID_SIZE[1];
      } else {
        var GRID_SIZE_X = GRID_SIZE;
        var GRID_SIZE_Y = GRID_SIZE;
      }
      var translated_start = GRID_SIZE_X * start.y + start.x; 
      var translated_stop = GRID_SIZE_X * stop.y + stop.x;
      if (translated_start < translated_stop) {
        var ordered_start = translated_start;
        var ordered_end = translated_stop;
      } else {
        var ordered_start = translated_stop;
        var ordered_end = translated_start;
      }
      var nums = Array.from(Array(ordered_end - ordered_start + 1).keys()).map(x => x + ordered_start); // [ordered_start:ordered_end;]
      return nums.map(num => isFree([Position([num % GRID_SIZE_X, Math.floor(num / GRID_SIZE_X)])], state)).reduce((a, b) => (a && b), true);
    } else if (args[0].id != undefined && args[1].id != undefined) { // object, object
      var [object, orig_object] = args;
      return render([object], state).map(cell => cell.position).map(x => isFree([x, orig_object], state)).reduce((a, b) => (a && b), true);
    } else { // position, object
      var [position, object] = args;
      return renderScene([Scene(state.scene.objects.filter(obj => obj.id != object.id), state.scene.background)], state).filter(cell => cell.position.x == position.x && cell.position.y == position.y).length == 0;
    }

  } else if (args.length == 3) {
    var [start, stop, object] = args;
    var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
    if (Array.isArray(GRID_SIZE)) { 
      var GRID_SIZE_X = GRID_SIZE[0];
      var GRID_SIZE_Y = GRID_SIZE[1];
    } else {
      var GRID_SIZE_X = GRID_SIZE;
      var GRID_SIZE_Y = GRID_SIZE;
    }
    var translated_start = GRID_SIZE_X * start.y + start.x; 
    var translated_stop = GRID_SIZE_X * stop.y + stop.x;
    if (translated_start < translated_stop) {
      var ordered_start = translated_start;
      var ordered_end = translated_stop;
    } else {
      var ordered_start = translated_stop;
      var ordered_end = translated_start;
    }
    var nums = Array.from(Array(ordered_end - ordered_start + 1).keys()).map(x => x + ordered_start); // [ordered_start:ordered_end;]
    return nums.map(num => isFree([Position([num % GRID_SIZE_X, Math.floor(num / GRID_SIZE_X)]), object], state)).reduce((a, b) => (a && b), true);
  }
}

// helper
function Scene(objects, background) {
  return {"objects" : objects, "background" : background };
}

function rect(args, state=null) {
  var [pos1, pos2] = args;
  
  var min_x = pos1.x; 
  var max_x = pos2.x;
  var min_y = pos1.y;
  var max_y = pos2.y;

  var positions = [];
  for (let x = min_x; x < max_x + 1; x++) {
    for (let y = min_y; y < max_y + 1; y++) {
      positions.push(Position([x, y]));
    }
  }
  return positions;
}

function unitVector(args, state=null) {
  // console.log("UNITVECTOR");
  // console.log(args);
  if (args.length == 2) {
    var [a, b] = args;
    if (a.id == undefined && b.id == undefined) {
      var deltaX = b.x - a.x;
      var deltaY = b.y - a.y;
      if (Math.floor(Math.abs(Math.sign(deltaX))) == 1 && Math.floor(Math.abs(Math.sign(deltaY))) == 1) {
        return Position([Math.sign(deltaX), 0])
        // uniformChoice(rng, [Position(sign(deltaX), 0), Position(0, sign(deltaY))])
      } else {
        return Position([Math.sign(deltaX), Math.sign(deltaY)])  
      }
    } else if (a.id != undefined && b.id == undefined) {
      return unitVector([a.origin, b]);
    } else if (a.id == undefined && b.id != undefined) {
      return unitVector([a, b.origin]);
    } else if (a.id != undefined && b.id != undefined) {
      return unitVector([a.origin, b.origin]);
    }
  } else {
    var position = args[0];
    return unitVector([Position([0, 0]), position]);
  }
}

function unitVectorRand(args, state=null) {
  // console.log("UNITVECTORRAND");
  // console.log(args);
  if (args.length == 2) {
    var [a, b] = args;
    if (a.id == undefined && b.id == undefined) {
      var deltaX = b.x - a.x;
      var deltaY = b.y - a.y;
      // console.log(deltaX);
      // console.log(deltaY);
      if (Math.floor(Math.abs(Math.sign(deltaX))) == 1 && Math.floor(Math.abs(Math.sign(deltaY))) == 1) {
        return uniformChoice([[Position([Math.sign(deltaX), 0]), Position([0, Math.sign(deltaY)])]])
      } else {
        // console.log("pop2");
        return Position([Math.sign(deltaX), Math.sign(deltaY)])  
      }
    } else if (a.id != undefined && b.id == undefined) {
      return unitVectorRand([a.origin, b]);
    } else if (a.id == undefined && b.id != undefined) {
      return unitVectorRand([a, b.origin]);
    } else if (a.id != undefined && b.id != undefined) {
      return unitVectorRand([a.origin, b.origin]);
    }
  } else {
    var position = args[0];
    return unitVector([Position([0, 0]), position]);
  }
}

function vectorAdd(args, state=null) {
  var [pos1, pos2] = args;
  return Position([pos1.x + pos2.x, pos1.y + pos2.y]);
}

function vectorSub(args, state=null) {
  var [pos1, pos2] = args;
  return Position([pos1.x - pos2.x, pos1.y - pos2.y]);
}

function scalarMult(args, state=null) {
  var [pos, scalar] = args;
  return Position([scalar * pos.x, scalar * pos.y]);
}

function scalarDiv(args, state=null) {
  var [pos, scalar] = args;
  // console.log("pos");
  // console.log(pos);
  // console.log("scalar");
  // console.log(scalar);
  // console.log()
  return Position ([pos.x / scalar, pos.y / scalar]);
}

function floor(args, state=null){
  return Math.floor(args[1]);
}

function displacement(args, state=null) {
  if (args[0].color != undefined) { // cell version
    var [cell1, cell2] = args;
    return displacement([cell1.position, cell2.position]);
  } else { // position version
    var [position1, position2] = args;
    return Position([Math.floor(position2.x - position1.x), Math.floor(position2.y - position1.y)])
  }
}

function adjacent(args, state=null) {
  if (args[1].color == undefined) { // position/position version
    var [position1, position2, unitSize] = args;
    return [Position([0, 1]), Position([0, -1]), Position([1, 0]), Position([-1, 0])].map(p => JSON.stringify(p)).includes(JSON.stringify(displacement([position1, position2])));
  } else if (Array.isArray(args[1])) { // cell/array of cells version
    var [cell1, cells, unitSize] = args;
    return cells.filter(x => adjacent([cell, x, unitSize])).length != 0;
  } else { // cell/cell version
    var [cell1, cell2, unitSize] = args;
    return adjacent([cell1.position, cell2.position, unitSize]);
  }
}

function adjacentObjs(args, state=null) {
  var [obj, unitSize] = JSON.parse(JSON.stringify(args));
  return JSON.parse(JSON.stringify(state.scene.objects.filter(o => adjacent([o.origin, obj.origin, unitSize]) && (obj.id != o.id))))
}

function adjacentObjsDiag(args, state=null) {
  var obj = args[0];
  return JSON.parse(JSON.stringify(state.scene.objects.filter(o => adjacentDiag([o.origin, obj.origin]) && (obj.id != o.id))));
}

function adjacentDiag(args, state=null) {
  var [position1, position2] = args;
  return [Position([0, 1]), Position([0, -1]), Position([1, 0]), Position([-1, 0]), Position([1,1]), Position([1, -1]), Position([-1, 1]), Position([-1, -1])].map(p => JSON.stringify(p)).includes(JSON.stringify(displacement([position1, position2])));;
}

function adj(args, state=null) {
  // console.log("adj");
  // console.log(args);
  var [obj1, obj2, unitSize] = args;
  if (!Array.isArray(obj1) && !Array.isArray(obj2)) {
    // console.log("answer 1");
    // console.log(adjacentObjs([obj1, unitSize], state).filter(o => o.id == obj2.id).length != 0);
    return adjacentObjs([obj1, unitSize], state).filter(o => o.id == obj2.id).length != 0;
  } else if (!Array.isArray(obj1) && Array.isArray(obj2)) {
    // console.log("answer 2");
    // console.log(adjacentObjs([obj1, unitSize], state).filter(o => obj2.map(x => x.id).includes(o.id)).length != 0);
    return adjacentObjs([obj1, unitSize], state).filter(o => obj2.map(x => x.id).includes(o.id)).length != 0;
  } else { // both are arrays
    // console.log("answer 3");
    var obj1_adjacentObjs = unfold(obj1.map(x => adjacentObjs([x, unitSize], state)));
    // console.log(intersect(obj1_adjacentObjs.map(x => x.id), obj2.map(x => x.id)).length != 0)
    return intersect([obj1_adjacentObjs.map(x => x.id), obj2.map(x => x.id)]).length != 0;
  }
}

// helper
function intersect(args) {
  var [arr1, arr2] = args;
  let new_list = [];
  for (let elt of arr1) {
    if (typeof(elt) == "object") {
      if (arr2.map(x => JSON.stringify(x)).includes(JSON.stringify(elt))) {
        new_list.push(elt);
      }
    } else {
      if (arr2.includes(elt)) {
        new_list.push(elt);
      }
    }
  }
  return new_list;
}

// function adjCorner(args, state=null) {

// }

// function rotate(args, state=null) {

// }

// function rotateNoCollision(args, state=null) {

// }

function move(args, state=null) {
  // console.log("MOVE WOO");
  // console.log(args);
  if (args.length == 2) {
    var [a, b] = args;
    if (a.id != undefined) {
      var new_a = JSON.parse(JSON.stringify(a));
      new_a.origin = move([a.origin, b]);
      // console.log("new_a");
      // console.log(new_a);
      return new_a;
    } else if (a.color == undefined && b.color == undefined) { // position, position
      return Position([a.x + b.x, a.y + b.y]);
    } else if (a.color == undefined && b.color != undefined) { // position, cell
      return Position([a.x + b.position.x, a.y + b.position.y]);
    } else { // cell, position
      return Position([a.position.x + b.x, a.position.y + b.y]);    
    }
  } else { // args.length == 3
    var [object, x, y] = JSON.parse(JSON.stringify(args));
    return move([object, Position([x, y])]);
  }
}

function moveNoCollision(args, state=null) {
  if (args.length == 2) {
    var [object, position] = JSON.parse(JSON.stringify(args));
    return (isWithinBounds([move([object, position])], state) && isFree([move([object, position.x, position.y]), object], state)) ? move([object, position.x, position.y]) : object; 
  } else {
    var [object, x, y] = JSON.parse(JSON.stringify(args));
    return (isWithinBounds([move([object, x, y])], state) && isFree([move([object, x, y]), object], state)) ? move([object, x, y]) : object;
  }
}

// function moveNoCollisionColor(args, state=null) {

// }

// function moveNoCollisionColor(args, state=null) {

// }

function moveLeftNoCollision(args, state=null) {
  var object = JSON.parse(JSON.stringify(args[0]));
  return (isWithinBounds([move([object, -1, 0])], state) && isFree([move([object, -1, 0]), object], state)) ? move([object, -1, 0]) : object;
}

function moveRightNoCollision(args, state=null) {
  var object = JSON.parse(JSON.stringify(args[0]));
  return (isWithinBounds([move([object, 1, 0])], state) && isFree([move([object, 1, 0]), object], state)) ? move([object, 1, 0]) : object
}

function moveUpNoCollision(args, state=null) {
  var object = JSON.parse(JSON.stringify(args[0]));
  return (isWithinBounds([move([object, 0, -1])], state) && isFree([move([object, 0, -1]), object], state)) ? move([object, 0, -1]) : object;
}

function moveDownNoCollision(args, state=null) {
  var object = JSON.parse(JSON.stringify(args[0]));
  return (isWithinBounds([move([object, 0, 1])], state) && isFree([move([object, 0, 1]), object], state)) ? move([object, 0, 1]) : object;
}

function moveWrap(args, state=null) {
  if (args.length == 3) {
    if (args[0].id != undefined) { // object, x, y
      var [object, x, y] = args; 
      object = JSON.parse(JSON.stringify(object));
      object.origin = moveWrap([object.origin, x, y], state);
      return object;
    } else { // position, x, y
      var [position, x, y] = args;
      var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
      if (Array.isArray(GRID_SIZE)) {
        var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
        return Position([(position.x + x + GRID_SIZE_X) % GRID_SIZE_X, (position.y + y + GRID_SIZE_Y) % GRID_SIZE_Y]);
      } else {
        var [GRID_SIZE_X, GRID_SIZE_Y] = [GRID_SIZE, GRID_SIZE];
        return Position([(position.x + x + GRID_SIZE) % GRID_SIZE, (position.y + y + GRID_SIZE) % GRID_SIZE])
      }    
    }
  } else {
    var [a, b] = args;
    if (a.id != undefined) { // object, position
      var object = JSON.parse(JSON.stringify(a));
      object.origin = moveWrap([object.origin, b.x, b.y], state);
      return object;
    } else if (a.color != undefined) { // cell, position
      return moveWrap([a.position, b.x, b.y], state);
    } else if (b.color != undefined) { // position, cell
      return moveWrap([b.position, a], state);
    } else { // position, position
      return moveWrap([a, b.x, b.y], state);
    }
  }
}

// function moveLeftWrap(args, state=null) {

// }

// function moveRightWrap(args, state=null) {

// }

// function moveUpWrap(args, state=null) {

// }

// function moveDownWrap(args, state=null) {

// }

function randomPositions(args, state=null) {
  // console.log("RANDOMPOSITIONS");
  // console.log(args);
  var [GRID_SIZE, n] = args;
  if (Array.isArray(GRID_SIZE)) {
    var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
    var nums = uniformChoice([Array.from(Array(GRID_SIZE_X*GRID_SIZE_Y - 1).keys()).map(x => x + 1), n], state)
    return nums.map(num => Position([num % GRID_SIZE_X, Math.floor(num / GRID_SIZE_X)]));
  } else {
    var nums = uniformChoice([Array.from(Array(GRID_SIZE*GRID_SIZE - 1).keys()).map(x => x + 1), n], state)
    return nums.map(num => Position([num % GRID_SIZE, Math.floor(num / GRID_SIZE)]));
  }
}

function distance(args, state=null) {
  if (!Array.isArray(args[0]) && !Array.isArray(args[1])) {
    if (args[0].id == undefined && args[1].id == undefined) { // position, position
      var [position1, position2] = args;
      return Math.abs(position1.x - position2.x) + Math.abs(position1.y - position2.y);
    } else if (args[0].id != undefined && args[1].id != undefined) { // object, object
      var [object1, object2] = args;
      var position1 = object1.origin;
      var position2 = object2.origin;
      return distance([position1, position2]);      
    } else if (args[0].id != undefined) { // object, position
      var [object, position] = args;
      return distance([object.origin, position]);
    } else { // position, object
      var [position, object] = args;
      return distance([object.origin, position]);
    }
  } else if (!Array.isArray(args[0])) { // second arg is array (obj, arr obj)
    var [object, objects] = args;
    if (objects.length == 0) {
      return Number.MAX_SAFE_INTEGER;
    } else {
      var distances = objects.map(obj => distance([object, obj]));
      return Math.min(...distances);
    }
  } else { // both args are arrays (arr obj, arr obj)
    var [objects1, objects2] = args;
    if (objects1.length == 0 && objects2.length == 0) {
      return Number.MAX_SAFE_INTEGER;
    } else {
      var distances = unfold([objects1.map(obj => distance([obj, objects2]))]);
      return Math.min(...distances);
    }
  }
}

function cartDistance(args, state=null) {
  if (!Array.isArray(args[0]) && !Array.isArray(args[1])) {
    if (args[0].id == undefined && args[1].id == undefined) { // position, position
      var [position1, position2] = args;
      return Math.sqrt(Math.abs(position1.x - position2.x)*Math.abs(position1.x - position2.x) + Math.abs(position1.y - position2.y)*Math.abs(position1.y - position2.y));
    } else if (args[0].id != undefined && args[1].id != undefined) { // object, object
      var [object1, object2] = args;
      var position1 = object1.origin;
      var position2 = object2.origin;
      return cartDistance([position1, position2]);      
    } else if (args[0].id != undefined) { // object, position
      var [object, position] = args;
      return cartDistance([object.origin, position]);
    } else { // position, object
      var [position, object] = args;
      return cartDistance([object.origin, position]);
    }
  } else if (!Array.isArray(args[0])) { // second arg is array (obj, arr obj)
    var [object, objects] = args;
    if (objects.length == 0) {
      return Number.MAX_SAFE_INTEGER;
    } else {
      var distances = objects.map(obj => cartDistance([object, obj]));
      return Math.min(...distances);
    }
  } else { // both args are arrays (arr obj, arr obj)
    var [objects1, objects2] = args;
    if (objects1.length == 0 && objects2.length == 0) {
      return Number.MAX_SAFE_INTEGER;
    } else {
      var distances = unfold([objects1.map(obj => cartDistance([obj, objects2]))]);
      return Math.min(...distances);
    }
  }
}

// function firstWithDefault(args, state=null) {

// }

// function farthestRandom(args, state=null) {

// }

// function farthestLeft(args, state=null) {

// }

// function farthestRight(args, state=null) {

// }

// function farthestUp(args, state=null) {

// }

// function farthestDown(args, state=null) {

// }

function closest(args, state=null) {
  // console.log("CLOSEST");
  // console.log(args);
  // console.log("huh");
  var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
  if (Array.isArray(GRID_SIZE)) {
    GRID_SIZE = GRID_SIZE[0];
  }
  if (Array.isArray(args[1])) {
    var [object, arr] = args;
    if (arr.length == 0) {
      return object.origin;
    }
    
    if (arr[0].x != undefined) { // array of positions
      var [object, positions] = JSON.parse(JSON.stringify(args));
      var distances = positions.map(pos => distance([pos, object.origin]));
      distances.sort((a, b) => a - b);
      var closestDistance = distances[0];
      var closest = positions.filter(pos => distance([pos, object.origin]) == closestDistance)[0];
      return closest;
    } else if (arr[0].origin != undefined) {
      var [object, objects] = JSON.parse(JSON.stringify(args));
      var positions = objects.map(o => o.origin);
      var distances = positions.map(pos => distance([pos, object.origin]));
      distances.sort((a, b) => a - b);
      var closestDistance = distances[0];
      var closest = positions.filter(pos => distance([pos, object.origin]) == closestDistance)[0];
      return closest;
    } else { // array of types
      var [object, types] = args;
      var objects_of_type = state.scene.objects.filter(obj => (types.includes(obj.type)) && (obj.alive))
      if (objects_of_type.length == 0) {
        return object.origin;
      } else {
        var min_distance = Math.min(...objects_of_type.map(obj => distance([object, obj])));
        var objects_of_min_distance = JSON.parse(JSON.stringify(objects_of_type.filter(obj => distance([object, obj]) == min_distance)));
        objects_of_min_distance.sort((o1, o2) => o1.origin.y * GRID_SIZE + o1.origin.x < o2.origin.y * GRID_SIZE + o2.origin.x ? -1 : 1);
        return objects_of_min_distance[0].origin;      
      }
    }
  } else { // obj, type
    var [object, type] = args;
    var objects_of_type = state.scene.objects.filter(obj => (obj.type == type) && (obj.alive))
    if (objects_of_type.length == 0) {
      return object.origin;
    } else {
      // console.log("hullo");

      var min_distance = Math.min(...objects_of_type.map(obj => distance([object, obj])));
      var objects_of_min_distance = JSON.parse(JSON.stringify(objects_of_type.filter(obj => distance([object, obj]) == min_distance)));
      objects_of_min_distance.sort((o1, o2) => o1.origin.y * GRID_SIZE + o1.origin.x < o2.origin.y * GRID_SIZE + o2.origin.x ? -1 : 1);
      return objects_of_min_distance[0].origin;      
    }
  }
}

// function closestRandom(args, state=null) {

// }

// function closestLeft(args, state=null) {

// }

// function closestRight(args, state=null) {

// }

// function closestUp(args, state=null) {

// }

// function closestDown(args, state=null) {

// }

function mapPositions(args, state=null) {
  var [constructor, GRID_SIZE, filterFunction, args_] = args;
  return allPositions([GRID_SIZE]).filter(pos => filterFunction(pos)).map(x => constructor(x));
}

// function updateOrigin(args, state=null) {

// }

// function updateAlive(args, state=null) {

// }

function nextLiquid(args, state=null) {
  // # # println("nextLiquid")
  // console.log("nextLiquid");
  // console.log(args);

  var [object] = args;
  var GRID_SIZE = state.histories.GRID_SIZE[(state.time - 1).toString()];
  if (Array.isArray(GRID_SIZE)) { 
    var GRID_SIZE_X = GRID_SIZE[0]
    var GRID_SIZE_Y = GRID_SIZE[1]
  } else {
    var GRID_SIZE_X = GRID_SIZE;
    var GRID_SIZE_Y = GRID_SIZE;
  }
  var new_object = JSON.parse(JSON.stringify(object));
  if (object.origin.y != GRID_SIZE_Y - 1 && isFree([move([object.origin, Position([0, 1])])], state)) {
    new_object.origin = move([object.origin, Position([0, 1])]);
  } else {
    var leftHoles = allPositions([GRID_SIZE], state).filter(pos => (pos.y == object.origin.y + 1)
                                                                && (pos.x < object.origin.x)
                                                                && isFree([pos], state));
    var rightHoles = allPositions([GRID_SIZE], state).filter(pos => (pos.y == object.origin.y + 1)
                                                                 && (pos.x > object.origin.x)
                                                                 && isFree([pos], state));
    if ((leftHoles.length != 0) || (rightHoles.length != 0)) {
      if (leftHoles.length == 0) {
        var closestHole = closest([object, rightHoles], state);
        if (isFree([move([closestHole, Position([0, -1])]), move([object.origin, Position([1, 0])])], state)) {
          new_object.origin = move([object.origin, unitVector([object, move([closestHole, Position([0, -1])])], state)], state);
        }
      } else if (rightHoles.length == 0) {
        var closestHole = closest([object, leftHoles], state);
        if (isFree([move([closestHole, Position([0, -1])]), move([object.origin, Position([-1, 0])])], state)) {
          new_object.origin = move([object.origin, unitVector([object, move([closestHole, Position([0, -1])])], state)]);                    
        }
      } else {
        var closestLeftHole = closest([object, leftHoles], state);
        var closestRightHole = closest([object, rightHoles], state);

        if (distance([object.origin, closestLeftHole]) > distance([object.origin, closestRightHole])) {
          if (isFree([move([object.origin, Position([1, 0])]), move([closestRightHole, Position([0, -1])])], state)) {
            new_object.origin = move([object.origin, unitVector([new_object, move([closestRightHole, Position([0, -1])])], state)]);
          } else if (isFree([move([closestLeftHole, Position([0, -1])]), move([object.origin, Position([-1, 0])])], state)) {
            new_object.origin = move([object.origin, unitVector([new_object, move([closestLeftHole, Position([0, -1])])])], state);
          }
        } else {
          if (isFree([move([closestLeftHole, Position([0, -1])]), move([object.origin, Position([-1, 0])])], state)) {
            new_object.origin = move([object.origin, unitVector([new_object, move([closestLeftHole, Position([0, -1])])], state)]);
          } else if (isFree([move([object.origin, Position([1, 0])]), move([closestRightHole, Position([0, -1])])], state)) {
            new_object.origin = move([object.origin, unitVector([new_object, move([closestRightHole, Position([0, -1])])], state)]);
          }
        }
      }
    }
  }
  return new_object;
}

function nextSolid(args, state=null) {
  return moveDownNoCollision(args, state);
}

function allPositions(args, state=null) {
  var GRID_SIZE = args[0];
  // console.log("GRID_SIZE");
  // console.log(GRID_SIZE);
  if (Array.isArray(GRID_SIZE)) {
    var [GRID_SIZE_X, GRID_SIZE_Y] = GRID_SIZE;
  } else {
    var [GRID_SIZE_X, GRID_SIZE_Y] = [GRID_SIZE, GRID_SIZE];
  }
  // console.log(GRID_SIZE_X);
  // console.log(GRID_SIZE_Y);
  var nums = Array.from(Array(GRID_SIZE_X*GRID_SIZE_Y).keys());
  return nums.map(num => Position([num % GRID_SIZE_X, Math.floor(num / GRID_SIZE_X)], state));
}

function unfold(args, state=null) {
  var A = args[0];
  var V = [];
  for (let x of A) {
    for (let elt of x) {
      V.push(elt);
    }
  }
  return V;
}

function average(args, state=null) {
  var array = args[0];
  if (array.length == 0) {
    return 0;
  } else {
    if (typeof(array[0]) == 'number') {
      return Math.floor(array.reduce((a, b) => a + b) / array.length);
    } else if (array[0].x != undefined) { // position
      var x = average([array.map(p => p.x)]);
      var y = average([array.map(p => p.y)]);
      return {"x" : x, "y" : y};
    }
  }
}

// exports 
// module.exports = { ObjectType,
//                    Position, 
//                    Cell, 
//                    moveLeft, 
//                    moveRight, 
//                    moveUp, 
//                    moveDown, 
//                    prev,
//                    render,
//                    renderScene,
//                    occurred, 
//                    uniformChoice,
//                    isWithinBounds,
//                    isOutsideBounds,
//                    clicked,
//                    objClicked,
//                    intersects, 
//                    addObj,
//                    removeObj,
//                    updateObj,
//                    filter_fallback,
//                    adjPositions,
//                    isFree,
//                    rect,
//                    unitVector,
//                    displacement,
//                    adjacent,
//                    adjacentObjs,
//                    adjacentObjsDiag,
//                    adjacentDiag,
//                    adj,
//                    intersect,
//                    move,
//                    moveNoCollision,
//                    moveLeftNoCollision,
//                    moveRightNoCollision,
//                    moveUpNoCollision,
//                    moveDownNoCollision,
//                    randomPositions,
//                    distance,
//                    closest,
//                    mapPositions,
//                    nextLiquid,
//                    nextSolid,
//                    allPositions,
//                    unfold,
//  };

// export { ObjectType,
//   Position, 
//   Cell, 
//   moveLeft, 
//   moveRight, 
//   moveUp, 
//   moveDown, 
//   prev,
//   render,
//   renderScene,
//   occurred, 
//   uniformChoice,
//   isWithinBounds,
//   isOutsideBounds,
//   clicked,
//   objClicked,
//   intersects, 
//   addObj,
//   removeObj,
//   updateObj,
//   filter_fallback,
//   adjPositions,
//   isFree,
//   rect,
//   unitVector,
//   displacement,
//   adjacent,
//   adjacentObjs,
//   adjacentObjsDiag,
//   adjacentDiag,
//   adj,
//   intersect,
//   move,
//   moveNoCollision,
//   moveLeftNoCollision,
//   moveRightNoCollision,
//   moveUpNoCollision,
//   moveDownNoCollision,
//   randomPositions,
//   distance,
//   closest,
//   mapPositions,
//   nextLiquid,
//   nextSolid,
//   allPositions,
//   unfold,
// };


      // interpretutils.js 

      // import { parseau } from "./sexpr.js"
// import * as AutumnStandardLibrary from "./autumnstdlib.js"
// const { parseau } = require("./sexpr.js");

// module.exports = { interpret, update };
// export { interpret, update };

// imports
// import { ObjectType,
//         Position, 
//         Cell, 
//         moveLeft, 
//         moveRight, 
//         moveUp, 
//         moveDown, 
//         prev,
//         render,
//         renderScene,
//         occurred, 
//         uniformChoice,
//         isWithinBounds,
//         isOutsideBounds,
//         clicked,
//         objClicked,
//         intersects, 
//         addObj,
//         removeObj,
//         updateObj,
//         filter_fallback,
//         adjPositions,
//         isFree,
//         rect,
//         unitVector,
//         displacement,
//         adjacent,
//         adjacentObjs,
//         adjacentObjsDiag,
//         adjacentDiag,
//         adj,
//         intersect,
//         move,
//         moveNoCollision,
//         moveLeftNoCollision,
//         moveRightNoCollision,
//         moveUpNoCollision,
//         moveDownNoCollision,
//         randomPositions,
//         distance,
//         closest,
//         mapPositions,
//         nextLiquid,
//         nextSolid,
//         allPositions,
//         unfold, 
//       } from "./autumnstdlib.js";

function update(env, x, v) {
  var new_env = JSON.parse(JSON.stringify(env))
  new_env[x] = v;
  return new_env;
}

function isaexpr(aex) {
  return (aex != null && typeof(aex) == "object" && aex.head != undefined)
}

function isobject(aex) {
  return (aex != null && typeof(aex) == "object" && aex.id != undefined)
}

var prim_to_func = {"+" : function(x, y) {return x + y;},
                   "-" : function(x, y) {return x - y;},
                   "*" : function(x, y) {return x * y;},
                   "/" : function(x, y) {return Math.floor(x / y);},
                   "&" : function(x, y) {return x && y;},
                   "!" : function(x) {return !x;},
                   "|" : function(x, y) {return x || y;},
                   ">" : function(x, y) {return x > y;},
                   "<" : function(x, y) {return x < y;},
                   "<=" : function(x, y) {return x <= y;},
                   ">=" : function(x, y) {return x >= y;}, 
                   "==" : function(x, y) {return x == y;},
                   "%" : function(x, y) {return x % y;},
                   "!=" : function(x, y) {return x != y;},
                   "sqrt" : function(x) {return Math.floor(Math.sqrt(x));},
                   "abs" : function(x) {return Math.abs(x);},
                  }

function isprim(f) {
  return (f in prim_to_func);
}

function primapl_uni(f, x, env) {
  var [x, env] = interpret(x, env);
  return [prim_to_func[f](x), env];
}

function primapl(f, x, y, env) {
  // console.log("PRIMAPL");
  // console.log(x);
  // console.log(y);
  var [x, env] = interpret(x, env);
  var [y, env] = interpret(y, env);
  if (f == "==" || f == "!=") {
    return [prim_to_func[f](JSON.stringify(x), JSON.stringify(y)), env]
  } else {
    return [prim_to_func[f](x, y), env]
  }
}

var lib_to_func = {"ObjectType" : ObjectType,
                   "Position" : Position, 
                   "Cell" : Cell, 
                   "moveLeft" : moveLeft, 
                   "moveRight" : moveRight, 
                   "moveUp" : moveUp, 
                   "moveDown" : moveDown, 
                   "prev" : prev,
                   "render" : render,
                   "renderScene" : renderScene,
                   "occurred" : occurred, 
                   "uniformChoice" : uniformChoice,
                   "isWithinBounds" : isWithinBounds,
                   "isOutsideBounds" : isOutsideBounds,
                   "clicked" : clicked,
                   "objClicked" : objClicked,
                   "intersects" : intersects, 
                   "addObj" : addObj,
                   "removeObj" : removeObj,
                   "updateObj" : updateObj,
                   "filter_fallback" : filter_fallback,
                   "adjPositions" : adjPositions,
                   "adjPositionsDiag" : adjPositionsDiag,
                   "isFree" : isFree,
                   "rect" : rect,
                   "unitVector" : unitVector,
                   "unitVectorRand": unitVectorRand,
                   "displacement" : displacement,
                   "vectorAdd" : vectorAdd,
                   "vectorSub" : vectorSub,
                   "scalarMult" : scalarMult, 
                   "scalarDiv" : scalarDiv,
                   "floor" : floor,
                   "adjacent" : adjacent,
                   "adjacentObjs" : adjacentObjs,
                   "adjacentObjsDiag" : adjacentObjsDiag,
                   "adjacentDiag" : adjacentDiag,
                   "adj" : adj,
                   "intersect" : intersect,
                   "move" : move,
                   "moveWrap" : moveWrap,
                   "moveNoCollision" : moveNoCollision,
                   "moveLeftNoCollision" : moveLeftNoCollision,
                   "moveRightNoCollision" : moveRightNoCollision,
                   "moveUpNoCollision" : moveUpNoCollision,
                   "moveDownNoCollision" : moveDownNoCollision,
                   "randomPositions" : randomPositions,
                   "distance" : distance,
                   "cartDistance" : cartDistance,
                   "closest" : closest,
                   "mapPositions" : mapPositions,
                   "nextLiquid" : nextLiquid,
                   "nextSolid" : nextSolid,
                   "allPositions" : allPositions,
                   "unfold" : unfold,
                   "average" : average,
                  }

function islib(f) {
  return (f in lib_to_func);
}

function libapl(f, args, env) {
  // console.log("libapl");
  // console.log(f);
  // console.log(args);
  // console.log(JSON.stringify(env));
  if (f == "clicked" && args.length == 0) {
    return interpret(f, env);
  } else if (f == "clicked") {
    return [lib_to_func[f]([interpret("click", env)[0], ...args], env.state), env]
  } else {
    var has_function_arg = false; 
    for (let arg of args) {
      // console.log("arg");
      // console.log(JSON.stringify(arg));
      if (Array.isArray(arg) && (arg.length == 2) && (isaexpr(arg[0]) || typeof(arg[0]) == "string") && (isaexpr(arg[1]) || typeof(arg[1]) == "string")) {
        has_function_arg = true;
      }
    }

    // console.log("has_function_arg__");
    // console.log(has_function_arg);
    if (!has_function_arg && f != "updateObj") {
      return [lib_to_func[f](args.map(a => interpret(a, env)[0]), env.state), env]
    } else {
      if (f == "updateObj") {
        return interpret_updateObj(args, env)
      } else if (f == "removeObj") {
        return interpret_removeObj(args, env)
      } else {
        [lib_to_func[f](args.map(a => interpret(a, env)[0]), env.state), env]
      }
    }

  }
}

js_lib_to_func = new Set(["get",
                         "map",
                         "filter",
                         "first",
                         "last",
                         "in", 
                         "intersect",
                         "length",
                         "sign",
                         "vcat", 
                         "count"]);

function isjslib(f) {
  return (js_lib_to_func.has(f));
}

function jslibapl(f, args, env) {
  if (f == "get") {
    // console.log("GET ME")
    // console.log(f);
    // console.log(args);
    // console.log(env);
    var [dict, env] = interpret(args[0], env);
    var key = args[1];
    if (isaexpr(key)) {
      [key, env] = interpret(key, env);
    } 
    var [default_, env] = interpret(args[2], env);

    // console.log("DICT");
    // console.log(dict);
    // console.log("key");
    // console.log(key);
    // console.log("default_");
    // console.log(default_);

    return [(key in dict ? dict[key] : default_), env];
  } else if (f == "map") {  
    return interpret_js_map(args, env);
  } else if (f == "filter") {
    return interpret_js_filter(args, env);
  } else if (f == "first") {
    var [l, env] = interpret(args[0], env);
    return [l[0], env];
  } else if (f == "last") {
    var [l, env] = interpret(args[0], env);
    return [l[l.length - 1], env];
  } else if (f == "in") {
    var [elt, env] = interpret(args[0], env);
    var [l, env] = interpret(args[1], env);
    return [l.map(e => JSON.stringify(e)).includes(JSON.stringify(elt)), env];
  } else if (f == "intersect") {
    var [l1, env] = interpret(args[0], env);
    var [l2, env] = interpret(args[1], env);
    return [l1.filter(elt => l2.includes(elt)), env];
  } else if (f == "length") {
    var [l, env] = interpret(args[0], env);
    return [l.length, env];
  } else if (f == "sign") {
    var [v, env] = interpret(args[0], env);
    return [v >= 0 ? 1 : -1, env];
  } else if (f == "vcat") {
    var ls = args.map(l => interpret(l, env)[0]);
    return [[].concat(...ls), env];
  } else if (f == "count") {
    return interpret_js_count(args, env);
  }
}

function interpret(aex, env) {
  // console.log("INTERPRET GLOBAL")
  if (isaexpr(aex)) {
    if (aex.head == "if") {
      var [c, t, e] = aex.args; 
      var [v, env2] = interpret(c, env);
      if (v) {
        return interpret(t, env2);
      } else {
        return interpret(e, env2);
      }
    } else if (aex.head == "assign") {
      var [x, v] = aex.args 
      if (v.head == "initnext") {
        return interpret_init_next(x, v, env);
      } else if (isaexpr(v) || typeof(v) == "string") {
        var [v2, env] = interpret(v, env);
        return interpret({"head" : "assign", "args" : [x, v2]}, env);
      } else {
        env.current_var_values[x] = interpret(v, env)[0];
        return [aex, env];
      }
      
    } else if (aex.head == "list") {
      return interpret_list(aex.args, env);
    } else if (aex.head == "typedecl") {
      return [aex, env];
    } else if (aex.head == "%%") {
      return [aex, env];
    } else if (aex.head == "let") {
      return interpret_let(aex.args, env);
    } else if (aex.head == "lambda") {
      return [aex.args, env];
    } else if (aex.head == "fn") {
      return [aex.args, env];
    } else if (aex.head == "call") {
      var f = aex.args[0];
      var args = aex.args[1];

      if (!Array.isArray(args)) {
        args = [args];
      }

      // console.log("hm");
      // console.log(f);
      // console.log(args);
      // console.log(JSON.stringify(env));

      if (isprim(f)) {
        
        if (args.length == 1) {
          return primapl_uni(f, args[0], env);
        } else {
          return primapl(f, args[0], args[1], env);
        }
      } else if (f == "prev" && JSON.stringify(args) != JSON.stringify(["obj"])) {
        // console.log("WOAH  2");
        var [v, env_] = interpret({"head" : "call", "args" : ["prev" + args[0][0].toUpperCase() + args[0].slice(1), ["state"]]}, env);
        return [JSON.parse(JSON.stringify(v)), env_]
      } else if (islib(f)) {
        // console.log("here?");
        return interpret_lib(f, args, env);
      } else if (isjslib(f)) {
        return interpret_js_lib(f, args, env);
      } else if (f in env.state.object_types) {
        return interpret_object_call(f, args, env);
      } else {
        // console.log("WOAH");
        if (Array.isArray(args)) {
          return interpret_call(f, args, env);
        } else {
          return interpret_call(f, [args], env);
        }
      }
    } else if (aex.head == "field") {
      return interpret_field(aex.args[0], aex.args[1], env);
    } else if (aex.head == "object") {
      return interpret_object(aex.args, env);
    } else if (aex.head == "on") {
      return interpret_on(aex.args, env);
    } else {
      throw new Error(`Invalid AExpr Head: ${aex.head}`);
    }
  } else if (typeof(aex) == "string") {
    if (aex == "true") {
      return [true, env];
    } else if (aex == "false") {
      return [false, env];
    } else if (aex == "left") {
      return [env.left, env];
    } else if (aex == "right") { 
      return [env.right, env];
    } else if (aex == "up") {
      return [env.up, env];
    } else if (aex == "down") {
      return [env.down, env];
    } else if (aex == "left2") {
      return [env.left2, env];
    } else if (aex == "right2") { 
      return [env.right2, env];
    } else if (aex == "up2") {
      return [env.up2, env];
    } else if (aex == "down2") {
      return [env.down2, env];

    } else if (aex == "left3") {
      return [env.left3, env];
    } else if (aex == "right3") { 
      return [env.right3, env];
    } else if (aex == "up3") {
      return [env.up3, env];
    } else if (aex == "down3") {
      return [env.down3, env];

    } else if (aex == "left4") {
      return [env.left4, env];
    } else if (aex == "right4") { 
      return [env.right4, env];
    } else if (aex == "up4") {
      return [env.up4, env];
    } else if (aex == "down4") {
      return [env.down4, env];

    } else if (aex == "click") {
      return [env.click, env];
    } else if (aex == "clicked") {
      return interpret({"head" : "call", "args" : ["occurred", ["click"]]}, env)
    } else if (aex in env.state.object_types) {
      return [aex, env]
    } else if (aex == "state") {
      return [env.state, env]
    } else if (aex in env.current_var_values) {
      return [env.current_var_values[aex], env]
    } else {
      console.log(aex);
      throw new Error(`Could not interpret ${aex}`);
    }
  } else {
    if (aex != null && typeof(aex) == "object") {
      return [aex.valueOf(), env];
    } else {
      return [aex, env];
    }
  }
}

function interpret_list(args, env) {
  // console.log("INTERPRET_LIST");
  // console.log(args);
  var new_list = [];
  for (let arg of args) {
    var [new_arg, env] = interpret(arg, env);
    new_list.push(new_arg);
  }
  // console.log("new_list");
  // console.log(new_list);
  return [new_list, env];
}

function interpret_lib(f, args, env) {
  // console.log("interpret_lib");
  // console.log(f);
  // console.log(args);
  // console.log(JSON.stringify(env));
  var new_args = [];
  for (let arg of args) {
    [new_arg, env] = interpret(arg, env);
    new_args.push(new_arg);
  }
  // console.log("new_args");
  // console.log(new_args);
  return libapl(f, new_args, env);
} 

function interpret_js_lib(f, args, env) {
  return jslibapl(f, args, env);
}

function interpret_field(x, f, env) {
  var [val, env2] = interpret(x, env);
  if (isobject(val)) {
    if (["id", "origin", "type", "alive", "changed", "render"].includes(f)) {
      return [val[f], env2];
    } else {
      return [val.custom_fields[f], env2];
    }
  } else {
    return [val[f], env2];
  }
}

function interpret_let(args, env) {
  // console.log("interpret_let");
  // console.log(args);
  // console.log(JSON.stringify(env));
  var env2 = JSON.parse(JSON.stringify(env));
  if (args.length > 0 ) {
    for (let arg of args.slice(0, args.length - 1)) {
      var [v2, env2] = interpret(arg, env2);
    }

    if (isaexpr(args[args.length - 1])) {
      if (args[args.length - 1].head == "assign") {
        // console.log("woo");
        // console.log(args[args.length - 1]);
        var [v2, env2] = interpret(args[args.length - 1], env2);
        return [{"head" : "let", "args" : args}, env2];
      } else {
        var [v2, env2] = interpret(args[args.length - 1], env2);
        return [v2, env];
      }
    } else {
      return [interpret(args[args.length - 1], env2)[0], env];
    }

  } else {
    return [{"head" : "let", "args" : args}, env2]
  }
}

function interpret_call(f, params, env) {
  // console.log("INTERPRET_CALL")
  // console.log(f)
  // console.log(params)
  // console.log(env)
  var [func, env] = interpret(f, env);
  var func_args = func[0];
  var func_body = func[1];

  // console.log("func_args");
  // console.log(func_args);

  // console.log("func_body");
  // console.log(func_body);

  // construct environment 
  var old_current_var_values = JSON.parse(JSON.stringify(env.current_var_values));
  var env2 = env; // JSON.parse(JSON.stringify(env))
  if (isaexpr(func_args)) {
    for (let i = 0; i < func_args.args.length; i++) {
      var param_name = func_args.args[i];
      var [param_val, env2] = interpret(params[i], env2);
      env2.current_var_values[param_name] = param_val;
    }
  } else if (typeof(func_args) == "string") {
    var param_name = func_args; 
    [param_val, env2] = interpret(params[0], env2);
    env2.current_var_values[param_name] = param_val;
  } else {
    throw new Error(`Could not interpret ${func_args}`);
  }

  var [v, env2] = interpret(func_body, env2);

  // return value and original environment, except with state updated
  // env.objectsCreated = env2.state.objectsCreated;
  env.current_var_values = old_current_var_values;
  return [v, env];
}

function interpret_object_call(f, args, env) {
  // console.log("INTERPRET_OBJECT_CALL");
  // console.log(f);
  // console.log(JSON.stringify(args));
  // console.log(JSON.stringify(env));
  env.state.objectsCreated = env.state.objectsCreated + 1;

  var [origin, env] = interpret(args[args.length - 1], env);

  // console.log("ORIGIN");
  // console.log(origin);
  // object_repr = (origin=origin, type=f, alive=true, id=Œì.state.objectsCreated)

  var old_current_var_values = JSON.parse(JSON.stringify(env.current_var_values));
  var env2 = env;
  var fields = env2.state.object_types[f].fields;
  var field_values = {}
  for (let i = 0; i < fields.length; i++) {
    var field_name = fields[i].args[0];
    var [field_value, env2] = interpret(args[i], env2);
    field_values[field_name] = field_value;
    // object_repr = update(object_repr, field_name, field_value)
    env2.current_var_values[field_name] = field_value;

  }

  if (fields.length == 0) { 
    var object_repr = {"id" : env.state.objectsCreated, "origin" : origin, "type" : f, "alive" : true, "custom_fields" : field_values, "render" : null} ;
  } else {
    var [render, env2] = interpret(env.state.object_types[f].render, env2);
    var render = Array.isArray(render) ? render : [render];
    var object_repr = {"id" : env.state.objectsCreated, "origin" : origin, "type" : f, "alive" : true, "custom_fields" : field_values, "render" : render};
  }
  env.current_var_values = old_current_var_values;
  return [object_repr, env];
}

function interpret_init_next(var_name, var_val, env) {
  var init_func = var_val.args[0];
  var next_func = var_val.args[1];
  // console.log(JSON.stringify(env));
  var env2 = JSON.parse(JSON.stringify(env));
  if (!(var_name in env2.current_var_values)) { // variable not initialized; use init clause
    var [var_val, env2] = interpret(init_func, env2);

    // console.log("var_val");
    // console.log(var_val);

    env2.current_var_values[var_name] = var_val;

    env2.state.histories[var_name] = {};

    var [x, env2] = interpret({"head" : "assign", "args": ["prev" + var_name[0].toUpperCase() + var_name.slice(1), parseau(`(fn (state) (get (get (.. state histories) ${var_name} -1) (- (.. state time) 1) ${var_name}))`)]}, env2); 
  } else if (env.state.time > 0) { // variable initialized
    var [default_val, env] = interpret(next_func, env);
    env2.current_var_values[var_name] = default_val;
  }
  return [{"head" : "assign", "args" : [var_name, var_val]}, env2];
}

function interpret_object(args, env) {
  // console.log("INTERPRET_OBJECT");
  // console.log(JSON.stringify(args));
  // console.log(JSON.stringify(env));
  var object_name = args[0];
  var object_fields = args.slice(1,-1);
  var object_render = args[args.length - 1];

  if (object_fields.length == 0) {
    var [render, x] = interpret(object_render, env);
    if (!Array.isArray(render)) {
      var render = [render];
    }
    var object_tuple = ObjectType(render, object_fields);
  } else {
    var object_tuple = ObjectType(object_render, object_fields);
  }
  env.state.object_types[object_name] = object_tuple;
  return [{"head" : "object", "args" : args}, env];
}

function interpret_on(args, env) {
  var event = args[0]
  var update_ = args[1]

  // console.log("interpret_on");
  // console.log(event);
  // console.log(update_);
  // console.log(JSON.stringify(env));

  if (env.state.time > 0) {
    var [e, env] = interpret(event, env);
    
    if (e) {
      var [x, env] = interpret(update_, env);
    }
  }
  return [{"head" : "on", "args" : args}, env];
}

function interpret_updateObj(args, env) {
  // # # println("MADE IT!")
  // console.log("interpret_updateObj");
  // console.log(args);
  // console.log(env);
  var env2 = env //JSON.parse(JSON.stringify(env));
  var numFunctionArgs = args.map(arg => Array.isArray(arg) && (arg.length == 2) && (isaexpr(arg[0]) || typeof(arg[0]) == "string") && (isaexpr(arg[1]) || typeof(arg[1]) == "string")).filter(x => x == true).length;
  
  // console.log("numFunctionArgs");
  // console.log(numFunctionArgs);
  if (numFunctionArgs == 1) {
    var [list, env2] = interpret(args[0], env2);
    var map_func = args[1];

    // # # # # # @show list 
    // # # # # # @show map_func

    var new_list = []
    for (let item of list) { 
      // # # # # # # println("PRE=PLS WORK")
      // # # # # # # @showŒì2.state.objectsCreated      
      var [new_item, env2] = interpret({"head" : "call", "args" : [map_func, item]}, env2);
      // # # # # # # println("PLS WORK")
      // # # # # # # @showŒì2.state.objectsCreated
      new_list.push(new_item);
    }
    return [new_list, env2];
   } else if (numFunctionArgs == 2) {
    var [list, env2] = interpret(args[0], env2);
    var map_func = args[1];
    var filter_func = args[2];

    // # # @show list 
    // # # @show map_func

    // console.log("and i wanted you to know");
    // console.log("map_func");
    // console.log(map_func);
    // console.log("filter_func");
    // console.log(filter_func);

    var new_list = [];
    for (let item of list) { 
      var [pred, env2] = interpret({"head" : "call", "args" : [filter_func, item]}, env2);
      // console.log("pred woo");
      // console.log(pred);
      if (pred == true) { 
        // # # println("PRED TRUE!")
        // # # @show item 
        var [new_item, env2] = interpret({"head" : "call", "args" : [map_func, item]}, env2);
        new_list.push(new_item);
      } else {
        // # # println("PRED FALSE!")
        // # # @show item 
        new_list.push(item);
      }
    }
    // # # @show new_list 
    return [new_list, env2];
  } else if (numFunctionArgs == 0) {
    var obj = args[0];
    var field_string = JSON.stringify(args[1]).slice(8, -2);
    var new_value = args[2];

    // console.log(JSON.stringify(obj));
    // console.log("look me here");
    // console.log(field_string);
    // console.log(new_value);

    var new_obj = JSON.parse(JSON.stringify(obj)); // TODO
    new_obj.custom_fields[field_string] = new_value;

    // # update render
    var object_type = env.state.object_types[obj.type];
    
    var old_current_var_values = JSON.parse(JSON.stringify(env2.current_var_values));
    var env3 = env2; // JSON.parse(JSON.stringify(env2));
    var fields = object_type.fields;
    for (let i = 0; i < fields.length; i++) {
      var field_name = fields[i].args[0];
      var field_value = new_obj.custom_fields[field_name];
      env3.current_var_values[field_name] = field_value;
    }

    if (fields.length != 0) { 
      var [render, env3] = interpret(env.state.object_types[obj.type].render, env3);
      var render = Array.isArray(render) ? render : [render];
      new_obj["render"] = render;
    }
    env2.current_var_values = old_current_var_values;
    return [new_obj, env2];
    // # Œì2 = update(Œì2, :state, update(Œì2.state, :objectsCreated, Œì2.state.objectsCreated + 1))
  } else {
    throw new Error("Could not interpret updateObj");
  }
}

function interpret_removeObj(args, env) {
  // console.log("interpret_removeObj");
  // console.log(args);
  // console.log(JSON.stringify(env));
  var [list, env] = interpret(args[0], env);
  var func = args[1];
  var new_list = [];
  for (let item of list) {
    var [pred, env] = interpret({"head" : "call", "args" : [func, item]}, env);
    // console.log("pred");
    // console.log(pred);
    if (!pred) {
      new_list.push(item);
    } else {
      var new_item = update(item, "alive", false);
      new_list.push(new_item);
    }
  }
  return [new_list, env];
}

function interpret_js_map(args, env) {
  // console.log("INTERPRET_JS_MAP woo");
  // console.log(args);
  // console.log(env);
  var new_list = [];
  var map_func = args[0];
  var [list, env] = interpret(args[1], env);
  // console.log("orig list woo");
  // console.log(list);
  for (let arg of list) { 
    var [new_arg, env] = interpret({"head" : "call", "args" : [map_func, arg]}, env)
    new_list.push(new_arg);
  }
  // console.log("new_list");
  // console.log(new_list);
  return [new_list, env]
}

function interpret_js_filter(args, env) {
  // console.log("interpret_js_filter woo");
  // console.log(args);
  // console.log(env);
  var new_list = [];
  var filter_func = args[0];
  var [list, env] = interpret(args[1], env);
  // console.log("orig list");
  // console.log(list);
  for (let arg of list) {
    // console.log("arg");
    // console.log(arg);
    var [v, env] = interpret({"head" : "call", "args" : [filter_func, arg]}, env)
    // console.log("pred v");
    // console.log(v);
    if (v == true) { 
      new_list.push(arg);
    }
  }
  // console.log("new_list")
  // console.log(new_list);
  return [new_list, env];
}

function interpret_js_count(args, env) {
  var new_list = [];
  var filter_func = args[0];
  var [list, env] = interpret(args[1], env);
  for (let arg of list) {
    var [v, env] = interpret({"head" : "call", "args" : [filter_func, arg]}, env)
    if (v == true) { 
      new_list.push(interpret(arg, env)[0])
    }
  }
  return [new_list.length, env]
}


      // interpret.js

      // import { parseau } from "./sexpr.js"
// import { interpret, update } from "./interpretutils.js"
// import {renderScene } from "./autumnstdlib.js";

// const { parseau } = require("./sexpr.js");
// const { interpret, update } = require("./interpretutils.js");
// const { renderScene } = require("./autumnstdlib.js");

function interpret_program(aex, env) {
  if (aex.head != "program") {
    throw new Error("Must be a program aex");
  }

  for (let line of aex.args) {
    // console.log("YOOOOOOOOO")
    // console.log(line.head)
    // console.log(env);
    // console.log(JSON.stringify(env));
    var [_, env] = interpret(line, env);
  }
  return [aex, env]
}

function start(aex) {
  if (aex.head != "program") {
    throw new Error("Must be a program aex");
  }

  var env = {"left" : false, 
             "right" : false, 
             "up" : false, 
             "down" : false, 
             "left2" : false, 
             "right2" : false, 
             "up2" : false, 
             "down2" : false,

             "left3" : false, 
             "right3" : false, 
             "up3" : false, 
             "down3" : false,

             "left4" : false, 
             "right4" : false, 
             "up4" : false, 
             "down4" : false,

             "click" : null, 
             "current_var_values" : {},
             "lifted" : {},
             "on_clauses" : {}, 
             "state" : {"time" : 0, 
                        "objectsCreated" : 0, 
                        "scene" : {"objects" : [], 
                                   "background" : "white",
                                  },
                        "object_types" : {}, 
                        "histories" : {}, 
                      }
      }

  var lines = aex.args 

  var grid_params_and_object_type_lines = lines.filter(l => !(["assign", "on"].includes(l.head)))
  var initnext_lines = lines.filter(l => l.head == "assign" && (typeof(l.args[1]) == "object" && l.args[1].head == "initnext"))
  var lifted_lines = lines.filter(l => l.head == "assign" && (typeof(l.args[1]) != "object" || l.args[1].head != "initnext"))
  var on_clause_lines = lines.filter(l => l.head == "on")

  var reordered_lines = grid_params_and_object_type_lines.concat(initnext_lines).concat(on_clause_lines).concat(lifted_lines)

  for (let line of lifted_lines) {
    // console.log("HUHHHHHHHHHHHH")
    // console.log(line)
    var var_name = line.args[0] 
    // construct history variable in state
    env.state.histories[var_name] = {};

    // construct prev function 
    var [wtf, env_] = interpret({"head" : "assign", "args" : ["prev" + var_name[0].toUpperCase() + var_name.slice(1), parseau(`(fn () (get (.. (.. state histories) ${var_name}) (- (.. state time) 1) ${var_name}))`)]}, env); 
    var env = env_;
  }

  // add background to scene 
  var background_assignments = lifted_lines.filter(l => l.args[0] == "background")
  var background = background_assignments.length != 0 ? background_assignments[background_assignments.length - 1].args[1] : "#ffffff00"
  env.state.scene.background = background

  // initialize lifted variables
  // env = update(env, :lifted, empty_env()) 
  for (let line of lifted_lines) {
    var var_name = line.args[0]
    env.lifted[var_name] = line.args[1] 
    if (["GRID_SIZE", "background"].includes(var_name)) {
      env.current_var_values[var_name] = interpret(line.args[1], env)[0]
    } 
  }

  var new_aex = {"head" : "program", "args" : reordered_lines} // try interpreting the init_next's before on for the first time step (init)
  var [aex_, env_] = interpret_program(new_aex, env)

  // update state (time, histories, scene)
  var env_ = update_state(env_)

  return [aex_, env_]
}

function step(aex, env, user_events=null) {
  // console.log("STEP");
  // update env with user event 
  if (user_events != null) {
    for (let user_event in user_events) {
      if (user_events[user_event] != null) {
        env[user_event] = user_events[user_event];
      }
    }
  }

  var [aex_, env_] = interpret_program(aex, env)

  // update state (time, histories, scene) + reset user_event
  var env_ = update_state(env_)
  
  return env_
}

function update_state(env_) {
  // reset user events 
  for (let user_event of ["left", "right", "up", "down", "left2", "right2", "up2", "down2", "left3", "right3", "up3", "down3", "left4", "right4", "up4", "down4"]) {
    env_[user_event] = false;
  }
  env_["click"] = null;

  // add updated variable values to history
  for (key in env_.state.histories) {
    var val = env_.current_var_values[key];
    if (Array.isArray(val)) { 
      if (val.length > 0 && val[0].id != undefined) {
        val = env_.current_var_values[key].filter(obj => obj.alive);
      }
    }   
    env_.state.histories[key][env_.state.time] = JSON.parse(JSON.stringify(val))
  
    // delete earlier times stored in history, since we only use prev up to 1 level back
    if (env_.state.time > 0) {
      delete env_.state.histories[key][(env_.state.time - 1).toString()];
    }

  }

  // update lifted variables 
  for (var_name in env_.lifted) {
    env_.current_var_values[var_name] = interpret(env_.lifted[var_name], env_)[0]
  }

  // update scene.objects 
  var new_scene_objects = []
  for (key in env_.current_var_values) {
    if (typeof(env_.current_var_values[key]) == "object" && env_.current_var_values[key].id != undefined || (Array.isArray(env_.current_var_values[key]) && ((env_.current_var_values[key].length) > 0) && typeof(env_.current_var_values[key][0]) == "object" && env_.current_var_values[key][0].id != undefined)) {
      var object_val = env_.current_var_values[key]
      if (Array.isArray(object_val)) { 
        new_scene_objects.push(...object_val)
      } else {
        new_scene_objects.push(object_val)
      }
    }
  }
  
  env_.state.scene.objects = new_scene_objects

  // update time 
  env_.state.time = env_.state.time + 1;
  return env_
}

function interpret_over_time(aex, iters, user_events=[]) {
  var [new_aex, env_] = start(aex);
  if (user_events.length == 0) {
    for (let i = 0; i < iters; i++) {
      // @show i
      // console.log("i am here");
      // console.log(i);
      // console.log(iters);
      env_ = step(new_aex, env_);
    }
  } else {
    for (let i = 0; i < iters; i++) {
      // @show i
      // console.log("i");
      // console.log(i);
      var env_ = step(new_aex, env_, user_events[i]);
    }
  }
  return env_;
}

function interpret_over_time_variable(aex, var_name, iters, user_events=[]) {

}

function interpret_over_time_observations(aex, iters, user_events=[]) {
  var scenes = [];
  var [new_aex, env_] = start(aex);
  scenes.push(renderScene([env_.state.scene], env_.state));
  if (user_events.length == 0) {
    for (let i = 0; i < iters; i++) {
      // # # @show i
      env_ = step(new_aex, env_);
      scenes.push(renderScene([env_.state.scene], env_.state));
    }
  } else {
    for (let i = 0; i < iters; i++) {
      // # # @show i
      env_ = step(new_aex, env_, user_events[i])
      scenes.push(renderScene([env_.state.scene], env_.state))
    }
  }
  return scenes;
}

// TODO: check null usage/equality checks, check 1-index vs. 0-index, etc.


// tests (TODO: move to test folder)
function test_particle() {
  var program_str = `(program
                       (= GRID_SIZE 16)
                       (object Particle (Cell 0 0 "blue"))
                       (: particle Particle)
                       (= particle (initnext (Particle (Position 8 8)) (moveLeft (prev particle))))
                       (on right (= particle (moveRight (prev particle))))
                     )`
  var aex = parseau(program_str);

  var [aex_, env_] = start(aex);

  for (let i = 0; i < 5; i++) {
    if (i % 3 == 1) {
      var user_event = {"left" : false, "right" : true, "up" : false, "down" : false, "click" : null}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null}
    }
    // // console.log(i);
    env_ = step(aex_, env_, user_event);
  }
  // // console.log(env_.state.histories.particle);
  return env_;
  return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => env_.state.histories.particle[i].origin);
}

function test_particle_list() {
  var program_str = `(program
                       (= GRID_SIZE 16)
                       (object Particle (Cell 0 0 "blue"))
                       (: particles (List Particle))
                       (= particles (initnext (list (Particle (Position 8 8)) (Particle (Position 10 10))) (updateObj (prev particles) (--> obj (moveLeft obj)))))
                       (on right (let ((= particles (updateObj (prev particles) (--> obj (moveRight obj)))))))
                     )`
  var aex = parseau(program_str);

  var [aex_, env_] = start(aex);

  for (let i = 0; i < 5; i++) {
    if (i % 3 == 1) {
      var user_event = {"left" : false, "right" : true, "up" : false, "down" : false, "click" : null}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null}
    }
    // // console.log(i);
    env_ = step(aex_, env_, user_event);
  }
  // // console.log(env_.state.histories.particle);
  return env_;
  // return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => [env_.state.histories.particles[i][0].origin, env_.state.histories.particles[i][1].origin]);
}

function test_particle_actual() {
  var program_str = `(program
                      (= GRID_SIZE 16)
                      
                      (object Particle (Cell 0 0 "blue"))
                      
                      (: particles (List Particle))
                      (= particles 
                        (initnext (list) 
                                  (updateObj (prev particles) (--> obj (uniformChoice (list (moveLeft obj) (moveRight obj) (moveDown obj) (moveUp obj)) )))))¬†
                      
                      (on clicked (= particles (addObj particles (Particle (Position (.. click x) (.. click y))))))
                      )`
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);

  var user_events = [];
  for (let i = 0; i < 5; i++) {
    if (i % 3 == 1) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null}
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var env_ = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return env_;
  // return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => [env_.state.histories.particles[i].map(o => [o.origin.x, o.origin.y])]);
}

function test_ants_actual() {
  var program_str = `(program
                      (= GRID_SIZE 16)
                      
                      (object Ant (Cell 0 0 "gray"))
                      (object Food (Cell 0 0 "red"))
                      
                      (: ants (List Ant))
                      (= ants (initnext (list (Ant (Position 5 5)) (Ant (Position 1 14))) (prev ants)))
                      
                      (: foods (List Food))
                      (= foods (initnext (list) (prev foods)))
                      
                      (on true (= ants (updateObj (prev ants) (--> obj (move obj (unitVector obj (closest obj Food)))))))
                      (on true (= foods (updateObj (prev foods) (--> obj (if (intersects obj (prev ants))
¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†                                             then (removeObj obj)
¬†¬†¬†¬†  ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†                               else obj)))))

                      (on clicked (= foods (addObj foods (map Food (randomPositions GRID_SIZE 2)))))

                      )`
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);

  var user_events = [];
  for (let i = 0; i < 3; i++) {
    if (i == 1) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null}
    }
    // // console.log(i);
    user_events.push(user_event);
    // env_ = step(aex_, env_, user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
  // return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => [env_.state.histories.particles[i].map(o => [o.origin.x, o.origin.y])]);
}

function test_lights_actual() {
  var program_str = `(program
                      (= GRID_SIZE 10)
                      
                      (object Light (: on Bool) (Cell 0 0 (if on then "yellow" else "white")))
                      
                      (: lights (List Light))
                      (= lights (initnext (map (--> pos (Light false pos)) (filter (--> pos (== (.. pos x) (.. pos y))) (allPositions GRID_SIZE))) 
                                          (prev lights)))
                      
                      (on clicked (= lights (updateObj lights (--> obj (updateObj obj "on" (! (.. obj on)))))))

                      )`
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);

  var user_events = [];
  for (let i = 0; i < 5; i++) {
    if (i % 3 == 1) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null}
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
// return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => [env_.state.histories.particles[i].map(o => [o.origin.x, o.origin.y])]);
}

function test_paint_actual() {
  var program_str = `(program
    (= GRID_SIZE 16)
    
    (object Particle (: color String) (Cell 0 0 color))
    
    (: particles (List Particle))
    (= particles (initnext (list) (prev particles)))
    
    (: currColor String)
    (= currColor (initnext "red" (prev currColor)))
    
    (on clicked (= particles (addObj (prev particles) (Particle currColor (Position (.. click x) (.. click y))))))
    (on (& up (== (prev currColor) "red")) (= currColor "gold"))
    (on (& up (== (prev currColor) "gold")) (= currColor "green"))
    (on (& up (== (prev currColor) "green")) (= currColor "blue"))
    (on (& up (== (prev currColor) "blue")) (= currColor "purple"))
    (on (& up (== (prev currColor) "purple")) (= currColor "red"))
    )`
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);

  var user_events = [];
  for (let i = 0; i < 5; i++) {
    if (i % 3 == 1) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}}
    } else {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : null}
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
// return [`0`, `1`, `2`, `3`, `4`, `5`].map(i => [env_.state.histories.particles[i].map(o => [o.origin.x, o.origin.y])]);
}

function test_gravity_actual() {
  var program_str = `(program
    (= GRID_SIZE 16)
      
    (object Button (: color String) (Cell 0 0 color))
    (object Blob (list (Cell 0 -1 "blue") (Cell 0 0 "blue") (Cell 1 -1 "blue") (Cell 1 0 "blue")))
    
    (: leftButton Button)
    (= leftButton (initnext (Button "red" (Position 0 7)) (prev leftButton)))
    
    (: rightButton Button)
    (= rightButton (initnext (Button "darkorange" (Position 15 7)) (prev rightButton)))
      
    (: upButton Button)
    (= upButton (initnext (Button "gold" (Position 7 0)) (prev upButton)))
    
    (: downButton Button)
    (= downButton (initnext (Button "green" (Position 7 15)) (prev downButton)))
    
    (: blobs (List Blob))
    (= blobs (initnext (list) (prev blobs)))
    
    (: gravity String)
    (= gravity (initnext "down" (prev gravity)))
    
    (on (== gravity "left") (= blobs (updateObj blobs (--> obj (moveLeft obj)))))
    (on (== gravity "right") (= blobs (updateObj blobs (--> obj (moveRight obj)))))
    (on (== gravity "up") (= blobs (updateObj blobs (--> obj (moveUp obj)))))
    (on (== gravity "down") (= blobs (updateObj blobs (--> obj (moveDown obj)))))
    
    (on (& clicked (isFree click)) (= blobs (addObj blobs (Blob (Position (.. click x) (.. click y))))) )
    
    (on (clicked leftButton) (= gravity "left"))
    
    (on (clicked rightButton) (= gravity "right"))
    
    (on (clicked upButton) (= gravity "up"))
    
    (on (clicked downButton) (= gravity "down"))
    )`
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);
  
  var user_events = [];
  for (let i = 0; i < 20; i++) {
    if (i % 4 == 2) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : 0, "y" : 7}};
    } else if (i % 4 == 0) {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : {"x" : 15, "y" : 7}};
    } else {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}};
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
}

function test_ice_actual() {
  var program_str = `(program
    (= GRID_SIZE 8)
    (object CelestialBody (: day Bool) (list (Cell 0 0 (if day then "gold" else "gray"))
                                            (Cell 0 1 (if day then "gold" else "gray"))
                                            (Cell 1 0 (if day then "gold" else "gray"))
                                            (Cell 1 1 (if day then "gold" else "gray"))))
    (object Cloud (list (Cell -1 0 "gray")
                        (Cell 0 0 "gray")
                        (Cell 1 0 "gray")))
    
    (object Water (: liquid Bool) (Cell 0 0 (if liquid then "blue" else "lightblue")))
    
    (: celestialBody CelestialBody)
    (= celestialBody (initnext (CelestialBody true (Position 0 0)) (prev celestialBody)))
    
    (: cloud Cloud)
    (= cloud (initnext (Cloud (Position 4 0)) (prev cloud)))
    
    (: water (List Water))
    (= water (initnext (list) (updateObj (prev water) nextWater)))
    
    (on left (= cloud (nextCloud cloud (Position -1 0))))
    (on right (= cloud (nextCloud cloud (Position 1 0))))
    (on down (= water (addObj water (Water (.. celestialBody day) (move (.. cloud origin) (Position 0 1))))))
    (on clicked (let ((= celestialBody (updateObj celestialBody "day" (! (.. celestialBody day)))) (= water (updateObj water (--> drop (updateObj drop "liquid" (! (.. drop liquid)))))))))
    
    (= nextWater (fn (drop) 
                    (if (.. drop liquid)
                      then (nextLiquid drop)
                      else (nextSolid drop))))
    
    (= nextCloud (fn (cloud position)
                    (if (isWithinBounds (move cloud position)) 
                      then (move cloud position)
                      else cloud)))
    )
    `
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);
  
  var user_events = [];
  for (let i = 0; i < 4; i++) {
    if (i % 4 == 2) {
      var user_event = {"left" : true, "right" : false, "up" : false, "down" : false, "click" : null};
    } else if (i % 4 == 0) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : true, "click" : null};
    } else {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : {"x" : 4, "y" : 4}};
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
  // return env_;
}

function test_water_plug_actual() {
  var program_str = `(program
    (= GRID_SIZE 16)
    
    (object Button (: color String) (Cell 0 0 color))
    (object Vessel (Cell 0 0 "purple"))
    (object Plug (Cell 0 0 "orange"))
    (object Water (Cell 0 0 "blue"))
    
    (: vesselButton Button)
    (= vesselButton (Button "purple" (Position 2 0)))
    (: plugButton Button)
    (= plugButton (Button "orange" (Position 5 0)))
    (: waterButton Button)
    (= waterButton (Button "blue" (Position 8 0)))
    (: removeButton Button)
    (= removeButton (Button "black" (Position 11 0)))
    (: clearButton Button)
    (= clearButton (Button "red" (Position 14 0)))
    
    (: vessels (List Vessel))
    (= vessels (initnext (list (Vessel (Position 6 15)) (Vessel (Position 6 14)) (Vessel (Position 6 13)) (Vessel (Position 5 12)) (Vessel (Position 4 11)) (Vessel (Position 3 10)) (Vessel (Position 9 15)) (Vessel (Position 9 14)) (Vessel (Position 9 13)) (Vessel (Position 10 12)) (Vessel (Position 11 11)) (Vessel (Position 12 10))) (prev vessels)))
    (: plugs (List Plug))
    (= plugs (initnext (list (Plug (Position 7 15)) (Plug (Position 8 15)) (Plug (Position 7 14)) (Plug (Position 8 14)) (Plug (Position 7 13)) (Plug (Position 8 13))) (prev plugs)))
    (: water (List Water))
    (= water (initnext (list) (prev water)))
    
    (= currentParticle (initnext "vessel" (prev currentParticle)))
    
    (on true (= water (updateObj (prev water) (--> obj (nextLiquid obj)))))
    (on (& clicked (& (isFree click) (== currentParticle "vessel"))) (= vessels (addObj vessels (Vessel (Position (.. click x) (.. click y))))))
    (on (& clicked (& (isFree click) (== currentParticle "plug"))) (= plugs (addObj plugs (Plug (Position (.. click x) (.. click y))))))
    (on (& clicked (& (isFree click) (== currentParticle "water"))) (= water (addObj water (Water (Position (.. click x) (.. click y))))))
    (on (clicked vesselButton) (= currentParticle "vessel"))
    (on (clicked plugButton) (= currentParticle "plug"))
    (on (clicked waterButton) (= currentParticle "water"))
    (on (clicked removeButton) (= plugs (removeObj plugs (--> obj true))))
    (on (clicked clearButton) (let ((= vessels (removeObj vessels (--> obj true))) (= plugs (removeObj plugs (--> obj true))) (= water (removeObj water (--> obj true))))))  
    )
        `
  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);
  
  var user_events = [];
  for (let i = 0; i < 10; i++) {
    if (i % 4 == 2) {
      var user_event = {"left" : true, "right" : false, "up" : false, "down" : false, "click" : {"x" : 8, "y" : 0}};
    } else if (i % 4 == 0) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : true, "click" : {"x" : 5, "y" : 0}};
    } else {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : {"x" : Math.floor(15 * Math.random()), "y" : Math.floor(15 * Math.random())}};
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
  // return env_;
}

function test_disease_actual() {
  var program_str = `(program
    (= GRID_SIZE 8)
    
    (object Particle (: health Bool) (Cell 0 0 (if health then "gray" else "darkgreen")))
    
    (: inactiveParticles (List Particle))
    (= inactiveParticles (initnext (list (Particle true (Position 5 3)) (Particle true (Position 2 1)) (Particle true (Position 4 4)) (Particle true (Position 1 3)) )  
                        (updateObj (prev inactiveParticles) (--> obj (if true
                                                                      then (updateObj obj "health" false)
                                                                      else obj)) 
                                                            (--> obj (adj (prev obj) (filter (--> obj (! (.. (prev obj) health))) (vcat (list (prev activeParticle)) (prev inactiveParticles))) 1)))))   
    
    (: activeParticle Particle)
    (= activeParticle (initnext (Particle false (Position 0 0)) (prev activeParticle)))¬†
    
    (on (!= (length (filter (--> obj (! (.. obj health))) (adjacentObjs activeParticle 1))) 0) (= activeParticle (updateObj (prev activeParticle) "health" false)))
    (on (clicked (prev inactiveParticles)) 
        (let ((= inactiveParticles (addObj (prev inactiveParticles) (prev activeParticle))) 
              (= activeParticle (objClicked click (prev inactiveParticles)))
              (= inactiveParticles (removeObj inactiveParticles (objClicked click (prev inactiveParticles))))
            )))
    (on left (= activeParticle (move (prev activeParticle) -1 0)))
    (on right (= activeParticle (move (prev activeParticle) 1 0)))
    (on up (= activeParticle (move (prev activeParticle) 0 -1)))
    (on down (= activeParticle (move (prev activeParticle) 0 1))))`;

  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);
  
  var user_events = []; // down, click new thing at (5, 3), left 
  for (let i = 0; i < 4; i++) {
    if (i % 4 == 2) {
      var user_event = {"left" : true, "right" : false, "up" : false, "down" : false, "click" : null};
    } else if (i % 4 == 0) {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : true, "click" : null};
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : {"x" : 2, "y" : 1}};
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
  // return env_;
}

function test_space_invaders_actual() {
  var program_str = `(program
    (= GRID_SIZE 16)
    
    (object Enemy (Cell 0 0 "blue"))
    (object Hero (Cell 0 0 "black"))
    (object Bullet (Cell 0 0 "red"))
    (object EnemyBullet (Cell 0 0 "orange"))
    
    (: enemies1 (List Enemy))
    (= enemies1 (initnext (map 
                            (--> pos (Enemy pos)) 
                            (filter (--> pos (& (== (.. pos y) 1) (== (% (.. pos x) 3) 1))) (allPositions GRID_SIZE)))
                          (prev enemies1)))
    
    (: enemies2 (List Enemy))
    (= enemies2 (initnext (map 
                            (--> pos (Enemy pos)) 
                            (filter (--> pos (& (== (.. pos y) 3) (== (% (.. pos x) 3) 2))) (allPositions GRID_SIZE)))
                          (prev enemies2)))
    
    
    (: hero Hero)
    (= hero (initnext (Hero (Position 8 15)) (prev hero)))
    
    (: enemyBullets (List EnemyBullet))
    (= enemyBullets (initnext (list) (prev enemyBullets)))
    
    (: bullets (List Bullet))
    (= bullets (initnext (list) (prev bullets)))
    
    (: time Int)
    (= time (initnext 0 (+ (prev time) 1)))                                                         
    
    (on true (= enemyBullets (updateObj enemyBullets (--> obj (moveDown obj)))))
    (on true (= bullets (updateObj bullets (--> obj (moveUp obj)))))
    (on left (= hero (moveLeftNoCollision (prev hero))))
    (on right (= hero (moveRightNoCollision (prev hero))))
    (on (& up (.. (prev hero) alive)) (= bullets (addObj bullets (Bullet (.. (prev hero) origin)))))  
    
    (on (== (% time 10) 5) (= enemies1 (updateObj enemies1 (--> obj (moveLeft obj)))))
    (on (== (% time 10) 0) (= enemies1 (updateObj enemies1 (--> obj (moveRight obj)))))
    
    (on (== (% time 10) 5) (= enemies2 (updateObj enemies2 (--> obj (moveRight obj)))))
    (on (== (% time 10) 0) (= enemies2 (updateObj enemies2 (--> obj (moveLeft obj)))))
    
    (on (intersects (prev bullets) (prev enemies1))
      (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies1)))))
            (= enemies1 (removeObj enemies1 (--> obj (intersects (prev obj) (prev bullets)))))))
    )          
            
    (on (intersects (prev bullets) (prev enemies2))
      (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies2)))))
            (= enemies2 (removeObj enemies2 (--> obj (intersects (prev obj) (prev bullets)))))))
    )
            
    (on (== (% time 5) 2) (= enemyBullets (addObj enemyBullets (EnemyBullet (uniformChoice (map (--> obj (.. obj origin)) (vcat (prev enemies1) (prev enemies2))))))))         
    (on (intersects (prev hero) (prev enemyBullets)) (= hero (removeObj (prev hero))))
    
    (on (intersects (prev bullets) (prev enemyBullets)) 
      (let 
        ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemyBullets))))) 
          (= enemyBullets (removeObj enemyBullets (--> obj (intersects (prev obj) (prev bullets))))))))           
    )`;

  var aex = parseau(program_str);

  // var [aex_, env_] = start(aex);
  
  var user_events = []; // down, click new thing at (5, 3), left 
  for (let i = 0; i < 15; i++) {
    if (i % 4 == 2) {
      var user_event = {"left" : true, "right" : false, "up" : false, "down" : false, "click" : null};
    } else if (i % 4 == 0) {
      var user_event = {"left" : false, "right" : false, "up" : true, "down" : false, "click" : null};
    } else {
      var user_event = {"left" : false, "right" : false, "up" : false, "down" : false, "click" : null};
    }
    // // console.log(i);
    // env_ = step(aex_, env_, user_event);
    user_events.push(user_event);
  }
  var observations = interpret_over_time_observations(aex, user_events.length, user_events);
  // // console.log(env_.state.histories.particle);
  return observations;
  // return env_;
}

/*

(program
(= GRID_SIZE 16)

(object Enemy (Cell 0 0 "blue"))
(object Hero (Cell 0 0 "black"))
(object Bullet (Cell 0 0 "red"))
(object EnemyBullet (Cell 0 0 "orange"))

(: enemies1 (List Enemy))
(= enemies1 (initnext (map 
                        (--> pos (Enemy pos)) 
                        (filter (--> pos (& (== (.. pos y) 1) (== (% (.. pos x) 3) 1))) (allPositions GRID_SIZE)))
                      (prev enemies1)))

(: enemies2 (List Enemy))
(= enemies2 (initnext (map 
                        (--> pos (Enemy pos)) 
                        (filter (--> pos (& (== (.. pos y) 3) (== (% (.. pos x) 3) 2))) (allPositions GRID_SIZE)))
                      (prev enemies2)))


(: hero Hero)
(= hero (initnext (Hero (Position 8 15)) (prev hero)))

(: enemyBullets (List EnemyBullet))
(= enemyBullets (initnext (list) (prev enemyBullets)))

(: bullets (List Bullet))
(= bullets (initnext (list) (prev bullets)))

(: time Int)
(= time (initnext 0 (+ (prev time) 1)))                                                         

(on true (= enemyBullets (updateObj enemyBullets (--> obj (moveDown obj)))))
(on true (= bullets (updateObj bullets (--> obj (moveUp obj)))))
(on left (= hero (moveLeftNoCollision (prev hero))))
(on right (= hero (moveRightNoCollision (prev hero))))
(on (& up (.. (prev hero) alive)) (= bullets (addObj bullets (Bullet (.. (prev hero) origin)))))  

(on (== (% time 10) 5) (= enemies1 (updateObj enemies1 (--> obj (moveLeft obj)))))
(on (== (% time 10) 0) (= enemies1 (updateObj enemies1 (--> obj (moveRight obj)))))

(on (== (% time 10) 5) (= enemies2 (updateObj enemies2 (--> obj (moveRight obj)))))
(on (== (% time 10) 0) (= enemies2 (updateObj enemies2 (--> obj (moveLeft obj)))))

(on (intersects (prev bullets) (prev enemies1))
  (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies1)))))
        (= enemies1 (removeObj enemies1 (--> obj (intersects (prev obj) (prev bullets)))))))
)          
        
(on (intersects (prev bullets) (prev enemies2))
  (let ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemies2)))))
        (= enemies2 (removeObj enemies2 (--> obj (intersects (prev obj) (prev bullets)))))))
)
        
(on (== (% time 5) 2) (= enemyBullets (addObj enemyBullets (EnemyBullet (uniformChoice (map (--> obj (.. obj origin)) (vcat (prev enemies1) (prev enemies2))))))))         
(on (intersects (prev hero) (prev enemyBullets)) (= hero (removeObj (prev hero))))

(on (intersects (prev bullets) (prev enemyBullets)) 
  (let 
    ((= bullets (removeObj bullets (--> obj (intersects (prev obj) (prev enemyBullets))))) 
      (= enemyBullets (removeObj enemyBullets (--> obj (intersects (prev obj) (prev bullets))))))))           
)
)

*/

        }
        )
      </script>
    </div>
    
  </body>
</html>